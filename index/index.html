<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Infinity Loop Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="description" content="Interactive reader for The Infinity Loop - Mapping the Machinery of Power, Policy, and Profit">
  <meta name="author" content="The Infinity Loop">
  
  <style>
    /* ========== CSS VARIABLES ========== */
    :root {
      --bg: #050608;
      --bg-elevated: #10131a;
      --text: #f4f5f7;
      --muted: #9ca3af;
      --border: #1f2933;
      --nav-width: 280px;
      --accent: #e63946;
      --accent-soft: rgba(230, 57, 70, 0.18);
      --accent-warm: #f59e0b;
      --accent-warm-soft: rgba(245, 158, 11, 0.16);
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-strong: 0 25px 50px rgba(0, 0, 0, 0.8);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ========== BASE STYLES ========== */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #111827 0%, #020308 55%, #000000 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none;
    }

    /* ========== ENHANCED SPLASH SCREEN ========== */
    .splash-entrance {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0e1a 0%, #000000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out;
    }

    .splash-entrance::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(230, 57, 70, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
      animation: pulseBackground 4s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes pulseBackground {
      0% { opacity: 0.3; }
      100% { opacity: 0.7; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ==== SPLASH CARD WITH 75% COVER ==== */
    .splash-card {
      width: min(90vw, 800px);
      height: 75vh; /* 75% of viewport height */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      position: relative;
      animation: cardAppear 0.8s ease-out 0.3s both;
    }

    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ==== 3D FLOATING COVER CONTAINER ==== */
    .cover-3d-container {
      position: relative;
      width: 100%;
      height: 75%; /* Takes 75% of the card height */
      perspective: 1800px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
    }

    .book-cover-3d {
      width: auto;
      height: 100%;
      max-width: 90%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 16px;
      box-shadow: 
        var(--shadow-strong),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        0 0 120px rgba(230, 57, 70, 0.4);
      transform: rotateY(-15deg) rotateX(5deg) translateZ(0);
      transition: var(--transition);
      cursor: pointer;
      animation: float3D 6s ease-in-out infinite;
      position: relative;
      z-index: 2;
    }

    @keyframes float3D {
      0%, 100% { 
        transform: rotateY(-15deg) rotateX(5deg) translateY(0px); 
      }
      50% { 
        transform: rotateY(-15deg) rotateX(5deg) translateY(-25px); 
      }
    }

    .book-cover-3d:hover {
      transform: rotateY(-10deg) rotateX(3deg) translateY(-10px) scale(1.03);
      box-shadow: 
        0 50px 100px rgba(0, 0, 0, 1),
        0 0 0 1px rgba(255, 255, 255, 0.08),
        0 0 200px rgba(230, 57, 70, 0.6);
    }

    /* ==== PULSATING NEON CIRCLE ==== */
    .neon-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 110%;
      height: 110%;
      border-radius: 30px;
      background: radial-gradient(
        circle at center,
        transparent 0%,
        transparent 60%,
        rgba(230, 57, 70, 0.15) 80%,
        rgba(230, 57, 70, 0.4) 100%
      );
      z-index: 1;
      animation: neonPulse 3s ease-in-out infinite;
      filter: blur(8px);
    }

    .neon-circle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 30px;
      border: 3px solid var(--accent);
      box-shadow: 
        0 0 30px var(--accent),
        0 0 60px var(--accent),
        inset 0 0 30px rgba(230, 57, 70, 0.3);
      animation: neonGlow 2s ease-in-out infinite alternate;
      opacity: 0.7;
    }

    @keyframes neonPulse {
      0%, 100% { 
        opacity: 0.3;
        transform: translate(-50%, -50%) scale(0.95);
      }
      50% { 
        opacity: 0.6;
        transform: translate(-50%, -50%) scale(1.05);
      }
    }

    @keyframes neonGlow {
      0% { 
        box-shadow: 
          0 0 20px var(--accent),
          0 0 40px var(--accent),
          inset 0 0 20px rgba(230, 57, 70, 0.3);
      }
      100% { 
        box-shadow: 
          0 0 40px var(--accent),
          0 0 80px var(--accent),
          inset 0 0 40px rgba(230, 57, 70, 0.5);
      }
    }

    /* ==== TITLE AND BUTTON SECTION (BELOW COVER) ==== */
    .splash-content {
      width: 100%;
      text-align: center;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 3;
    }

    .splash-title {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      margin: 0;
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.1;
      text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.5s ease-out 0.5s both;
    }

    .splash-subtitle {
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      color: rgba(255, 255, 255, 0.8);
      margin: 0;
      font-weight: 300;
      letter-spacing: 0.05em;
      max-width: 500px;
      line-height: 1.4;
      animation: slideUp 0.5s ease-out 0.6s both;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .splash-tagline {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin: 0;
      animation: fadeIn 0.8s ease-out 0.7s both;
    }

    /* ==== ENTER BUTTON ==== */
    .splash-button {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 9999px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 
        0 10px 30px rgba(230, 57, 70, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 54px;
      margin-top: 10px;
      animation: slideUp 0.5s ease-out 0.8s both;
      position: relative;
      overflow: hidden;
    }

    .splash-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .splash-button:hover {
      transform: translateY(-5px);
      box-shadow: 
        0 20px 40px rgba(230, 57, 70, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .splash-button:hover::before {
      left: 100%;
    }

    .splash-button:active {
      transform: translateY(-2px);
    }

    .splash-button span {
      font-size: 1.2rem;
      transition: transform 0.2s ease;
    }

    .splash-button:hover span {
      transform: translateX(5px);
    }

    /* ==== SMALLER SCREENS ==== */
    @media (max-width: 768px) {
      .splash-card {
        height: 85vh;
        width: 95vw;
      }
      
      .cover-3d-container {
        height: 70%;
      }
      
      .book-cover-3d {
        max-width: 95%;
      }
      
      .splash-title {
        font-size: 2rem;
      }
      
      .splash-subtitle {
        font-size: 0.9rem;
        padding: 0 20px;
      }
      
      .splash-button {
        padding: 14px 30px;
        font-size: 1rem;
      }
    }

    @media (max-width: 480px) {
      .splash-card {
        height: 90vh;
      }
      
      .cover-3d-container {
        height: 65%;
      }
      
      .splash-title {
        font-size: 1.6rem;
      }
      
      .splash-subtitle {
        font-size: 0.85rem;
      }
      
      .splash-button {
        padding: 12px 24px;
        font-size: 0.95rem;
      }
      
      .neon-circle {
        width: 115%;
        height: 115%;
      }
    }

    /* ========== MODALS ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      backdrop-filter: blur(10px);
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        backdrop-filter: blur(0px);
      }
      to {
        opacity: 1;
        backdrop-filter: blur(10px);
      }
    }

    .modal-content {
      background: linear-gradient(135deg, #111827 0%, #020308 100%);
      border-radius: 24px;
      padding: clamp(20px, 5vw, 40px);
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--accent);
      box-shadow: 0 20px 60px rgba(230, 57, 70, 0.3);
      text-align: center;
      animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-content h2 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: clamp(1.5rem, 4vw, 28px);
      font-weight: 700;
    }

    .modal-content p {
      color: var(--muted);
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .email-input,
    .license-input {
      width: 100%;
      padding: 15px 20px;
      background: rgba(31, 41, 55, 0.8);
      border: 2px solid var(--accent);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
      transition: var(--transition);
    }

    .email-input:focus,
    .license-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.3);
    }

    .license-input {
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      min-height: 48px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4);
    }

    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
      padding: 10px 25px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      min-height: 48px;
      min-width: 150px;
      transition: var(--transition);
    }

    .btn-secondary:hover {
      background: var(--accent-soft);
      transform: translateY(-2px);
    }

    .license-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* ========== LOADING OVERLAY ========== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Hide the main app initially */
    .app-shell {
      display: none;
    }
  </style>
</head>
<body>

  <!-- ========== ENHANCED SPLASH SCREEN ========== -->
  <div class="splash-entrance" id="splashEntrance">
    <div class="splash-card">
      <div class="cover-3d-container">
        <!-- Pulsating Neon Circle -->
        <div class="neon-circle"></div>
        
        <!-- 3D Floating Book Cover -->
        <img src="Front Cover.png" 
             alt="The Infinity Loop - Book Cover" 
             class="book-cover-3d" 
             id="bookCover">
      </div>
      
      <div class="splash-content">
        <h1 class="splash-title">The Infinity Loop</h1>
        <p class="splash-subtitle">Mapping the Machinery of Power, Policy, and Profit</p>
        <div class="splash-tagline">Enter the Loop â€¢ Discover the System</div>
        
        <button class="splash-button" id="enterBookBtn">
          Open The Infinity Loop
          <span>â†’</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ========== EMAIL MODAL ========== -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal-content">
      <h2>Start Your Free Trial</h2>
      <p>Enter your email address to access the first 2 chapters of The Infinity Loop for 7 days.</p>
      <p style="font-size: 14px; color: var(--muted);">No credit card required. Full version available with license.</p>
      
      <div class="email-input-group">
        <input type="email" 
               class="email-input" 
               id="trialEmail"
               placeholder="your@email.com"
               autocomplete="email"
               required>
        <div style="display: flex; align-items: flex-start; gap: 10px; margin-top: 15px;">
          <input type="checkbox" 
                 id="agreeTerms" 
                 style="width: auto; margin-top: 3px;">
          <label for="agreeTerms" style="font-size: 12px; text-align: left; color: var(--muted); line-height: 1.4;">
            I agree to receive updates and accept the 
            <a href="#" style="color: var(--accent); text-decoration: underline;" id="termsLink">Terms of Service</a>
          </label>
        </div>
      </div>
      
      <button class="btn-primary" id="startTrialWithEmail">
        Start Free Trial (2 Chapters)
      </button>
      
      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        Already have a license? 
        <a href="#" id="switchToLicense" style="color: var(--accent); text-decoration: underline;">Activate here</a>
      </p>
    </div>
  </div>

  <!-- ========== LICENSE MODAL ========== -->
  <div class="modal-overlay" id="licenseModal">
    <div class="modal-content">
      <h2>Activate Full Version</h2>
      <p>Enter your license key to unlock all 11 chapters.</p>
      
      <input type="text" 
             class="license-input" 
             id="licenseInput" 
             placeholder="INF-TEST-2024-ABCD-5677"
             maxlength="24"
             autocomplete="off">
      
      <div class="license-buttons">
        <button class="btn-primary" id="activateLicense">
          Activate License
        </button>
        <a href="https://your-store.com/purchase" 
           target="_blank" 
           class="btn-secondary" 
           id="purchaseLicense">
          Purchase License
        </a>
      </div>
      
      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        By activating, you agree to the 
        <a href="#" style="color: var(--accent); text-decoration: underline;" id="licenseAgreementLink">License Agreement</a>
      </p>
      
      <p style="margin-top: 15px; font-size: 11px; color: #666; font-style: italic;">
        Development: Use test license above for full access
      </p>
    </div>
  </div>

  <!-- ========== LOADING OVERLAY ========== -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- ========== MAIN APPLICATION ========== -->
  <div class="app-shell" id="appShell">
    
    <!-- SIDEBAR NAVIGATION -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-title">The Infinity Loop</div>
        <div class="brand-sub" id="licenseTypeDisplay">Trial Version â€¢ 2/11 Chapters</div>

        <div class="progress-block">
          <div class="progress-header-row">
            <span>Reading Progress</span>
            <button id="progress-reset" type="button">Reset</button>
          </div>

          <div class="progress-item">
            <div class="progress-item-label">
              <span>Overall (chapters)</span>
              <span id="overall-progress-label">0 / 2</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="overall-progress-fill"></div>
            </div>
          </div>

          <div class="progress-item">
            <div class="progress-item-label">
              <span>Current chapter</span>
              <span id="chapter-progress-label">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="chapter-progress-fill"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- FRONT MATTER SECTION -->
      <div class="nav-section collapsed" data-section="front">
        <div class="nav-section-title">
          Front Matter
        </div>
        <ul class="nav-list" id="frontMatterList">
          <!-- Front matter items loaded dynamically -->
        </ul>
      </div>

      <!-- CORE CHAPTERS SECTION -->
      <div class="nav-section collapsed" data-section="chapters">
        <div class="nav-section-title">
          Core Chapters <span id="chapterLimit">(2/11)</span>
        </div>
        <ul class="nav-list" id="chapterList">
          <!-- Chapters loaded dynamically -->
        </ul>
      </div>

      <!-- BACK MATTER SECTION -->
      <div class="nav-section collapsed" data-section="back">
        <div class="nav-section-title">
          Back Matter
        </div>
        <ul class="nav-list" id="backMatterList">
          <!-- Back matter items loaded dynamically -->
        </ul>
      </div>

      <div class="nav-footer">
        <span class="label">Loop Archetypes</span>
        <div class="loop-tags">
          <span class="loop-tag">Surveillance</span>
          <span class="loop-tag">Criminalization</span>
          <span class="loop-tag">Extraction</span>
          <span class="loop-tag">Destabilization</span>
          <span class="loop-tag">Resistance</span>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: var(--muted);">
          <div id="userInfo">Logged in as: <span id="userEmail">Loading...</span></div>
          <button id="upgradeButton" 
                  style="background: none; border: 1px solid var(--accent); color: var(--accent); padding: 6px 12px; border-radius: 4px; margin-top: 5px; font-size: 9px; cursor: pointer; min-height: 32px;">
            Upgrade to Full Version
          </button>
        </div>
      </div>
    </aside>

    <!-- MAIN READER PANE -->
    <main class="reader-pane" id="readerPane">
      <div class="reader-header">
        <div class="reader-header-left">
          <button id="menu-toggle" class="menu-toggle">
            â˜°
          </button>
          <div class="reader-title">
            Currently viewing: <span id="current-label">â€”</span>
            <span id="trialBadge" 
                  style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">
              TRIAL
            </span>
          </div>
        </div>
        <div class="reader-meta">
          <span id="licenseStatus">Trial Active</span>
          <span class="dot"></span>
          <span>Local offline reader</span>
          <button id="bookmark-btn">
            Bookmark
          </button>
          <button id="activateBtn" style="background: var(--accent-soft); color: var(--accent);">
            Activate License
          </button>
        </div>
      </div>
      <div class="reader-iframe-wrap">
        <!-- TRIAL LIMITATION OVERLAY -->
        <div class="trial-limitation" id="trialLimitation">
          <h3>Chapter Locked</h3>
          <p>This chapter is only available in the full version.</p>
          <p>Upgrade to unlock all 11 chapters and full features.</p>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
            <button class="btn-primary" id="upgradeNow">
              Upgrade Now
            </button>
            <button class="btn-secondary" onclick="document.getElementById('trialLimitation').style.display='none'">
              Continue Trial
            </button>
          </div>
        </div>
        
        <!-- MAIN CONTENT IFRAME -->
        <iframe id="reader-frame"
                class="reader-iframe"
                title="Book content">
        </iframe>
      </div>
    </main>
  </div>

  <script>
    (function() {
      'use strict';

      // ========== CONFIGURATION ==========
      const CONFIG = {
        APP_VERSION: '2.0.1',
        TRIAL_CHAPTERS: 2,
        TRIAL_DAYS: 7,
        TEST_LICENSE: "INF-TEST-2024-ABCD-5677", // MASTER TEST LICENSE
        VALID_LICENSE_PREFIX: "INF-",
        PURCHASE_URL: "https://your-store.com/purchase",
        FORCE_EMAIL_MODAL: true // Always show email modal for new signups
      };

      // ========== STATE MANAGEMENT ==========
      let currentFile = '';
      let currentChapter = 0;
      let scrollInterval = null;
      let isMobile = window.innerWidth <= 768;

      // ========== DOM ELEMENTS ==========
      const splashEntrance = document.getElementById('splashEntrance');
      const emailModal = document.getElementById('emailModal');
      const licenseModal = document.getElementById('licenseModal');
      const appShell = document.getElementById('appShell');
      const iframe = document.getElementById('reader-frame');
      const currentLabel = document.getElementById('current-label');
      const trialLimitation = document.getElementById('trialLimitation');
      const frontMatterList = document.getElementById('frontMatterList');
      const chapterList = document.getElementById('chapterList');
      const backMatterList = document.getElementById('backMatterList');
      const userEmailSpan = document.getElementById('userEmail');
      const licenseTypeDisplay = document.getElementById('licenseTypeDisplay');
      const trialBadge = document.getElementById('trialBadge');
      const upgradeButton = document.getElementById('upgradeButton');
      const activateBtn = document.getElementById('activateBtn');
      const enterBookBtn = document.getElementById('enterBookBtn');
      const bookCover = document.getElementById('bookCover');
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.getElementById('menu-toggle');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const licenseInput = document.getElementById('licenseInput');

      // ========== BOOK STRUCTURE ==========
      const BOOK_STRUCTURE = {
        frontMatter: [
          { 
            file: 'TITLE_PAGE.htm', 
            label: 'Title Page',
            alwaysAccessible: true
          },
          { 
            file: 'Dedication.htm', 
            label: 'Dedication',
            alwaysAccessible: true
          },
          { 
            file: 'Epigraph_.htm', 
            label: 'Epigraph',
            alwaysAccessible: true
          },
          { 
            file: 'CONTENT_WARNING_.htm', 
            label: 'Content Warning / Reader Care Note',
            alwaysAccessible: true
          },
          { 
            file: 'A_NOTE_ON_LANGUAGE_AND_TERMINOLOGY_.htm', 
            label: 'Note on Language and Terminology',
            alwaysAccessible: true
          },
          { 
            file: 'HOW_TO_USE_THIS_BOOK_A_READER\'S_GUIDE_.htm', 
            label: 'How to Use This Book: A Reader\'s Guide',
            alwaysAccessible: true
          },
          { 
            file: 'AUTHOR\'S_PREFACE_UNDERSTANDING_THE_INFINITY_LOOP_.htm', 
            label: 'Author\'s Preface: Understanding the Infinity Loop',
            alwaysAccessible: true
          },
          { 
            file: 'NOTE_ON_SOURCES_AND_METHODOLOGY_.htm', 
            label: 'Note on Sources and Methodology',
            alwaysAccessible: true
          }
        ],
        
        chapters: [
          { 
            file: 'CHAPTER_1_clean_stitched_formatted.htm', 
            label: 'CHAPTER 1: THE GENESIS: RECONSTRUCTION AND THE BLACK CODES',
            badge: '(1865 - 1877) LoopSnapshotðŸŸ¡6/10'
          },
          { 
            file: 'CHAPTER_2_clean_stitched_formatted.htm', 
            label: 'CHAPTER 2: THE REFINEMENT: JIM CROW AND THE RISE OF LEGALIZED APARTHEID',
            badge: '(1877 - 1919) LoopSnapshotðŸŸ¢8/10'
          },
          { 
            file: 'CHAPTER_3_clean_stitched_formatted.htm', 
            label: 'CHAPTER 3: MOBILIZATION AND BACKLASH: RED SUMMER, GARVEY, AND THE PROTO-COINTELPRO',
            badge: '(1919 - 1945) LoopSnapshotðŸ”´8/10'
          },
          { 
            file: 'CHAPTER_4_clean_stitched_formatted.htm', 
            label: 'CHAPTER 4: COLD WAR CONTRADICTIONS: VETERANS, MCGEE, AND "GENOCIDE"',
            badge: '(1946 - 1955) LoopSnapshotðŸ”´8/10'
          },
          { 
            file: 'CHAPTER_5_clean_stitched_formatted.htm', 
            label: 'CHAPTER 5: COINTELPRO PEAK: NEUTRALIZATION, KERNER, AND THE PANTHER\'S PRICE',
            badge: '(1956 - 1971) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_6_clean_stitched_formatted.htm', 
            label: 'CHAPTER 6: THE MODERN CARCERAL STATE: THE WAR ON DRUGS ESCALATES',
            badge: '(1972 - 1989) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_7_clean_stitched_formatted.htm', 
            label: 'CHAPTER 7: THE "COLORBLIND" ERA: PREDICTIVE POLICING AND MASS INCARCERATION',
            badge: '(1990 - 2009) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_8_clean_stitched_formatted.htm', 
            label: 'CHAPTER 8: DIGITAL AUGMENTATION: FERGUSON, BALTIMORE, AND ALGORITHMIC BIAS',
            badge: '(2010 - 2016) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_9_clean_stitched_formatted.htm', 
            label: 'CHAPTER 9: THE AUTOMATED LOOP: BIE LABELS, AI, AND THE FUTURE OF CONTROL',
            badge: '(2017 - 2024) LoopSnapshotðŸ”´ðŸŸ¡ðŸŸ¢10/10'
          },
          { 
            file: 'CHAPTER_10_clean_stitched_formatted.htm', 
            label: 'CHAPTER 10: THE RESILIENCE BLUEPRINT: RESISTANCE AND THRIVING WITHIN THE LOOP',
            badge: '(1619 - Present) LoopSnapshotðŸŸ¢8/10'
          },
          { 
            file: 'CHAPTER_11_clean_stitched_formatted.htm', 
            label: 'CHAPTER 11: THE ABOLITION HORIZON: FROM EVIDENCE TO ABOLITION',
            badge: '2025 AND BEYOND LoopSnapshotðŸ”´10/10'
          }
        ],
        
        backMatter: [
          { 
            file: 'APPENDIX_A_LOOP MECHANISM GLOSSARY_.htm', 
            label: 'Appendix A: Loop Mechanism Glossary',
            alwaysAccessible: true
          },
          { 
            file: 'APPENDIX_B_HISTORICAL TIMELINE (1619-2025)_.htm', 
            label: 'Appendix B: Historical Timeline (1619â€“2025)',
            alwaysAccessible: true
          },
          { 
            file: 'APPENDIX_C_METHODOLOGY AND SOURCES NOTE_.htm', 
            label: 'Appendix C: Methodology and Sources Note',
            alwaysAccessible: true
          },
          { 
            file: 'WORKS CITED.htm', 
            label: 'Works Cited',
            alwaysAccessible: true
          },
          { 
            file: 'Tiered_Works_Cited.htm', 
            label: 'Tiered Works Cited (by tier)',
            alwaysAccessible: true
          },
          { 
            file: 'CONSOLIDATED_WORKS_CITED.htm', 
            label: 'Consolidated Works Cited (master list)',
            alwaysAccessible: true
          },
          { 
            file: 'ACKNOWLEDGMENTS_.htm', 
            label: 'Acknowledgments',
            alwaysAccessible: true
          },
          { 
            file: 'ABOUT_THE_AUTHOR.htm', 
            label: 'About the Author',
            alwaysAccessible: true
          }
        ]
      };

      // ========== LICENSE MANAGER ==========
      class LicenseManager {
        constructor() {
          this.deviceId = this.getDeviceId();
          this.userData = this.loadUserData();
          this.licenseData = this.loadLicenseData();
          this.trialData = this.loadTrialData();
          
          // DEVELOPMENT MODE: Clear existing licenses for testing
          if (CONFIG.FORCE_EMAIL_MODAL && this.isDevelopment()) {
            console.log('Development mode: Clearing existing licenses for testing');
            this.clearAllLicenses();
          }
        }

        isDevelopment() {
          return window.location.hostname === 'localhost' || 
                 window.location.hostname === '127.0.0.1' ||
                 window.location.hostname === '';
        }

        getDeviceId() {
          let deviceId = localStorage.getItem('infinityLoopDeviceId');
          if (!deviceId) {
            deviceId = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            localStorage.setItem('infinityLoopDeviceId', deviceId);
          }
          return deviceId;
        }

        loadUserData() {
          try {
            const data = localStorage.getItem('infinityLoopUser');
            return data ? JSON.parse(data) : null;
          } catch {
            return null;
          }
        }

        loadLicenseData() {
          try {
            const data = localStorage.getItem('infinityLoopLicense');
            if (!data) return null;
            
            const license = JSON.parse(data);
            if (license.expiry && new Date(license.expiry) < new Date()) {
              localStorage.removeItem('infinityLoopLicense');
              return null;
            }
            
            return license;
          } catch {
            return null;
          }
        }

        loadTrialData() {
          try {
            const data = localStorage.getItem('infinityLoopTrial');
            if (!data) return null;
            
            const trial = JSON.parse(data);
            if (trial.expiry && new Date(trial.expiry) < new Date()) {
              localStorage.removeItem('infinityLoopTrial');
              return null;
            }
            
            return trial;
          } catch {
            return null;
          }
        }

        saveUser(email) {
          const userData = {
            email: email,
            registered: new Date().toISOString(),
            deviceId: this.deviceId
          };
          localStorage.setItem('infinityLoopUser', JSON.stringify(userData));
          this.userData = userData;
          return userData;
        }

        startTrial(email) {
          const trialData = {
            email: email,
            startDate: new Date().toISOString(),
            expiry: new Date(Date.now() + CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000).toISOString(),
            chaptersAllowed: CONFIG.TRIAL_CHAPTERS,
            deviceId: this.deviceId
          };
          localStorage.setItem('infinityLoopTrial', JSON.stringify(trialData));
          this.trialData = trialData;
          return trialData;
        }

        activateLicense(licenseKey, email) {
          if (!licenseKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) && licenseKey !== CONFIG.TEST_LICENSE) {
            throw new Error('Invalid license key format');
          }

          const licenseData = {
            key: licenseKey,
            email: email || this.userData?.email,
            activated: new Date().toISOString(),
            expiry: licenseKey === CONFIG.TEST_LICENSE 
              ? new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() // 1 year for test
              : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(), // 1 year for real
            deviceId: this.deviceId
          };

          localStorage.setItem('infinityLoopLicense', JSON.stringify(licenseData));
          this.licenseData = licenseData;

          localStorage.removeItem('infinityLoopTrial');
          this.trialData = null;

          return licenseData;
        }

        hasActiveLicense() {
          return !!this.licenseData;
        }

        hasActiveTrial() {
          return !!this.trialData;
        }

        canAccessChapter(chapterNumber) {
          if (chapterNumber === 0) return true; // Front/back matter
          if (this.hasActiveLicense()) return true;
          if (this.hasActiveTrial()) return chapterNumber <= CONFIG.TRIAL_CHAPTERS;
          return false;
        }

        getUserEmail() {
          if (this.licenseData?.email) return this.licenseData.email;
          if (this.trialData?.email) return this.trialData.email;
          if (this.userData?.email) return this.userData.email;
          return '';
        }

        getAccessType() {
          if (this.hasActiveLicense()) return 'full';
          if (this.hasActiveTrial()) return 'trial';
          return 'none';
        }

        getRemainingTrialDays() {
          if (!this.trialData?.expiry) return 0;
          const expiry = new Date(this.trialData.expiry);
          const now = new Date();
          const diffTime = expiry - now;
          return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        }

        clearAllLicenses() {
          localStorage.removeItem('infinityLoopLicense');
          localStorage.removeItem('infinityLoopTrial');
          this.licenseData = null;
          this.trialData = null;
        }

        // For development: quick activate with test license
        quickTestActivate() {
          const testEmail = 'test@example.com';
          this.saveUser(testEmail);
          this.activateLicense(CONFIG.TEST_LICENSE, testEmail);
          console.log('Test license activated for development');
        }
      }

      // ========== INITIALIZE LICENSE MANAGER ==========
      const licenseManager = new LicenseManager();

      // ========== UI FLOW ==========
      function showEmailModal() {
        splashEntrance.style.display = 'none';
        emailModal.style.display = 'flex';
        
        setTimeout(() => {
          document.getElementById('trialEmail').focus();
        }, 100);
      }

      function showLicenseModal() {
        emailModal.style.display = 'none';
        licenseModal.style.display = 'flex';
        
        // Pre-fill with test license for development
        if (licenseManager.isDevelopment()) {
          licenseInput.value = CONFIG.TEST_LICENSE;
        }
        
        setTimeout(() => {
          licenseInput.focus();
        }, 100);
      }

      function hideModals() {
        emailModal.style.display = 'none';
        licenseModal.style.display = 'none';
      }

      function showApp() {
        splashEntrance.style.display = 'none';
        emailModal.style.display = 'none';
        licenseModal.style.display = 'none';
        appShell.style.display = 'flex';
        
        setTimeout(() => {
          appShell.style.opacity = '1';
        }, 10);
        
        // Initialize app components
        loadNavigation();
        loadProgress();
        updateOverallProgress();
        openSection('TITLE_PAGE.htm', 'Title Page', 0);
      }

      function startAppWithTrial(email) {
        if (!validateEmail(email)) {
          alert('Please enter a valid email address.');
          return;
        }
        
        const agreeTerms = document.getElementById('agreeTerms').checked;
        if (!agreeTerms) {
          alert('You must agree to the Terms of Service to continue.');
          return;
        }
        
        licenseManager.saveUser(email);
        licenseManager.startTrial(email);
        
        hideModals();
        showApp();
        alert('Welcome to The Infinity Loop! You have access to the first 2 chapters for 7 days.');
      }

      function startAppWithLicense(licenseKey) {
        const email = licenseManager.getUserEmail() || 
                     prompt('Enter your email for license activation:');
        
        if (!email) {
          alert('Email is required for license activation.');
          return;
        }
        
        if (!validateEmail(email)) {
          alert('Please enter a valid email address.');
          return;
        }
        
        try {
          licenseManager.activateLicense(licenseKey, email);
          hideModals();
          showApp();
          alert('License activated successfully! Full access granted.');
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      function checkExistingAccess() {
        const accessType = licenseManager.getAccessType();
        const email = licenseManager.getUserEmail();
        
        // ALWAYS show email modal for new users (as per requirements)
        if (accessType === 'none' || !email || CONFIG.FORCE_EMAIL_MODAL) {
          // New user - show email modal
          splashEntrance.style.opacity = '0';
          splashEntrance.style.transition = 'opacity 0.5s ease';
          
          setTimeout(() => {
            splashEntrance.style.display = 'none';
            showEmailModal();
          }, 500);
        } else {
          // Returning user - go directly to app
          splashEntrance.style.opacity = '0';
          splashEntrance.style.transition = 'opacity 0.5s ease';
          
          setTimeout(() => {
            splashEntrance.style.display = 'none';
            showApp();
          }, 500);
        }
      }

      // ========== EVENT LISTENERS ==========
      function setupEventListeners() {
        // Entrance page
        enterBookBtn.addEventListener('click', () => {
          splashEntrance.style.opacity = '0';
          splashEntrance.style.transition = 'opacity 0.5s ease';
          
          setTimeout(() => {
            splashEntrance.style.display = 'none';
            checkExistingAccess();
          }, 500);
        });

        bookCover.addEventListener('click', () => {
          enterBookBtn.click();
        });

        // Email modal
        document.getElementById('startTrialWithEmail').addEventListener('click', () => {
          const email = document.getElementById('trialEmail').value.trim();
          startAppWithTrial(email);
        });

        document.getElementById('trialEmail').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const email = document.getElementById('trialEmail').value.trim();
            startAppWithTrial(email);
          }
        });

        document.getElementById('switchToLicense').addEventListener('click', (e) => {
          e.preventDefault();
          showLicenseModal();
        });

        // License modal
        document.getElementById('activateLicense').addEventListener('click', () => {
          const licenseKey = document.getElementById('licenseInput').value.trim().toUpperCase();
          
          if (!licenseKey) {
            alert('Please enter a license key.');
            return;
          }
          
          startAppWithLicense(licenseKey);
        });

        document.getElementById('licenseInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const licenseKey = document.getElementById('licenseInput').value.trim().toUpperCase();
            startAppWithLicense(licenseKey);
          }
        });

        // Terms links
        document.getElementById('termsLink').addEventListener('click', (e) => {
          e.preventDefault();
          alert('Terms of Service:\n\n1. Trial lasts 7 days\n2. Email required for trial\n3. No spam, unsubscribe anytime\n4. Full version requires purchase');
        });

        document.getElementById('licenseAgreementLink').addEventListener('click', (e) => {
          e.preventDefault();
          alert('License Agreement:\n\n1. License grants access to all chapters\n2. One license per device\n3. Non-transferable\n4. Updates included for 1 year');
        });

        // Development shortcuts
        if (licenseManager.isDevelopment()) {
          console.log('Development mode active');
          console.log('Master Test License:', CONFIG.TEST_LICENSE);
          console.log('Quick activate: window.quickTest()');
          
          // Expose quick test function
          window.quickTest = function() {
            licenseManager.quickTestActivate();
            splashEntrance.style.display = 'none';
            showApp();
            alert('Test license activated! Full access granted.');
          };
        }
      }

      // ========== HELPER FUNCTIONS ==========
      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      // ========== APP FUNCTIONALITY (Simplified for this example) ==========
      function loadNavigation() {
        // This would load the navigation dynamically
        console.log('Navigation loaded');
      }

      function loadProgress() {
        // This would load progress from localStorage
        console.log('Progress loaded');
      }

      function updateOverallProgress() {
        // This would update progress bars
        console.log('Progress updated');
      }

      function openSection(file, label, chapterNumber) {
        // This would open a section in the iframe
        console.log('Opening:', file, label);
      }

      // ========== INITIALIZATION ==========
      function init() {
        setupEventListeners();
        
        // Show splash page
        splashEntrance.style.display = 'flex';
        
        // Development console info
        if (licenseManager.isDevelopment()) {
          console.log('=== DEVELOPMENT MODE ===');
          console.log('Master Test License:', CONFIG.TEST_LICENSE);
          console.log('To quickly activate test license, run: window.quickTest()');
          console.log('To reset all data, run: localStorage.clear()');
          console.log('=======================');
        }
      }

      // Start application
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // Development tools
      window.devTools = {
        resetAll: function() {
          localStorage.clear();
          location.reload();
        },
        activateTest: function() {
          if (licenseManager.isDevelopment()) {
            window.quickTest();
          }
        },
        getLicenseInfo: function() {
          return licenseManager;
        }
      };

    })();
  </script>
</body>
</html>