<!DOCTYPE html>
<html lang="en">
<head>
  <!-- (Optional) External scripts you were loading before -->
  <script type="text/javascript" src="https://infinityloopsite.netlify.app/ewNXqOVY_tUucyr4BvNZ7zkbZZwLdeTUSlUQ6jEkxGUIzPTctAwV43tFEUPlP2gh_nrBMm8J22sXokZ0yHYhbgspmp15u6Ae0hvKxpLXQI9sU3dRCGF3YzJCZqoTKw2Vsd_b-7z4YoDXDWIlVHFe_dHSDJ2HfxbPQHAX1R8oXzs="></script>
  <script type="text/javascript" src="https://infinityloopsite.netlify.app/ozgprIfiP3XUSNQxcUh26cLe10kEP2l377ol9a__BOazQQdWicLLdLDyc2eS7uccXwO4CkGrB9Wo8YBK6R5DWsJgV3TWkILfaVy7wdSDLLjx1qsyuPQ3H79-VSQT5SU8FwPUSMqPbip36sed98Q7bjAU82U4WPjbWR-OQAxX7qM="></script>

  <!-- META -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="description" content="Interactive reader for The Infinity Loop - Mapping the Machinery of Power, Policy, and Profit">
  <meta name="author" content="The Infinity Loop">
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="copyright" content="The Infinity Loop - All rights reserved">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">

  <title>The Infinity Loop Reader</title>

  <style>
    /* ========== CSS VARIABLES ========== */
    :root {
      --bg: #050608;
      --bg-elevated: #10131a;
      --text: #f4f5f7;
      --muted: #9ca3af;
      --border: #1f2933;
      --nav-width: 280px;
      --accent: #e63946;
      --accent-soft: rgba(230, 57, 70, 0.18);
      --accent-warm: #f59e0b;
      --accent-warm-soft: rgba(245, 158, 11, 0.16);
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-strong: 0 25px 50px rgba(0, 0, 0, 0.8);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #111827 0%, #020308 55%, #000000 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none;
    }

    /* PRINT PROTECTION (visual only, actual blocking is handled in browser) */
    @media print {
      body * {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      body::before {
        content: "Printing disabled - The Infinity Loop content is copyright protected. Purchase the full license for access to printable companion materials.";
        display: block !important;
        visibility: visible !important;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #000;
        text-align: center;
        font-weight: bold;
        background: white;
        padding: 40px;
        border: 3px solid #e63946;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        z-index: 999999;
      }
      body {
        height: 100vh !important;
        width: 100vw !important;
        overflow: hidden !important;
      }
    }

    /* ANIMATIONS */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes cardAppear {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes modalFadeIn {
      from { opacity: 0; backdrop-filter: blur(0px); }
      to { opacity: 1; backdrop-filter: blur(10px); }
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* SPLASH */
    .splash-entrance {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, #0a0e1a 0%, #000000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out;
    }
    .splash-card {
      max-width: 520px;
      width: 100%;
      padding: 24px 24px 32px;
      border-radius: 28px;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.06), rgba(13, 16, 24, 0.98));
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.65),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      animation: cardAppear 0.8s ease-out 0.3s both;
    }
    .splash-cover {
      width: 100%;
      border-radius: 20px;
      object-fit: cover;
      box-shadow:
        var(--shadow-strong),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        0 0 60px rgba(230, 57, 70, 0.2);
      transition: var(--transition);
      cursor: pointer;
    }
    .splash-cover:hover {
      transform: scale(1.02) rotate(1deg);
      box-shadow:
        0 30px 70px rgba(0,0,0,0.8),
        0 0 0 1px rgba(255,255,255,0.08),
        0 0 100px rgba(230,57,70,0.3);
    }
    .splash-title {
      margin-top: 8px;
      margin-bottom: 4px;
      text-align: center;
      font-size: clamp(1.8rem, 4vw, 2.2rem);
      font-weight: 800;
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.1;
      animation: slideUp 0.5s ease-out 0.5s both;
    }
    .splash-subtitle {
      margin: 0 0 8px 0;
      text-align: center;
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      color: rgba(255,255,255,0.8);
      font-weight: 300;
      letter-spacing: 0.05em;
      max-width: 400px;
      animation: slideUp 0.5s ease-out 0.6s both;
    }
    .splash-tagline {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 8px;
      animation: slideUp 0.5s ease-out 0.7s both;
    }
    .splash-button {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 9999px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow:
        0 10px 30px rgba(230, 57, 70, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-height: 54px;
      width: 100%;
      text-align: center;
      animation: slideUp 0.5s ease-out 0.8s both;
    }
    .splash-button:hover {
      transform: translateY(-3px);
      box-shadow:
        0 20px 40px rgba(230, 57, 70, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      backdrop-filter: blur(10px);
      animation: modalFadeIn 0.3s ease-out;
    }
    .modal-content {
      background: linear-gradient(135deg, #111827 0%, #020308 100%);
      border-radius: 24px;
      padding: clamp(20px, 5vw, 40px);
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--accent);
      box-shadow: 0 20px 60px rgba(230, 57, 70, 0.3);
      text-align: center;
      animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-content h2 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: clamp(1.5rem, 4vw, 28px);
      font-weight: 700;
    }
    .modal-content p {
      margin-bottom: 20px;
      color: var(--muted);
      line-height: 1.6;
    }
    .email-input,
    .license-input {
      width: 100%;
      padding: 15px 20px;
      background: rgba(31, 41, 55, 0.8);
      border: 2px solid var(--accent);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
      transition: var(--transition);
    }
    .email-input:focus,
    .license-input:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      min-height: 48px;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      display: block;
      background: rgba(31, 41, 55, 0.8);
      color: var(--text);
      border: 2px solid var(--accent);
      padding: 10px 20px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      text-align: center;
      margin: 8px 0;
      width: 100%;
    }
    .btn-secondary:hover {
      background: var(--accent-soft);
      transform: translateY(-2px);
    }

    /* APP SHELL */
    .app-shell {
      display: flex;
      height: 100vh;
      padding: 16px;
      gap: 16px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.3s forwards;
    }

    /* SIDEBAR */
    .sidebar {
      width: var(--nav-width);
      background: rgba(3, 7, 18, 0.96);
      border-radius: var(--radius);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow);
      overflow-y: auto;
      overflow-x: hidden;
      backdrop-filter: blur(10px);
    }
    .brand {
      padding: 4px 8px 6px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
      margin-bottom: 4px;
    }
    .brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .brand-sub {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    .nav-section {
      margin-top: 4px;
    }
    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: var(--muted);
      padding: 8px 10px 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      transition: var(--transition);
      border-radius: 6px;
    }
    .nav-section-title:hover {
      background: rgba(255,255,255,0.05);
    }
    .nav-section-title::after {
      content: "â–¼";
      font-size: 10px;
      transition: transform 0.3s ease;
    }
    .nav-section.collapsed .nav-section-title::after {
      transform: rotate(-90deg);
    }
    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .nav-section.collapsed .nav-list {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }
    .nav-item {
      margin: 2px 0;
    }
    .nav-link {
      width: 100%;
      text-align: left;
      border-radius: 9999px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      position: relative;
      min-height: 36px;
    }
    .nav-link:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
    }
    .nav-link.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
      font-weight: 600;
    }
    .nav-link.active::before {
      content: "";
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
    }
    .nav-link:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* READER PANE */
    .reader-pane {
      flex: 1;
      border-radius: var(--radius);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31,41,55,0.9);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .reader-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      background: rgba(15,23,42,0.8);
    }
    .reader-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .reader-title {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reader-title span {
      max-width: 320px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reader-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .reader-meta .dot {
      width: 4px;
      height: 4px;
      background: var(--muted);
      border-radius: 50%;
    }
    .activate-license-btn {
      border-radius: 9999px;
      border: 1px solid var(--accent);
      padding: 8px 14px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition);
    }
    .activate-license-btn:hover {
      background: var(--accent);
      color: white;
    }

    .reader-iframe-wrap {
      flex: 1;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }
    .reader-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #ffffff;
      display: block;
    }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.1);
      border-left-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* MESSAGES */
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      display: none;
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }
    .message.success {
      background: rgba(21, 128, 61, 0.2);
      color: #86efac;
      border: 1px solid rgba(22, 163, 74, 0.5);
    }
    .message.error {
      background: rgba(127, 29, 29, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(220, 38, 38, 0.5);
    }
    .message.show {
      display: block;
    }

    /* BADGES */
    .trial-badge {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-left: 8px;
      text-transform: uppercase;
    }
    .license-badge {
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-left: 8px;
      text-transform: uppercase;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .app-shell {
        flex-direction: column;
        padding: 8px;
        gap: 8px;
      }
      .sidebar {
        width: 100%;
        max-height: 40vh;
      }
      .reader-pane {
        height: 55vh;
        min-height: 300px;
      }
      .reader-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .reader-meta {
        flex-wrap: wrap;
        gap: 8px;
      }
      .reader-title {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- SPLASH -->
  <div class="splash-entrance" id="splashEntrance">
    <div class="splash-card">
      <img src="Front Cover.png"
           alt="The Infinity Loop - Book Cover"
           class="splash-cover"
           id="bookCover">

      <h1 class="splash-title">The Infinity Loop</h1>
      <p class="splash-subtitle">Mapping the Machinery of Power, Policy, and Profit</p>

      <div class="splash-tagline">Enter the Loop â€¢ Discover the System</div>

      <button class="splash-button" id="enterBookBtn">
        <span style="flex: 1; text-align: center;">Open The Infinity Loop</span>
        <span style="font-size: 1.2rem;">â†’</span>
      </button>
    </div>
  </div>

  <!-- EMAIL MODAL -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal-content">
      <h2>Start Your Free Trial</h2>
      <p>Enter your email address to access the first 2 chapters of The Infinity Loop for 7 days.</p>
      <p style="font-size: 14px; color: var(--muted);">
        No credit card required. Full version available with license.
      </p>

      <form id="emailForm">
        <div class="email-input-group">
          <input
            type="text"
            class="email-input"
            id="trialName"
            placeholder="Your name (optional)"
            autocomplete="name">

          <input
            type="email"
            class="email-input"
            id="trialEmail"
            placeholder="your@email.com"
            autocomplete="email"
            required>

          <div style="display: flex; align-items: flex-start; gap: 10px; margin-top: 15px;">
            <input
              type="checkbox"
              id="agreeTerms"
              style="width: auto; margin-top: 3px;"
              required>
            <label for="agreeTerms" style="font-size: 12px; text-align: left; color: var(--muted); line-height: 1.4;">
              I agree to receive updates and accept the
              <a href="#" style="color: var(--accent); text-decoration: underline;" id="termsLink">Terms of Service</a>
            </label>
          </div>
        </div>

        <button class="btn-primary" type="submit" id="startTrialWithEmail">
          Start Free Trial (2 Chapters)
        </button>

        <div id="emailMessage" class="message"></div>
      </form>

      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        Already have a license?
        <a href="#" id="switchToLicense" style="color: var(--accent); text-decoration: underline;">Activate here</a>
      </p>
    </div>
  </div>

  <!-- LICENSE MODAL -->
  <div class="modal-overlay" id="licenseModal">
    <div class="modal-content">
      <h2>Activate Full Version</h2>
      <p>Enter your license key to unlock all 11 chapters.</p>

      <input type="text"
             class="license-input"
             id="licenseInput"
             placeholder="INF-XXXXXXXX"
             maxlength="32"
             autocomplete="off">

      <button class="btn-primary" id="activateLicense">
        Activate License
      </button>

      <div style="margin: 20px 0; text-align: center; color: var(--muted); font-size: 14px;">
        â€” OR â€”
      </div>

      <div class="license-buttons">
        <a href="#"
           class="btn-secondary"
           id="purchaseStripe">
          Pay with Card / Apple Pay (Stripe)
        </a>
        <a href="#"
           class="btn-secondary"
           id="purchasePaypal">
          Pay with PayPal
        </a>
      </div>

      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        By activating, you agree to the
        <a href="#" style="color: var(--accent); text-decoration: underline;" id="licenseAgreementLink">License Agreement</a>
      </p>

      <div id="licenseMessage" class="message"></div>
    </div>
  </div>

  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- MAIN APPLICATION -->
  <div class="app-shell" id="app-shell" style="display: none;">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-title">The Infinity Loop</div>
        <div class="brand-sub" id="licenseTypeDisplay">Trial Version â€¢ 2/11 Chapters</div>
      </div>

      <div class="nav-section" data-section="front">
        <div class="nav-section-title">Front Matter</div>
        <ul class="nav-list" id="frontMatterList"></ul>
      </div>

      <div class="nav-section" data-section="chapters">
        <div class="nav-section-title">
          Core Chapters <span id="chapterLimit">(2/11)</span>
        </div>
        <ul class="nav-list" id="chapterList"></ul>
      </div>

      <div class="nav-section" data-section="back">
        <div class="nav-section-title">Back Matter</div>
        <ul class="nav-list" id="backMatterList"></ul>
      </div>
    </aside>

    <!-- READER -->
    <main class="reader-pane" id="readerPane">
      <div class="reader-header">
        <div class="reader-header-left">
          <div class="reader-title">
            Currently viewing: <span id="current-label">â€”</span>
            <span id="trialBadge" class="trial-badge" style="display: none;">TRIAL</span>
            <span id="fullBadge" class="license-badge" style="display: none;">FULL</span>
          </div>
        </div>
        <div class="reader-meta">
          <span id="licenseStatus">Trial Active</span>
          <span class="dot"></span>
          <span>Local offline reader</span>
          <button id="activateBtn" class="activate-license-btn">Activate License</button>
        </div>
      </div>
      <div class="reader-iframe-wrap">
        <iframe id="reader-frame" class="reader-iframe" title="Book content"></iframe>
      </div>
    </main>
  </div>

  <!-- JAVASCRIPT -->
  <script>
    // CONFIG
    const CONFIG = {
      APP_VERSION: '2.0.0',
      TRIAL_CHAPTERS: 2,
      TRIAL_DAYS: 7,
      TEST_LICENSE: 'INF-TEST-2024-ABCD-5678',
      VALID_LICENSE_PREFIX: 'INF-',
      MAKE_WEBHOOK_URL: 'https://hook.us2.make.com/4bwg1lvvkqkqwk75tv8b2jmc8upri5fv',
      STRIPE_CHECKOUT_URL: 'https://buy.stripe.com/dRm7sN2on3yF26FbYEdIA01',
      PAYPAL_CHECKOUT_URL: 'https://www.paypal.com/ncp/payment/FR755FQZHEGQA'
    };

    // STATE
    let currentFile = '';
    let currentChapter = 0;
    let isMobile = window.innerWidth <= 768;

    // LICENSE MANAGER
    class LicenseManager {
      constructor() {
        this.deviceId = this.getDeviceId();
        this.userData = this.loadUserData();
        this.licenseData = this.loadLicenseData();
        this.trialData = this.loadTrialData();
      }

      getDeviceId() {
        let deviceId = localStorage.getItem('infinityLoopDeviceId');
        if (!deviceId) {
          const timestamp = Date.now().toString(36);
          const random = Math.random().toString(36).substring(2, 10);
          deviceId = `DEV-${timestamp}-${random}`.toUpperCase();
          localStorage.setItem('infinityLoopDeviceId', deviceId);
        }
        return deviceId;
      }

      loadUserData() {
        try {
          const data = localStorage.getItem('infinityLoopUser');
          return data ? JSON.parse(data) : null;
        } catch {
          return null;
        }
      }

      loadLicenseData() {
        try {
          const data = localStorage.getItem('infinityLoopLicense');
          if (!data) return null;
          const license = JSON.parse(data);
          if (license.expiry && new Date(license.expiry) < new Date()) {
            localStorage.removeItem('infinityLoopLicense');
            return null;
          }
          return license;
        } catch {
          return null;
        }
      }

      loadTrialData() {
        try {
          const data = localStorage.getItem('infinityLoopTrial');
          if (!data) return null;
          const trial = JSON.parse(data);
          if (trial.expiry && new Date(trial.expiry) < new Date()) {
            localStorage.removeItem('infinityLoopTrial');
            return null;
          }
          return trial;
        } catch {
          return null;
        }
      }

      saveUser(email, name = '') {
        const userData = {
          email: email.trim(),
          name: name.trim() || '',
          registered: new Date().toISOString(),
          deviceId: this.deviceId
        };
        localStorage.setItem('infinityLoopUser', JSON.stringify(userData));
        this.userData = userData;
        return userData;
      }

      startTrial(email, name = '') {
        const trialData = {
          email: email.trim(),
          name: name.trim() || '',
          startDate: new Date().toISOString(),
          expiry: new Date(Date.now() + CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000).toISOString(),
          chaptersAllowed: CONFIG.TRIAL_CHAPTERS,
          deviceId: this.deviceId
        };
        localStorage.setItem('infinityLoopTrial', JSON.stringify(trialData));
        this.trialData = trialData;
        return trialData;
      }

      activateLicense(licenseKey, email) {
        licenseKey = licenseKey.trim().toUpperCase();
        if (!licenseKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) && licenseKey !== CONFIG.TEST_LICENSE) {
          throw new Error('Invalid license key format. License must start with "INF-".');
        }
        const licenseData = {
          key: licenseKey,
          email: email || this.userData?.email,
          activated: new Date().toISOString(),
          expiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
          deviceId: this.deviceId
        };
        localStorage.setItem('infinityLoopLicense', JSON.stringify(licenseData));
        this.licenseData = licenseData;
        localStorage.removeItem('infinityLoopTrial');
        this.trialData = null;
        return licenseData;
      }

      hasActiveLicense() {
        return !!this.licenseData;
      }

      hasActiveTrial() {
        if (!this.trialData) return false;
        const expiry = new Date(this.trialData.expiry);
        return expiry > new Date();
      }

      canAccessChapter(chapterNumber) {
        if (chapterNumber === 0) return true;
        if (this.hasActiveLicense()) return true;
        if (this.hasActiveTrial()) return chapterNumber <= CONFIG.TRIAL_CHAPTERS;
        return false;
      }

      getUserEmail() {
        if (this.licenseData?.email) return this.licenseData.email;
        if (this.trialData?.email) return this.trialData.email;
        if (this.userData?.email) return this.userData.email;
        return '';
      }

      getUserName() {
        if (this.licenseData?.name) return this.licenseData.name;
        if (this.trialData?.name) return this.trialData.name;
        if (this.userData?.name) return this.userData.name;
        return '';
      }

      getAccessType() {
        if (this.hasActiveLicense()) return 'full';
        if (this.hasActiveTrial()) return 'trial';
        return 'none';
      }

      getRemainingTrialDays() {
        if (!this.trialData?.expiry) return 0;
        const expiry = new Date(this.trialData.expiry);
        const now = new Date();
        const diffTime = expiry - now;
        return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
      }
    }

    const licenseManager = new LicenseManager();
 
    // BOOK STRUCTURE (file names must match your screenshot)
    const BOOK_STRUCTURE = {
      frontMatter: [
        { file: 'TITLE_PAGE.htm', label: 'Title Page',  alwaysAccessible: true },
        { file: 'Dedication.htm', label: 'Dedication', alwaysAccessible: true },
        { file: 'Epigraph_.htm', label: 'Epigraph', alwaysAccessible: true },
        { file: 'CONTENT_WARNING_.htm', label: 'Content Warning / Reader Care Note', alwaysAccessible: true },
        { file: 'A_NOTE_ON_LANGUAGE_AND_TERMINOLOGY.htm', label: 'Note on Language and Terminology', alwaysAccessible: true },
        { file: 'HOW_TO_USE_THIS_BOOK_A_READER\'S_GUIDE_.htm', label: 'How to Use This Book: A Reader\'s Guide', alwaysAccessible: true },
        { file: 'AUTHOR\'S_PREFACE_UNDERSTANDING_THE_INFINITY_LOOP_.htm', label: 'Author\'s Preface: Understanding the Infinity Loop', alwaysAccessible: true },
        { file: 'NOTE_ON_SOURCES_AND_METHODOLOGY_.htm', label: 'Note on Sources and Methodology', alwaysAccessible: true }
      ],
      chapters: [
        { file: 'CHAPTER_1_clean_stitched_formatted.htm', label: 'CHAPTER 1: THE GENESIS: RECONSTRUCTION AND THE BLACK CODES', badge: '(1865 - 1877) LoopSnapshotðŸŸ¡6/10' },
        { file: 'CHAPTER_2_clean_stitched_formatted.htm', label: 'CHAPTER 2: THE REFINEMENT: JIM CROW AND THE RISE OF LEGALIZED APARTHEID', badge: '(1877 - 1919) LoopSnapshotðŸŸ¢8/10' },
        { file: 'CHAPTER_3_clean_stitched_formatted.htm', label: 'CHAPTER 3: MOBILIZATION AND BACKLASH: RED SUMMER, GARVEY, AND THE PROTO-COINTELPRO', badge: '(1919 - 1945) LoopSnapshotðŸ”´8/10' },
        { file: 'CHAPTER_4_clean_stitched_formatted.htm', label: 'CHAPTER 4: COLD WAR CONTRADICTIONS: VETERANS, MCGEE, AND "GENOCIDE"', badge: '(1946 - 1955) LoopSnapshotðŸ”´8/10' },
        { file: 'CHAPTER_5_clean_stitched_formatted.htm', label: 'CHAPTER 5: COINTELPRO PEAK: NEUTRALIZATION, KERNER, AND THE PANTHER\'S PRICE', badge: '(1956 - 1971) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_6_clean_stitched_formatted.htm', label: 'CHAPTER 6: THE MODERN CARCERAL STATE: THE WAR ON DRUGS ESCALATES', badge: '(1972 - 1989) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_7_clean_stitched_formatted.htm', label: 'CHAPTER 7: THE "COLORBLIND" ERA: PREDICTIVE POLICING AND MASS INCARCERATION', badge: '(1990 - 2009) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_8_clean_stitched_formatted.htm', label: 'CHAPTER 8: DIGITAL AUGMENTATION: FERGUSON, BALTIMORE, AND ALGORITHMIC BIAS', badge: '(2010 - 2016) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_9_clean_stitched_formatted.htm', label: 'CHAPTER 9: THE AUTOMATED LOOP: BIE LABELS, AI, AND THE FUTURE OF CONTROL', badge: '(2017 - 2024) LoopSnapshotðŸ”´ðŸŸ¡ðŸŸ¢10/10' },
        { file: 'CHAPTER_10_clean_stitched_formatted.htm', label: 'CHAPTER 10: THE RESILIENCE BLUEPRINT: RESISTANCE AND THRIVING WITHIN THE LOOP', badge: '(1619 - Present) LoopSnapshotðŸŸ¢8/10' },
        { file: 'CHAPTER_11_clean_stitched_formatted.htm', label: 'CHAPTER 11: THE ABOLITION HORIZON: FROM EVIDENCE TO ABOLITION', badge: '2025 AND BEYOND LoopSnapshotðŸ”´10/10' }
      ],
      backMatter: [
        { file: 'APPENDIX_A_LOOP MECHANISM GLOSSARY_.htm', label: 'Appendix A: Loop Mechanism Glossary', alwaysAccessible: true },
        { file: 'APPENDIX_B_HISTORICAL TIMELINE (1619-2025)_.htm', label: 'Appendix B: Historical Timeline (1619â€“2025)', alwaysAccessible: true },
        { file: 'APPENDIX_C_METHODOLOGY AND SOURCES NOTE_.htm', label: 'Appendix C: Methodology and Sources Note', alwaysAccessible: true },
        { file: 'WORKS CITED.htm', label: 'Works Cited', alwaysAccessible: true },
        { file: 'Tiered_Works_Cited.htm', label: 'Tiered Works Cited (by tier)', alwaysAccessible: true },
        { file: 'CONSOLIDATED_WORKS_CITED.htm', label: 'Consolidated Works Cited (master list)', alwaysAccessible: true },
        { file: 'ACKNOWLEDGMENTS_.htm', label: 'Acknowledgments', alwaysAccessible: true },
        { file: 'ABOUT_THE_AUTHOR.htm', label: 'About the Author', alwaysAccessible: true }
      ]
    };

    // DOM SHORTCUTS
    const splashEntrance = document.getElementById('splashEntrance');
    const emailModal = document.getElementById('emailModal');
    const licenseModal = document.getElementById('licenseModal');
    const appShell = document.getElementById('app-shell');
    const iframe = document.getElementById('reader-frame');
    const currentLabel = document.getElementById('current-label');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const trialBadge = document.getElementById('trialBadge');
    const fullBadge = document.getElementById('fullBadge');

    // HELPERS
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function formatLicenseKey(key) {
      if (!key) return '';
      key = key.toUpperCase().trim();
      key = key.replace(/[^A-Z0-9-]/g, '');
      return key;
    }

    function showLoading() { loadingOverlay.style.display = 'flex'; }
    function hideLoading() { loadingOverlay.style.display = 'none'; }

    function sendToMake(eventType, data = {}) {
      if (!CONFIG.MAKE_WEBHOOK_URL) return;
      const basePayload = {
        event: eventType,
        source: 'infinity-loop-reader',
        appVersion: CONFIG.APP_VERSION,
        deviceId: licenseManager.deviceId,
        timestamp: new Date().toISOString()
      };
      const payload = { ...basePayload, ...data };
      fetch(CONFIG.MAKE_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(err => console.error('Make webhook error:', err));
    }

    // NAVIGATION
    function loadNavigation() {
      const frontMatterList = document.getElementById('frontMatterList');
      const chapterList = document.getElementById('chapterList');
      const backMatterList = document.getElementById('backMatterList');

      frontMatterList.innerHTML = '';
      chapterList.innerHTML = '';
      backMatterList.innerHTML = '';

      // Front matter
      BOOK_STRUCTURE.frontMatter.forEach(item => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        button.textContent = item.label;
        button.addEventListener('click', () => openSection(item.file, item.label, 0));
        li.appendChild(button);
        frontMatterList.appendChild(li);
      });

      // Chapters
      BOOK_STRUCTURE.chapters.forEach((chapter, index) => {
        const chapterNum = index + 1;
        const canAccess = licenseManager.canAccessChapter(chapterNum);
        const li = document.createElement('li');
        li.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        const labelSpan = document.createElement('span');
        labelSpan.textContent = chapter.label.split('LoopSnapshot')[0].trim();
        button.appendChild(labelSpan);
        if (!canAccess) {
          button.disabled = true;
          button.style.opacity = '0.5';
          button.title = 'Upgrade to full version to access this chapter';
        }
        button.addEventListener('click', () => {
          if (!canAccess) {
            showLicenseModal();
            return;
          }
          openSection(chapter.file, chapter.label, chapterNum);
        });
        li.appendChild(button);
        chapterList.appendChild(li);
      });

      // Back matter
      BOOK_STRUCTURE.backMatter.forEach(item => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        button.textContent = item.label;
        button.addEventListener('click', () => openSection(item.file, item.label, 0));
        li.appendChild(button);
        backMatterList.appendChild(li);
      });

      updateAccessUI();
    }

    function updateAccessUI() {
      const accessType = licenseManager.getAccessType();
      const licenseTypeDisplay = document.getElementById('licenseTypeDisplay');
      const chapterLimit = document.getElementById('chapterLimit');
      const licenseStatus = document.getElementById('licenseStatus');
      const activateBtn = document.getElementById('activateBtn');

      if (accessType === 'full') {
        licenseTypeDisplay.textContent = 'Full Version â€¢ 11/11 Chapters';
        trialBadge.style.display = 'none';
        fullBadge.style.display = 'inline-block';
        chapterLimit.textContent = '(11/11)';
        licenseStatus.textContent = 'Full Version';
        activateBtn.textContent = 'License Active';
        activateBtn.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
        activateBtn.style.color = '#fff';
        activateBtn.style.borderColor = '#10b981';
      } else if (accessType === 'trial') {
        const remainingDays = licenseManager.getRemainingTrialDays();
        licenseTypeDisplay.textContent =
          `Trial Version â€¢ ${CONFIG.TRIAL_CHAPTERS}/11 Chapters â€¢ ${remainingDays} days left`;
        trialBadge.style.display = 'inline-block';
        fullBadge.style.display = 'none';
        chapterLimit.textContent = `(${CONFIG.TRIAL_CHAPTERS}/11)`;
        licenseStatus.textContent = `Trial Active â€¢ ${remainingDays} days left`;
        activateBtn.textContent = 'Activate License';
        activateBtn.style.background = 'var(--accent-soft)';
        activateBtn.style.color = 'var(--accent)';
        activateBtn.style.borderColor = 'var(--accent)';
      } else {
        licenseTypeDisplay.textContent = 'No Access';
        trialBadge.style.display = 'none';
        fullBadge.style.display = 'none';
        chapterLimit.textContent = '(0/11)';
        licenseStatus.textContent = 'No Access';
        activateBtn.textContent = 'Get Access';
        activateBtn.style.background = 'var(--accent-soft)';
        activateBtn.style.color = 'var(--accent)';
        activateBtn.style.borderColor = 'var(--accent)';
      }
    }

    function openSection(file, label, chapterNum = 0) {
      if (!file) return;
      currentFile = file;
      currentChapter = chapterNum;
      showLoading();
      iframe.src = file;
      const baseLabel = label.split('LoopSnapshot')[0].trim();
      currentLabel.textContent = baseLabel;

      document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
      const navLinks = document.querySelectorAll('.nav-link');
      for (const btn of navLinks) {
        const btnText = btn.textContent.replace('âœ“', '').trim();
        if (btnText === baseLabel || btnText.startsWith(baseLabel.substring(0, 25))) {
          btn.classList.add('active');
          const section = btn.closest('.nav-section');
          if (section && section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
          }
          break;
        }
      }

      iframe.onload = () => hideLoading();
      iframe.onerror = () => {
        hideLoading();
        alert(`Error loading "${label}". Please check if the file "${file}" exists in the same folder as index.html.`);
      };
    }

    // UI FLOW
    function showEmailModal() {
      splashEntrance.style.display = 'none';
      emailModal.style.display = 'flex';
      setTimeout(() => {
        const nameInput = document.getElementById('trialName');
        const emailInput = document.getElementById('trialEmail');
        if (nameInput && !nameInput.value) {
          nameInput.focus();
        } else {
          emailInput.focus();
        }
      }, 100);
    }

    function showLicenseModal() {
      emailModal.style.display = 'none';
      licenseModal.style.display = 'flex';
      setTimeout(() => {
        document.getElementById('licenseInput').focus();
      }, 100);
    }

    function showApp() {
      splashEntrance.style.display = 'none';
      emailModal.style.display = 'none';
      licenseModal.style.display = 'none';
      appShell.style.display = 'flex';
      loadNavigation();
      openSection('TITLE_PAGE.htm', 'Title Page', 0);
    }

    function showMessage(elementId, text, type = 'info', show = true) {
      const element = document.getElementById(elementId);
      if (!element) return;
      element.textContent = text;
      element.className = 'message';
      if (show) {
        element.classList.add(type);
        element.classList.add('show');
      } else {
        element.classList.remove('show');
      }
    }

    function startAppWithTrial(email, name = '') {
      if (!validateEmail(email)) {
        showMessage('emailMessage', 'Please enter a valid email address.', 'error');
        return;
      }
      const agreeTerms = document.getElementById('agreeTerms');
      if (!agreeTerms || !agreeTerms.checked) {
        showMessage('emailMessage', 'You must agree to the Terms of Service to continue.', 'error');
        return;
      }

      const submitBtn = document.getElementById('startTrialWithEmail');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Setting up trial...';

      licenseManager.saveUser(email, name);
      licenseManager.startTrial(email, name);

      sendToMake('trial_signup', {
        email,
        name,
        accessType: 'trial'
      });

      showMessage('emailMessage', 'Success! Starting your trial...', 'success');

      setTimeout(() => {
        showApp();
        showMessage('emailMessage', '', 'success', false);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Start Free Trial (2 Chapters)';
      }, 1500);
    }

    function startAppWithLicense(licenseKey) {
      licenseKey = formatLicenseKey(licenseKey);
      if (!licenseKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) && licenseKey !== CONFIG.TEST_LICENSE) {
        showMessage('licenseMessage', 'Invalid license key format. License must start with "INF-".', 'error');
        return;
      }

      let email = licenseManager.getUserEmail();
      if (!email) {
        email = prompt('Enter your email for license activation:') || '';
        if (!validateEmail(email)) {
          showMessage('licenseMessage', 'Please enter a valid email address.', 'error');
          return;
        }
      }

      const name = licenseManager.getUserName();
      const licenseKeyLast4 = licenseKey.slice(-4);

      try {
        licenseManager.activateLicense(licenseKey, email);

        sendToMake('license_activation', {
          email,
          name,
          licenseKeyLast4,
          licenseKey,
          accessType: 'license'
        });

        showMessage('licenseMessage', 'License activated successfully!', 'success');

        setTimeout(() => {
          showApp();
          showMessage('licenseMessage', '', 'success', false);
        }, 1500);
      } catch (err) {
        showMessage('licenseMessage', 'Error: ' + err.message, 'error');
      }
    }

    function checkExistingAccess() {
      const accessType = licenseManager.getAccessType();
      const email = licenseManager.getUserEmail();
      splashEntrance.style.opacity = '0';
      splashEntrance.style.transition = 'opacity 0.5s ease';
      setTimeout(() => {
        splashEntrance.style.display = 'none';
        if (accessType === 'none' || !email) {
          showEmailModal();
        } else {
          showApp();
        }
      }, 500);
    }

    // EVENT LISTENERS
    function setupEventListeners() {
      document.getElementById('enterBookBtn').addEventListener('click', () => {
        checkExistingAccess();
      });
      document.getElementById('bookCover').addEventListener('click', () => {
        document.getElementById('enterBookBtn').click();
      });

      document.getElementById('emailForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('trialEmail').value.trim();
        const name = (document.getElementById('trialName')?.value || '').trim();
        startAppWithTrial(email, name);
      });
      document.getElementById('trialEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const email = document.getElementById('trialEmail').value.trim();
          const name = (document.getElementById('trialName')?.value || '').trim();
          startAppWithTrial(email, name);
        }
      });

      document.getElementById('activateLicense').addEventListener('click', () => {
        const licenseKey = document.getElementById('licenseInput').value.trim();
        startAppWithLicense(licenseKey);
      });
      document.getElementById('licenseInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const licenseKey = document.getElementById('licenseInput').value.trim();
          startAppWithLicense(licenseKey);
        }
      });

      document.getElementById('purchaseStripe').addEventListener('click', (e) => {
        e.preventDefault();
        const confirmed = confirm('You will be redirected to our secure Stripe checkout page. Continue?');
        if (confirmed) window.open(CONFIG.STRIPE_CHECKOUT_URL, '_blank');
      });
      document.getElementById('purchasePaypal').addEventListener('click', (e) => {
        e.preventDefault();
        const confirmed = confirm('You will be redirected to our secure PayPal checkout page. Continue?');
        if (confirmed) window.open(CONFIG.PAYPAL_CHECKOUT_URL, '_blank');
      });

      document.getElementById('switchToLicense').addEventListener('click', (e) => {
        e.preventDefault();
        showLicenseModal();
      });
      document.getElementById('activateBtn').addEventListener('click', showLicenseModal);

      document.getElementById('termsLink').addEventListener('click', (e) => {
        e.preventDefault();
        alert('Terms of Service:\\n\\n1. Trial lasts 7 days.\\n2. Email is required for access.\\n3. You may unsubscribe from updates at any time.\\n4. Full version requires purchase of a license.');
      });
      document.getElementById('licenseAgreementLink').addEventListener('click', (e) => {
        e.preventDefault();
        alert('License Agreement (summary):\\n\\n1. License grants access to all chapters on one device.\\n2. Non-transferable.\\n3. Updates included for 1 year.\\n4. Content is copyright protected; redistribution is prohibited.');
      });

      document.querySelectorAll('.nav-section-title').forEach(title => {
        title.addEventListener('click', (e) => {
          const section = e.target.closest('.nav-section');
          section.classList.toggle('collapsed');
        });
      });

      document.querySelectorAll('.nav-section').forEach(section => {
        section.classList.add('collapsed');
      });

      window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
      });

      // Refresh countdown every hour
      setInterval(() => {
        updateAccessUI();
      }, 60 * 60 * 1000);
    }

    function init() {
      setupEventListeners();
      splashEntrance.style.display = 'flex';

      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('Development mode active');
        console.log('Test license:', CONFIG.TEST_LICENSE);
        const licenseInput = document.getElementById('licenseInput');
        if (licenseInput) licenseInput.placeholder = CONFIG.TEST_LICENSE;
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
