<!DOCTYPE html>
<html lang="en">
<head>
  <script type='text/javascript' src='https://infinityloopsite.netlify.app/ewNXqOVY_tUucyr4BvNZ7zkbZZwLdeTUSlUQ6jEkxGUIzPTctAwV43tFEUPlP2gh_nrBMm8J22sXokZ0yHYhbgspmp15u6Ae0hvKxpLXQI9sU3dRCGF3YzJCZqoTKw2Vsd_b-7z4YoDXDWIlVHFe_dHSDJ2HfxbPQHAX1R8oXzs='></script>
  <script type='text/javascript' src='https://infinityloopsite.netlify.app/ozgprIfiP3XUSNQxcUh26cLe10kEP2l377ol9a__BOazQQdWicLLdLDyc2eS7uccXwO4CkGrB9Wo8YBK6R5DWsJgV3TWkILfaVy7wdSDLLjx1qsyuPQ3H79-VSQT5SU8FwPUSMqPbip36sed98Q7bjAU82U4WPjbWR-OQAxX7qM='></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="description" content="Interactive reader for The Infinity Loop - Mapping the Machinery of Power, Policy, and Profit">
  <meta name="author" content="The Infinity Loop">
  
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="copyright" content="The Infinity Loop - All rights reserved">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  
  <title>The Infinity Loop Reader</title>
  
  <style>
    /* ========== CSS VARIABLES ========== */
    :root {
      --bg: #050608;
      --bg-elevated: #10131a;
      --text: #f4f5f7;
      --muted: #9ca3af;
      --border: #1f2933;
      --nav-width: 280px;
      --accent: #e63946;
      --accent-soft: rgba(230, 57, 70, 0.18);
      --accent-warm: #f59e0b;
      --accent-warm-soft: rgba(245, 158, 11, 0.16);
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-strong: 0 25px 50px rgba(0, 0, 0, 0.8);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== BASE STYLES ========== */
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #111827 0%, #020308 55%, #000000 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none;
    }

    /* ========== PRINT PROTECTION ========== */
    @media print {
      body * {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      
      body::before {
        content: "Printing disabled - The Infinity Loop content is copyright protected. Purchase the full license for access to printable companion materials.";
        display: block !important;
        visibility: visible !important;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #000;
        text-align: center;
        font-weight: bold;
        background: white;
        padding: 40px;
        border: 3px solid #e63946;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        z-index: 999999;
      }
      
      body {
        height: 100vh !important;
        width: 100vw !important;
        overflow: hidden !important;
      }
    }

    /* ========== ANIMATIONS ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        backdrop-filter: blur(0px);
      }
      to {
        opacity: 1;
        backdrop-filter: blur(10px);
      }
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes progressPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ========== SPLASH SCREEN ========== */
    .splash-entrance {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0e1a 0%, #000000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out;
    }

    .splash-card {
      max-width: 520px;
      width: 100%;
      padding: 24px 24px 32px;
      border-radius: 28px;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.06), rgba(13, 16, 24, 0.98));
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.65),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      animation: cardAppear 0.8s ease-out 0.3s both;
    }

    .splash-cover {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 20px;
      object-fit: cover;
      box-shadow: 
        var(--shadow-strong),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        0 0 60px rgba(230, 57, 70, 0.2);
      transition: var(--transition);
      cursor: pointer;
    }

    .splash-title {
      margin-top: 8px;
      margin-bottom: 4px;
      text-align: center;
      font-size: clamp(1.8rem, 4vw, 2.2rem);
      font-weight: 800;
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.1;
      animation: slideUp 0.5s ease-out 0.5s both;
    }

    .splash-subtitle {
      margin: 0 0 8px 0;
      text-align: center;
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      color: rgba(255, 255, 255, 0.8);
      font-weight: 300;
      letter-spacing: 0.05em;
      max-width: 400px;
      animation: slideUp 0.5s ease-out 0.6s both;
    }

    .splash-tagline {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 8px;
      animation: slideUp 0.5s ease-out 0.7s both;
    }

    .splash-button {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 9999px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 
        0 10px 30px rgba(230, 57, 70, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-height: 54px;
      width: 100%;
      text-align: center;
      animation: slideUp 0.5s ease-out 0.8s both;
    }

    .splash-button:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 20px 40px rgba(230, 57, 70, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .splash-button span {
      font-size: 1.2rem;
      margin-left: 5px;
    }

    /* ========== MODALS ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      backdrop-filter: blur(10px);
      animation: modalFadeIn 0.3s ease-out;
    }

    .modal-content {
      background: linear-gradient(135deg, #111827 0%, #020308 100%);
      border-radius: 24px;
      padding: clamp(20px, 5vw, 40px);
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--accent);
      box-shadow: 0 20px 60px rgba(230, 57, 70, 0.3);
      text-align: center;
      animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-content h2 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: clamp(1.5rem, 4vw, 28px);
      font-weight: 700;
    }

    .modal-content p {
      margin-bottom: 20px;
      color: var(--muted);
      line-height: 1.6;
    }

    .email-input,
    .license-input {
      width: 100%;
      padding: 15px 20px;
      background: rgba(31, 41, 55, 0.8);
      border: 2px solid var(--accent);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
      transition: var(--transition);
    }

    .email-input:focus,
    .license-input:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      min-height: 48px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      display: block;
      background: rgba(31, 41, 55, 0.8);
      color: var(--text);
      border: 2px solid var(--accent);
      padding: 10px 20px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      text-align: center;
      margin: 8px 0;
      width: 100%;
    }

    .btn-secondary:hover {
      background: var(--accent-soft);
      transform: translateY(-2px);
    }

    /* ========== PROGRESS SYSTEM STYLES ========== */
    .progress-block {
      margin-top: 8px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(75, 85, 99, 0.7);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .progress-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    .progress-header-row button {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      padding: 4px 8px;
      text-decoration: underline;
      transition: color 0.2s ease;
      border-radius: 4px;
    }

    .progress-header-row button:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .progress-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .progress-item-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 9999px;
      background: rgba(31, 41, 55, 0.9);
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 9999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-warm));
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .progress-fill.animating {
      animation: progressPulse 1s ease-in-out;
    }

    /* ========== MAIN APP SHELL ========== */
    .app-shell {
      display: flex;
      height: 100vh;
      padding: 16px;
      gap: 16px;
      opacity: 0;
      animation: fadeIn 0.5s ease-out 0.3s forwards;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: var(--nav-width);
      background: rgba(3, 7, 18, 0.96);
      border-radius: var(--radius);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow);
      overflow-y: auto;
      overflow-x: hidden;
      backdrop-filter: blur(10px);
    }

    .brand {
      padding: 4px 8px 6px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
      margin-bottom: 4px;
    }

    .brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    .nav-section {
      margin-top: 4px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: var(--muted);
      padding: 8px 10px 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      transition: var(--transition);
      border-radius: 6px;
    }

    .nav-section-title:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-section-title::after {
      content: 'â–¼';
      font-size: 10px;
      transition: transform 0.3s ease;
    }

    .nav-section.collapsed .nav-section-title::after {
      transform: rotate(-90deg);
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .nav-section.collapsed .nav-list {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    .nav-item {
      margin: 2px 0;
    }

    .nav-link {
      width: 100%;
      text-align: left;
      border-radius: 9999px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      position: relative;
      min-height: 36px;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .nav-link.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
      font-weight: 600;
    }

    .nav-link.active::before {
      content: '';
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
    }

    .nav-link:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .nav-link:disabled:hover {
      background: transparent;
      border-color: transparent;
    }

    .nav-link .completion-check {
      margin-left: auto;
      color: var(--accent-warm);
      font-weight: bold;
    }

    /* ========== READER PANE ========== */
    .reader-pane {
      flex: 1;
      border-radius: var(--radius);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .reader-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.8);
    }

    .reader-title {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reader-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .reader-meta .dot {
      width: 4px;
      height: 4px;
      background: var(--muted);
      border-radius: 50%;
    }

    .reader-iframe-wrap {
      flex: 1;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }

    .reader-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #ffffff;
      display: block;
    }

    /* ========== LOADING OVERLAY ========== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* ========== MESSAGES ========== */
    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      display: none;
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }

    .message.success {
      background: rgba(21, 128, 61, 0.2);
      color: #86efac;
      border: 1px solid rgba(22, 163, 74, 0.5);
    }

    .message.error {
      background: rgba(127, 29, 29, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(220, 38, 38, 0.5);
    }

    .message.show {
      display: block;
    }

    /* ========== STATUS BADGES ========== */
    .trial-badge {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-left: 8px;
      text-transform: uppercase;
    }

    .license-badge {
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-left: 8px;
      text-transform: uppercase;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .app-shell {
        flex-direction: column;
        padding: 8px;
        gap: 8px;
      }
      
      .sidebar {
        width: 100%;
        max-height: 40vh;
      }
      
      .reader-pane {
        height: 55vh;
        min-height: 300px;
      }
      
      .reader-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .reader-meta {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .reader-title {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- ========== SPLASH SCREEN ========== -->
  <div class="splash-entrance" id="splashEntrance">
    <div class="splash-card">
      <img src="Front Cover.png" 
           alt="The Infinity Loop - Book Cover" 
           class="splash-cover" 
           id="bookCover">
      
      <h1 class="splash-title">The Infinity Loop</h1>
      <p class="splash-subtitle">Mapping the Machinery of Power, Policy, and Profit</p>
      
      <div class="splash-tagline">Enter the Loop â€¢ Discover the System</div>
      
      <button class="splash-button" id="enterBookBtn">
        <span style="flex: 1; text-align: center;">Open The Infinity Loop</span>
        <span style="font-size: 1.2rem;">â†’</span>
      </button>
    </div>
  </div>

  <!-- ========== EMAIL MODAL ========== -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal-content">
      <h2>Start Your Free Trial</h2>
      <p>Enter your email address to access the first 2 chapters of The Infinity Loop for 7 days.</p>
      <p style="font-size: 14px; color: var(--muted);">
        No credit card required. Full version available with license.
      </p>
      
      <form id="emailForm">
        <div class="email-input-group">
          <input 
            type="text"
            class="email-input"
            id="trialName"
            placeholder="Your name (optional)"
            autocomplete="name">
          
          <input 
            type="email"
            class="email-input"
            id="trialEmail"
            placeholder="your@email.com"
            autocomplete="email"
            required>
          
          <div style="display: flex; align-items: flex-start; gap: 10px; margin-top: 15px;">
            <input 
              type="checkbox"
              id="agreeTerms"
              style="width: auto; margin-top: 3px;"
              required>
            <label for="agreeTerms" style="font-size: 12px; text-align: left; color: var(--muted); line-height: 1.4;">
              I agree to receive updates and accept the 
              <a href="#" style="color: var(--accent); text-decoration: underline;" id="termsLink">Terms of Service</a>
            </label>
          </div>
        </div>
        
        <button class="btn-primary" type="submit" id="startTrialWithEmail">
          Start Free Trial (2 Chapters)
        </button>
        
        <div id="emailMessage" class="message"></div>
      </form>
      
      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        Already have a license? 
        <a href="#" id="switchToLicense" style="color: var(--accent); text-decoration: underline;">Activate here</a>
      </p>
    </div>
  </div>

  <!-- ========== LICENSE MODAL ========== -->
  <div class="modal-overlay" id="licenseModal">
    <div class="modal-content">
      <h2>Activate Full Version</h2>
      <p>Enter your license key to unlock all 11 chapters.</p>
      
      <input type="text" 
             class="license-input" 
             id="licenseInput" 
             placeholder="INF-XXXXXXXX"
             maxlength="12"
             autocomplete="off">
      
      <button class="btn-primary" id="activateLicense">
        Activate License
      </button>
      
      <div style="margin: 20px 0; text-align: center; color: var(--muted); font-size: 14px;">
        â€” OR â€”
      </div>
      
      <div class="license-buttons">
        <a href="#" 
           class="btn-secondary" 
           id="purchaseStripe">
          Pay with Card / Apple Pay (Stripe)
        </a>
        <a href="#" 
           class="btn-secondary" 
           id="purchasePaypal">
          Pay with PayPal
        </a>
      </div>
      
      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        By activating, you agree to the 
        <a href="#" style="color: var(--accent); text-decoration: underline;" id="licenseAgreementLink">License Agreement</a>
      </p>
      
      <div id="licenseMessage" class="message"></div>
    </div>
  </div>

  <!-- ========== LOADING OVERLAY ========== -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- ========== MAIN APPLICATION ========== -->
  <div class="app-shell" id="app-shell" style="display: none;">
    <!-- SIDEBAR NAVIGATION -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-title">The Infinity Loop</div>
        <div class="brand-sub" id="licenseTypeDisplay">Trial Version â€¢ 2/11 Chapters</div>

        <!-- FIXED PROGRESS BLOCK -->
        <div class="progress-block">
          <div class="progress-header-row">
            <span>Reading Progress</span>
            <button id="progress-reset" type="button">Reset All</button>
          </div>

          <div class="progress-item">
            <div class="progress-item-label">
              <span>Overall (chapters)</span>
              <span id="overall-progress-label">0 / 2</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="overall-progress-fill" style="width: 0%"></div>
            </div>
          </div>

          <div class="progress-item">
            <div class="progress-item-label">
              <span>Current chapter</span>
              <span id="chapter-progress-label">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="chapter-progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation sections -->
      <div class="nav-section" data-section="front">
        <div class="nav-section-title">Front Matter</div>
        <ul class="nav-list" id="frontMatterList"></ul>
      </div>

      <div class="nav-section" data-section="chapters">
        <div class="nav-section-title">Core Chapters <span id="chapterLimit">(2/11)</span></div>
        <ul class="nav-list" id="chapterList"></ul>
      </div>

      <div class="nav-section" data-section="back">
        <div class="nav-section-title">Back Matter</div>
        <ul class="nav-list" id="backMatterList"></ul>
      </div>
    </aside>

    <!-- MAIN READER PANE -->
    <main class="reader-pane" id="readerPane">
      <div class="reader-header">
        <div class="reader-header-left">
          <div class="reader-title">
            Currently viewing: <span id="current-label">â€”</span>
            <span id="trialBadge" class="trial-badge" style="display: none;">TRIAL</span>
            <span id="fullBadge" class="license-badge" style="display: none;">FULL</span>
          </div>
        </div>
        <div class="reader-meta">
          <span id="licenseStatus">Trial Active</span>
          <span class="dot"></span>
          <span>Local offline reader</span>
          <button id="activateBtn" class="activate-license-btn">Activate License</button>
        </div>
      </div>
      <div class="reader-iframe-wrap">
        <iframe id="reader-frame" class="reader-iframe" title="Book content" sandbox="allow-same-origin allow-scripts"></iframe>
      </div>
    </main>
  </div>

  <!-- ========== JAVASCRIPT ========== -->
  <script>
    // ========== CONFIGURATION ==========
    const CONFIG = {
      APP_VERSION: '2.0.0',
      TRIAL_CHAPTERS: 2,
      TRIAL_DAYS: 7,
      TEST_LICENSE: "INF-TEST-2024-ABCD-5678",
      VALID_LICENSE_PREFIX: "INF-",
      PURCHASE_URL: "https://buy.stripe.com/dRm7sN2on3yF26FbYEdIA01",
      MAKE_WEBHOOK_URL: "https://hook.us2.make.com/4bwg1lvvkqkqwk75tv8b2jmc8upri5fv",
      STRIPE_CHECKOUT_URL: "https://buy.stripe.com/dRm7sN2on3yF26FbYEdIA01",
      PAYPAL_CHECKOUT_URL: "https://www.paypal.com/ncp/payment/FR755FQZHEGQA"
    };

    // ========== STATE MANAGEMENT ==========
    let currentFile = '';
    let currentChapter = 0;
    let scrollInterval = null;
    let isMobile = window.innerWidth <= 768;
    let isTrackingScroll = false;
    let lastScrollPosition = 0;

    // ========== PROGRESS TRACKING SYSTEM ==========
    class ProgressTracker {
      constructor() {
        this.data = this.loadProgressData();
      }

      loadProgressData() {
        try {
          const saved = localStorage.getItem('infinityLoopProgress');
          if (saved) {
            const data = JSON.parse(saved);
            // Validate data structure
            if (data.completedChapters && data.chapterProgress) {
              return data;
            }
          }
        } catch (e) {
          console.error('Error loading progress:', e);
        }
        
        // Default structure
        return {
          completedChapters: [],
          chapterProgress: {},
          lastReadPositions: {},
          totalTimeSpent: 0,
          sessionStartTime: null,
          lastUpdated: new Date().toISOString()
        };
      }

      saveProgressData() {
        try {
          this.data.lastUpdated = new Date().toISOString();
          localStorage.setItem('infinityLoopProgress', JSON.stringify(this.data));
          return true;
        } catch (e) {
          console.error('Error saving progress:', e);
          return false;
        }
      }

      updateChapterProgress(chapterNum, percentage) {
        if (chapterNum < 1 || chapterNum > 11) return;
        
        const prevProgress = this.data.chapterProgress[chapterNum] || 0;
        const newProgress = Math.max(prevProgress, Math.min(100, Math.round(percentage)));
        
        this.data.chapterProgress[chapterNum] = newProgress;
        
        // Mark as completed if >= 85% (more forgiving)
        if (newProgress >= 85 && !this.data.completedChapters.includes(chapterNum)) {
          this.data.completedChapters.push(chapterNum);
          this.data.completedChapters.sort((a, b) => a - b);
        }
        
        this.saveProgressData();
        return newProgress;
      }

      getChapterProgress(chapterNum) {
        return this.data.chapterProgress[chapterNum] || 0;
      }

      getOverallProgress(maxChapters) {
        const completed = this.data.completedChapters.filter(ch => ch <= maxChapters).length;
        const percentage = maxChapters > 0 ? Math.round((completed / maxChapters) * 100) : 0;
        return {
          completed,
          total: maxChapters,
          percentage: percentage
        };
      }

      resetProgress() {
        this.data = {
          completedChapters: [],
          chapterProgress: {},
          lastReadPositions: {},
          totalTimeSpent: this.data.totalTimeSpent || 0,
          sessionStartTime: null,
          lastUpdated: new Date().toISOString()
        };
        this.saveProgressData();
        return true;
      }

      saveLastPosition(chapterNum, position) {
        this.data.lastReadPositions[chapterNum] = {
          position,
          timestamp: new Date().toISOString()
        };
        this.saveProgressData();
      }

      getLastPosition(chapterNum) {
        return this.data.lastReadPositions[chapterNum];
      }

      startSession() {
        if (!this.data.sessionStartTime) {
          this.data.sessionStartTime = new Date().toISOString();
          this.saveProgressData();
        }
      }

      endSession() {
        if (this.data.sessionStartTime) {
          const startTime = new Date(this.data.sessionStartTime);
          const endTime = new Date();
          const sessionDuration = endTime - startTime;
          
          this.data.totalTimeSpent = (this.data.totalTimeSpent || 0) + sessionDuration;
          this.data.sessionStartTime = null;
          this.saveProgressData();
        }
      }
    }

    // ========== LICENSE MANAGER ==========
    class LicenseManager {
      constructor() {
        this.deviceId = this.getDeviceId();
        this.userData = this.loadUserData();
        this.licenseData = this.loadLicenseData();
        this.trialData = this.loadTrialData();
      }

      getDeviceId() {
        let deviceId = localStorage.getItem('infinityLoopDeviceId');
        if (!deviceId) {
          // Generate a more stable device ID
          const timestamp = Date.now().toString(36);
          const random = Math.random().toString(36).substring(2, 10);
          deviceId = `DEV-${timestamp}-${random}`.toUpperCase();
          localStorage.setItem('infinityLoopDeviceId', deviceId);
        }
        return deviceId;
      }

      loadUserData() {
        try {
          const data = localStorage.getItem('infinityLoopUser');
          return data ? JSON.parse(data) : null;
        } catch {
          return null;
        }
      }

      loadLicenseData() {
        try {
          const data = localStorage.getItem('infinityLoopLicense');
          if (!data) return null;
          
          const license = JSON.parse(data);
          if (license.expiry && new Date(license.expiry) < new Date()) {
            localStorage.removeItem('infinityLoopLicense');
            return null;
          }
          
          return license;
        } catch {
          return null;
        }
      }

      loadTrialData() {
        try {
          const data = localStorage.getItem('infinityLoopTrial');
          if (!data) return null;
          
          const trial = JSON.parse(data);
          if (trial.expiry && new Date(trial.expiry) < new Date()) {
            localStorage.removeItem('infinityLoopTrial');
            return null;
          }
          
          return trial;
        } catch {
          return null;
        }
      }

      saveUser(email, name = '') {
        const userData = {
          email: email.trim(),
          name: name.trim() || '',
          registered: new Date().toISOString(),
          deviceId: this.deviceId
        };
        localStorage.setItem('infinityLoopUser', JSON.stringify(userData));
        this.userData = userData;
        return userData;
      }

      startTrial(email, name = '') {
        const trialData = {
          email: email.trim(),
          name: name.trim() || '',
          startDate: new Date().toISOString(),
          expiry: new Date(Date.now() + CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000).toISOString(),
          chaptersAllowed: CONFIG.TRIAL_CHAPTERS,
          deviceId: this.deviceId
        };
        localStorage.setItem('infinityLoopTrial', JSON.stringify(trialData));
        this.trialData = trialData;
        return trialData;
      }

      activateLicense(licenseKey, email) {
        licenseKey = licenseKey.trim().toUpperCase();
        
        if (!licenseKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) && licenseKey !== CONFIG.TEST_LICENSE) {
          throw new Error('Invalid license key format. License must start with "INF-"');
        }

        const licenseData = {
          key: licenseKey,
          email: email || this.userData?.email,
          activated: new Date().toISOString(),
          expiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
          deviceId: this.deviceId
        };

        localStorage.setItem('infinityLoopLicense', JSON.stringify(licenseData));
        this.licenseData = licenseData;
        localStorage.removeItem('infinityLoopTrial');
        this.trialData = null;

        return licenseData;
      }

      hasActiveLicense() {
        return !!this.licenseData;
      }

      hasActiveTrial() {
        if (!this.trialData) return false;
        const expiry = new Date(this.trialData.expiry);
        return expiry > new Date();
      }

      canAccessChapter(chapterNumber) {
        if (chapterNumber === 0) return true; // Front/back matter always accessible
        if (this.hasActiveLicense()) return true;
        if (this.hasActiveTrial()) return chapterNumber <= CONFIG.TRIAL_CHAPTERS;
        return false;
      }

      getUserEmail() {
        if (this.licenseData?.email) return this.licenseData.email;
        if (this.trialData?.email) return this.trialData.email;
        if (this.userData?.email) return this.userData.email;
        return '';
      }

      getUserName() {
        if (this.licenseData?.name) return this.licenseData.name;
        if (this.trialData?.name) return this.trialData.name;
        if (this.userData?.name) return this.userData.name;
        return '';
      }

      getAccessType() {
        if (this.hasActiveLicense()) return 'full';
        if (this.hasActiveTrial()) return 'trial';
        return 'none';
      }

      getRemainingTrialDays() {
        if (!this.trialData?.expiry) return 0;
        const expiry = new Date(this.trialData.expiry);
        const now = new Date();
        const diffTime = expiry - now;
        return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
      }

      clearAllData() {
        localStorage.removeItem('infinityLoopUser');
        localStorage.removeItem('infinityLoopLicense');
        localStorage.removeItem('infinityLoopTrial');
        this.userData = null;
        this.licenseData = null;
        this.trialData = null;
      }
    }

    // ========== DOM ELEMENTS ==========
    const splashEntrance = document.getElementById('splashEntrance');
    const emailModal = document.getElementById('emailModal');
    const licenseModal = document.getElementById('licenseModal');
    const appShell = document.getElementById('app-shell');
    const iframe = document.getElementById('reader-frame');
    const currentLabel = document.getElementById('current-label');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Progress elements
    const overallFill = document.getElementById('overall-progress-fill');
    const overallLabel = document.getElementById('overall-progress-label');
    const chapterFill = document.getElementById('chapter-progress-fill');
    const chapterLabel = document.getElementById('chapter-progress-label');

    // Badges
    const trialBadge = document.getElementById('trialBadge');
    const fullBadge = document.getElementById('fullBadge');

    // ========== INITIALIZE SYSTEMS ==========
    const progressTracker = new ProgressTracker();
    const licenseManager = new LicenseManager();

    // ========== BOOK STRUCTURE ==========
    const BOOK_STRUCTURE = {
      frontMatter: [
        { file: 'TITLE_PAGE.htm', label: 'Title Page', alwaysAccessible: true },
        { file: 'Dedication.htm', label: 'Dedication', alwaysAccessible: true },
        { file: 'Epigraph_.htm', label: 'Epigraph', alwaysAccessible: true },
        { file: 'CONTENT_WARNING_.htm', label: 'Content Warning / Reader Care Note', alwaysAccessible: true },
        { file: 'A_NOTE_ON_LANGUAGE_AND_TERMINOLOGY.htm', label: 'Note on Language and Terminology', alwaysAccessible: true },
        { file: 'HOW_TO_USE_THIS_BOOK_A_READER\'S_GUIDE_.htm', label: 'How to Use This Book: A Reader\'s Guide', alwaysAccessible: true },
        { file: 'AUTHOR\'S_PREFACE_UNDERSTANDING_THE_INFINITY_LOOP_.htm', label: 'Author\'s Preface: Understanding the Infinity Loop', alwaysAccessible: true },
        { file: 'NOTE_ON_SOURCES_AND_METHODOLOGY_.htm', label: 'Note on Sources and Methodology', alwaysAccessible: true }
      ],
      
      chapters: [
        { file: 'CHAPTER_1_clean_stitched_formatted.htm', label: 'CHAPTER 1: THE GENESIS: RECONSTRUCTION AND THE BLACK CODES', badge: '(1865 - 1877) LoopSnapshotðŸŸ¡6/10' },
        { file: 'CHAPTER_2_clean_stitched_formatted.htm', label: 'CHAPTER 2: THE REFINEMENT: JIM CROW AND THE RISE OF LEGALIZED APARTHEID', badge: '(1877 - 1919) LoopSnapshotðŸŸ¢8/10' },
        { file: 'CHAPTER_3_clean_stitched_formatted.htm', label: 'CHAPTER 3: MOBILIZATION AND BACKLASH: RED SUMMER, GARVEY, AND THE PROTO-COINTELPRO', badge: '(1919 - 1945) LoopSnapshotðŸ”´8/10' },
        { file: 'CHAPTER_4_clean_stitched_formatted.htm', label: 'CHAPTER 4: COLD WAR CONTRADICTIONS: VETERANS, MCGEE, AND "GENOCIDE"', badge: '(1946 - 1955) LoopSnapshotðŸ”´8/10' },
        { file: 'CHAPTER_5_clean_stitched_formatted.htm', label: 'CHAPTER 5: COINTELPRO PEAK: NEUTRALIZATION, KERNER, AND THE PANTHER\'S PRICE', badge: '(1956 - 1971) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_6_clean_stitched_formatted.htm', label: 'CHAPTER 6: THE MODERN CARCERAL STATE: THE WAR ON DRUGS ESCALATES', badge: '(1972 - 1989) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_7_clean_stitched_formatted.htm', label: 'CHAPTER 7: THE "COLORBLIND" ERA: PREDICTIVE POLICING AND MASS INCARCERATION', badge: '(1990 - 2009) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_8_clean_stitched_formatted.htm', label: 'CHAPTER 8: DIGITAL AUGMENTATION: FERGUSON, BALTIMORE, AND ALGORITHMIC BIAS', badge: '(2010 - 2016) LoopSnapshotðŸ”´9/10' },
        { file: 'CHAPTER_9_clean_stitched_formatted.htm', label: 'CHAPTER 9: THE AUTOMATED LOOP: BIE LABELS, AI, AND THE FUTURE OF CONTROL', badge: '(2017 - 2024) LoopSnapshotðŸ”´ðŸŸ¡ðŸŸ¢10/10' },
        { file: 'CHAPTER_10_clean_stitched_formatted.htm', label: 'CHAPTER 10: THE RESILIENCE BLUEPRINT: RESISTANCE AND THRIVING WITHIN THE LOOP', badge: '(1619 - Present) LoopSnapshotðŸŸ¢8/10' },
        { file: 'CHAPTER_11_clean_stitched_formatted.htm', label: 'CHAPTER 11: THE ABOLITION HORIZON: FROM EVIDENCE TO ABOLITION', badge: '2025 AND BEYOND LoopSnapshotðŸ”´10/10' }
      ],
      
      backMatter: [
        { file: 'APPENDIX_A_LOOP MECHANISM GLOSSARY_.htm', label: 'Appendix A: Loop Mechanism Glossary', alwaysAccessible: true },
        { file: 'APPENDIX_B_HISTORICAL TIMELINE (1619-2025)_.htm', label: 'Appendix B: Historical Timeline (1619â€“2025)', alwaysAccessible: true },
        { file: 'APPENDIX_C_METHODOLOGY AND SOURCES NOTE_.htm', label: 'Appendix C: Methodology and Sources Note', alwaysAccessible: true },
        { file: 'WORKS CITED.htm', label: 'Works Cited', alwaysAccessible: true },
        { file: 'Tiered_Works_Cited.htm', label: 'Tiered Works Cited (by tier)', alwaysAccessible: true },
        { file: 'CONSOLIDATED_WORKS_CITED.htm', label: 'Consolidated Works Cited (master list)', alwaysAccessible: true },
        { file: 'ACKNOWLEDGMENTS_.htm', label: 'Acknowledgments', alwaysAccessible: true },
        { file: 'ABOUT_THE_AUTHOR.htm', label: 'About the Author', alwaysAccessible: true }
      ]
    };

    // ========== HELPER FUNCTIONS ==========
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function formatLicenseKey(key) {
      if (!key) return '';
      key = key.toUpperCase().trim();
      // Remove any non-alphanumeric characters except dash
      key = key.replace(/[^A-Z0-9-]/g, '');
      return key;
    }

    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    /**
     * Send event data to Make.com webhook
     */
    function sendToMake(eventType, data = {}) {
      if (!CONFIG.MAKE_WEBHOOK_URL) return;

      const basePayload = {
        event: eventType,
        source: 'infinity-loop-reader',
        appVersion: CONFIG.APP_VERSION,
        deviceId: licenseManager.deviceId,
        timestamp: new Date().toISOString()
      };

      const payload = { ...basePayload, ...data };

      fetch(CONFIG.MAKE_WEBHOOK_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      }).catch(err => {
        console.error('Make webhook error:', err);
      });
    }

    // ========== PROGRESS DISPLAY FUNCTIONS ==========
    function updateProgressDisplay() {
      const maxChapters = licenseManager.hasActiveLicense() ? 11 : CONFIG.TRIAL_CHAPTERS;
      const overall = progressTracker.getOverallProgress(maxChapters);
      
      // Update overall progress
      overallFill.style.width = overall.percentage + '%';
      overallLabel.textContent = `${overall.completed} / ${overall.total}`;
      
      // Update chapter progress if a chapter is open
      if (currentChapter > 0) {
        const chapterProgress = progressTracker.getChapterProgress(currentChapter);
        chapterFill.style.width = chapterProgress + '%';
        chapterLabel.textContent = chapterProgress + '%';
        
        // Add animation on change
        chapterFill.classList.add('animating');
        setTimeout(() => {
          chapterFill.classList.remove('animating');
        }, 1000);
      } else {
        chapterFill.style.width = '0%';
        chapterLabel.textContent = '0%';
      }
    }

    // ========== SCROLL TRACKING ==========
    function calculateScrollPercentage() {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (!iframeDoc || !iframeDoc.documentElement) return 0;
        
        const scrollTop = iframeDoc.documentElement.scrollTop || iframeDoc.body.scrollTop || 0;
        const scrollHeight = iframeDoc.documentElement.scrollHeight || iframeDoc.body.scrollHeight || 1;
        const clientHeight = iframeDoc.documentElement.clientHeight || iframeDoc.body.clientHeight || 1;
        
        const maxScroll = Math.max(scrollHeight - clientHeight, 1);
        const percentage = Math.round((scrollTop / maxScroll) * 100);
        
        return isNaN(percentage) ? 0 : percentage;
      } catch (e) {
        return 0;
      }
    }

    function startScrollTracking() {
      stopScrollTracking();
      
      scrollInterval = setInterval(() => {
        if (currentChapter > 0) {
          const percentage = calculateScrollPercentage();
          if (percentage > 0) {
            const newProgress = progressTracker.updateChapterProgress(currentChapter, percentage);
            if (newProgress !== lastScrollPosition) {
              lastScrollPosition = newProgress;
              updateProgressDisplay();
            }
          }
        }
      }, 1000); // Check every second
      
      isTrackingScroll = true;
    }

    function stopScrollTracking() {
      if (scrollInterval) {
        clearInterval(scrollInterval);
        scrollInterval = null;
      }
      isTrackingScroll = false;
    }

    // ========== NAVIGATION FUNCTIONS ==========
    function loadNavigation() {
      const frontMatterList = document.getElementById('frontMatterList');
      const chapterList = document.getElementById('chapterList');
      const backMatterList = document.getElementById('backMatterList');
      
      // Clear existing lists
      frontMatterList.innerHTML = '';
      chapterList.innerHTML = '';
      backMatterList.innerHTML = '';
      
      // Load Front Matter
      BOOK_STRUCTURE.frontMatter.forEach(item => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        button.textContent = item.label;
        button.addEventListener('click', () => openSection(item.file, item.label, 0));
        li.appendChild(button);
        frontMatterList.appendChild(li);
      });
      
      // Load Chapters
      BOOK_STRUCTURE.chapters.forEach((chapter, index) => {
        const chapterNum = index + 1;
        const canAccess = licenseManager.canAccessChapter(chapterNum);
        const progress = progressTracker.getChapterProgress(chapterNum);
        const isCompleted = progress >= 85;
        
        const li = document.createElement('li');
        li.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        
        // Create label with badge
        const labelSpan = document.createElement('span');
        labelSpan.textContent = chapter.label.split('LoopSnapshot')[0].trim();
        button.appendChild(labelSpan);
        
        if (!canAccess) {
          button.disabled = true;
          button.style.opacity = '0.5';
          button.title = 'Upgrade to full version to access this chapter';
        }
        
        // Add completion indicator
        if (isCompleted && canAccess) {
          const checkmark = document.createElement('span');
          checkmark.className = 'completion-check';
          checkmark.textContent = 'âœ“';
          checkmark.style.marginLeft = 'auto';
          button.appendChild(checkmark);
        }
        
        button.addEventListener('click', () => {
          if (!canAccess) {
            showLicenseModal();
            return;
          }
          openSection(chapter.file, chapter.label, chapterNum);
        });
        
        li.appendChild(button);
        chapterList.appendChild(li);
      });
      
      // Load Back Matter
      BOOK_STRUCTURE.backMatter.forEach(item => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const button = document.createElement('button');
        button.className = 'nav-link';
        button.textContent = item.label;
        button.addEventListener('click', () => openSection(item.file, item.label, 0));
        li.appendChild(button);
        backMatterList.appendChild(li);
      });
      
      updateAccessUI();
    }

    function updateAccessUI() {
      const accessType = licenseManager.getAccessType();
      const licenseTypeDisplay = document.getElementById('licenseTypeDisplay');
      const chapterLimit = document.getElementById('chapterLimit');
      const licenseStatus = document.getElementById('licenseStatus');
      const activateBtn = document.getElementById('activateBtn');
      
      if (accessType === 'full') {
        licenseTypeDisplay.textContent = 'Full Version â€¢ 11/11 Chapters';
        if (trialBadge) trialBadge.style.display = 'none';
        if (fullBadge) fullBadge.style.display = 'inline-block';
        chapterLimit.textContent = '(11/11)';
        licenseStatus.textContent = 'Full Version';
        activateBtn.textContent = 'License Active';
        activateBtn.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
        activateBtn.style.color = 'white';
        activateBtn.style.borderColor = '#10b981';
      } else if (accessType === 'trial') {
        const remainingDays = licenseManager.getRemainingTrialDays();
        licenseTypeDisplay.textContent = `Trial Version â€¢ ${CONFIG.TRIAL_CHAPTERS}/11 Chapters â€¢ ${remainingDays} days left`;
        if (trialBadge) trialBadge.style.display = 'inline-block';
        if (fullBadge) fullBadge.style.display = 'none';
        chapterLimit.textContent = `(${CONFIG.TRIAL_CHAPTERS}/11)`;
        licenseStatus.textContent = `Trial Active â€¢ ${remainingDays} days left`;
        activateBtn.textContent = 'Activate License';
        activateBtn.style.background = 'var(--accent-soft)';
        activateBtn.style.color = 'var(--accent)';
        activateBtn.style.borderColor = 'var(--accent)';
      } else {
        licenseTypeDisplay.textContent = 'No Access';
        if (trialBadge) trialBadge.style.display = 'none';
        if (fullBadge) fullBadge.style.display = 'none';
        chapterLimit.textContent = '(0/11)';
        licenseStatus.textContent = 'No Access';
        activateBtn.textContent = 'Get Access';
        activateBtn.style.background = 'var(--accent-soft)';
        activateBtn.style.color = 'var(--accent)';
        activateBtn.style.borderColor = 'var(--accent)';
      }
    }

    function openSection(file, label, chapterNum = 0) {
      if (!file) return;
      
      stopScrollTracking();
      currentFile = file;
      currentChapter = chapterNum;
      
      showLoading();
      
      // Load content
      iframe.src = file;
      currentLabel.textContent = label.split('LoopSnapshot')[0].trim();
      
      // Update active nav
      document.querySelectorAll('.nav-link').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Find and activate the correct nav button
      const navLinks = document.querySelectorAll('.nav-link');
      for (const btn of navLinks) {
        const btnText = btn.textContent.replace('âœ“', '').trim();
        const labelText = label.split('LoopSnapshot')[0].trim();
        
        if (btnText === labelText || btnText.includes(labelText.substring(0, 30))) {
          btn.classList.add('active');
          
          // Expand the section if collapsed
          const section = btn.closest('.nav-section');
          if (section && section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
          }
          break;
        }
      }
      
      // Update progress display
      updateProgressDisplay();
      
      // Handle iframe load
      iframe.onload = function() {
        hideLoading();
        
        if (chapterNum > 0) {
          // Restore scroll position if available
          const lastPos = progressTracker.getLastPosition(chapterNum);
          if (lastPos && lastPos.position > 0) {
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
              setTimeout(() => {
                iframeDoc.documentElement.scrollTop = lastPos.position;
              }, 100);
            } catch (e) {
              console.log('Could not restore scroll position:', e.message);
            }
          }
          
          // Start tracking scroll
          setTimeout(() => {
            startScrollTracking();
          }, 500);
        }
      };
      
      iframe.onerror = function() {
        hideLoading();
        alert(`Error loading "${label}". Please check if the file "${file}" exists.`);
      };
    }

    // ========== UI FLOW FUNCTIONS ==========
    function showEmailModal() {
      splashEntrance.style.display = 'none';
      emailModal.style.display = 'flex';
      setTimeout(() => {
        const trialNameInput = document.getElementById('trialName');
        const trialEmailInput = document.getElementById('trialEmail');
        if (trialNameInput && trialNameInput.value === '') {
          trialNameInput.focus();
        } else {
          trialEmailInput.focus();
        }
      }, 100);
    }

    function showLicenseModal() {
      emailModal.style.display = 'none';
      licenseModal.style.display = 'flex';
      setTimeout(() => {
        document.getElementById('licenseInput').focus();
      }, 100);
    }

    function showApp() {
      splashEntrance.style.display = 'none';
      emailModal.style.display = 'none';
      licenseModal.style.display = 'none';
      appShell.style.display = 'flex';
      
      // Start progress tracking session
      progressTracker.startSession();
      
      // Load navigation and open first accessible content
      loadNavigation();
      updateProgressDisplay();
      
      // Start with Title Page or first accessible chapter
      openSection('TITLE_PAGE.htm', 'Title Page', 0);
    }

    function startAppWithTrial(email, name = '') {
      if (!validateEmail(email)) {
        showMessage('emailMessage', 'Please enter a valid email address.', 'error');
        return;
      }
      
      const agreeTerms = document.getElementById('agreeTerms');
      if (!agreeTerms || !agreeTerms.checked) {
        showMessage('emailMessage', 'You must agree to the Terms of Service to continue.', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('startTrialWithEmail');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Setting up trial...';
      
      // Save user and start trial
      licenseManager.saveUser(email, name);
      licenseManager.startTrial(email, name);
      
      // Send trial signup to Make
      sendToMake('trial_signup', {
        email: email,
        name: name,
        accessType: 'trial'
      });
      
      showMessage('emailMessage', 'Success! Starting your trial...', 'success');
      
      setTimeout(() => {
        showApp();
        showMessage('emailMessage', '', 'success', false);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Start Free Trial (2 Chapters)';
      }, 1500);
    }

    function startAppWithLicense(licenseKey) {
      licenseKey = formatLicenseKey(licenseKey);
      
      if (!licenseKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) && licenseKey !== CONFIG.TEST_LICENSE) {
        showMessage('licenseMessage', 'Invalid license key format. License must start with "INF-"', 'error');
        return;
      }
      
      const existingEmail = licenseManager.getUserEmail();
      let email = existingEmail;
      
      if (!email) {
        email = prompt('Enter your email for license activation:');
        if (!email || !validateEmail(email)) {
          showMessage('licenseMessage', 'Please enter a valid email address.', 'error');
          return;
        }
      }
      
      const name = licenseManager.getUserName();
      const licenseKeyLast4 = licenseKey.slice(-4);
      
      try {
        // Activate license locally
        licenseManager.activateLicense(licenseKey, email);
        
        // Send license activation event to Make
        sendToMake('license_activation', {
          email: email,
          name: name,
          licenseKeyLast4: licenseKeyLast4,
          licenseKey: licenseKey,
          accessType: 'license'
        });
        
        showMessage('licenseMessage', 'License activated successfully!', 'success');
        
        setTimeout(() => {
          showApp();
          showMessage('licenseMessage', '', 'success', false);
        }, 1500);
      } catch (error) {
        showMessage('licenseMessage', 'Error: ' + error.message, 'error');
      }
    }

    function checkExistingAccess() {
      const accessType = licenseManager.getAccessType();
      const email = licenseManager.getUserEmail();
      
      if (accessType === 'none' || !email) {
        splashEntrance.style.opacity = '0';
        splashEntrance.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          splashEntrance.style.display = 'none';
          showEmailModal();
        }, 500);
      } else {
        splashEntrance.style.opacity = '0';
        splashEntrance.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          splashEntrance.style.display = 'none';
          showApp();
        }, 500);
      }
    }

    function showMessage(elementId, text, type = 'info', show = true) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      element.textContent = text;
      element.className = 'message';
      
      if (show) {
        element.classList.add(type);
        element.classList.add('show');
      } else {
        element.classList.remove('show');
      }
    }

    // ========== EVENT LISTENERS SETUP ==========
    function setupEventListeners() {
      // Entrance page
      document.getElementById('enterBookBtn').addEventListener('click', () => {
        splashEntrance.style.opacity = '0';
        splashEntrance.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          splashEntrance.style.display = 'none';
          checkExistingAccess();
        }, 500);
      });

      document.getElementById('bookCover').addEventListener('click', () => {
        document.getElementById('enterBookBtn').click();
      });

      // Email form
      document.getElementById('emailForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const email = document.getElementById('trialEmail').value.trim();
        const name = (document.getElementById('trialName')?.value || '').trim();
        
        startAppWithTrial(email, name);
      });

      document.getElementById('trialEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const email = document.getElementById('trialEmail').value.trim();
          const name = (document.getElementById('trialName')?.value || '').trim();
          startAppWithTrial(email, name);
        }
      });

      // License activation
      document.getElementById('activateLicense').addEventListener('click', () => {
        const licenseKey = document.getElementById('licenseInput').value.trim();
        startAppWithLicense(licenseKey);
      });

      document.getElementById('licenseInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const licenseKey = document.getElementById('licenseInput').value.trim();
          startAppWithLicense(licenseKey);
        }
      });

      // Purchase buttons
      document.getElementById('purchaseStripe').addEventListener('click', (e) => {
        e.preventDefault();
        const confirmed = confirm('You will be redirected to our secure Stripe checkout page. Continue?');
        if (confirmed) {
          window.open(CONFIG.STRIPE_CHECKOUT_URL, '_blank');
        }
      });

      document.getElementById('purchasePaypal').addEventListener('click', (e) => {
        e.preventDefault();
        const confirmed = confirm('You will be redirected to our secure PayPal checkout page. Continue?');
        if (confirmed) {
          window.open(CONFIG.PAYPAL_CHECKOUT_URL, '_blank');
        }
      });

      // Modal switches
      document.getElementById('switchToLicense').addEventListener('click', (e) => {
        e.preventDefault();
        showLicenseModal();
      });

      document.getElementById('activateBtn').addEventListener('click', showLicenseModal);

      // Reset progress
      document.getElementById('progress-reset').addEventListener('click', () => {
        if (confirm('Are you sure you want to reset all reading progress? This cannot be undone.')) {
          progressTracker.resetProgress();
          updateProgressDisplay();
          alert('All progress has been reset.');
        }
      });

      // Navigation toggles
      document.querySelectorAll('.nav-section-title').forEach(title => {
        title.addEventListener('click', (e) => {
          const section = e.target.closest('.nav-section');
          section.classList.toggle('collapsed');
        });
      });

      // Collapse all sections by default
      document.querySelectorAll('.nav-section').forEach(section => {
        section.classList.add('collapsed');
      });

      // Save progress on unload
      window.addEventListener('beforeunload', () => {
        stopScrollTracking();
        progressTracker.endSession();
        progressTracker.saveProgressData();
      });

      // Auto-save progress every 30 seconds
      setInterval(() => {
        progressTracker.saveProgressData();
      }, 30000);

      // Handle window resize
      window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
      });

      // Handle iframe scroll events for real-time tracking
      iframe.addEventListener('load', () => {
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          iframeDoc.addEventListener('scroll', () => {
            if (currentChapter > 0) {
              const percentage = calculateScrollPercentage();
              if (percentage > 0) {
                progressTracker.updateChapterProgress(currentChapter, percentage);
                updateProgressDisplay();
              }
            }
          });
        } catch (e) {
          // Cross-origin error
        }
      });
    }

    // ========== INITIALIZATION ==========
    function init() {
      setupEventListeners();
      splashEntrance.style.display = 'flex';
      
      // Auto-focus on book cover for better UX
      setTimeout(() => {
        document.getElementById('bookCover')?.focus();
      }, 100);
      
      // Development mode logging
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('Development mode active');
        console.log('Test license:', CONFIG.TEST_LICENSE);
        console.log('Device ID:', licenseManager.deviceId);
        console.log('Current access:', licenseManager.getAccessType());
        
        // Set test license as placeholder
        const licenseInput = document.getElementById('licenseInput');
        if (licenseInput) {
          licenseInput.placeholder = CONFIG.TEST_LICENSE;
        }
      }
    }

    // Start the application
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Debug utilities (remove in production)
    window.debug = {
      progress: progressTracker,
      license: licenseManager,
      reload: () => location.reload(),
      clearAll: () => {
        localStorage.clear();
        location.reload();
      },
      simulateProgress: (chapter, percentage) => {
        progressTracker.updateChapterProgress(chapter, percentage);
        updateProgressDisplay();
        console.log(`Set chapter ${chapter} to ${percentage}%`);
      }
    };
  </script>
</body>
</html>