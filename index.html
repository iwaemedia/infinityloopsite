<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Infinity Loop Reader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="description" content="Interactive reader for The Infinity Loop - Mapping the Machinery of Power, Policy, and Profit" />
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #050608;
            --bg-elevated: #10131a;
            --bg-elevated-soft: #141926;
            --accent: #e63946;
            --accent-soft: rgba(230, 57, 70, 0.1);
            --accent-strong: #ff6b6b;
            --accent-glow: 0 0 24px rgba(230, 57, 70, 0.7);
            --accent-alt: #06b6d4;
            --accent-alt-soft: rgba(56, 189, 248, 0.1);
            --accent-alt-glow: 0 0 24px rgba(56, 189, 248, 0.7);
            --text: #f9fafb;
            --text-muted: #9ca3af;
            --text-soft: #6b7280;
            --border-subtle: #1f2933;
            --border-strong: #374151;
            --card-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
            --radius-lg: 26px;
            --radius-md: 18px;
            --radius-sm: 12px;
            --radius-pill: 999px;
            --transition-fast: 0.18s ease-out;
            --transition-med: 0.28s ease;
            --gradient-main: linear-gradient(135deg, #e63946, #fbbf24);
            --gradient-alt: linear-gradient(135deg, #22c55e, #0ea5e9);
            --nav-width: 340px;
            --warning: #f97316;
            --warning-soft: rgba(249, 115, 22, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #111827 0, #020617 50%, #000 100%);
            color: var(--text);
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        /* ========== SPLASH ENTRANCE ========== */
        #splashEntrance {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
            z-index: 40;
        }

        #splashEntrance.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .splash-inner {
            display: grid;
            grid-template-columns: minmax(0, 1.02fr) minmax(0, 1.4fr);
            gap: 40px;
            max-width: 1200px;
            width: 100%;
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
                radial-gradient(circle at bottom right, rgba(239, 68, 68, 0.12), transparent 55%), #020617;
            border-radius: 32px;
            padding: 32px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.85);
        }

        .splash-left {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .book-cover-wrapper {
            position: relative;
            border-radius: 28px;
            padding: 6px;
            background: radial-gradient(circle at top, rgba(251, 191, 36, 0.65), rgba(56, 189, 248, 0.2));
            box-shadow: 0 35px 80px rgba(0, 0, 0, 0.85);
        }

        .book-cover-outline {
            position: absolute;
            inset: -18px;
            border-radius: 36px;
            border: 1px solid rgba(248, 250, 252, 0.12);
            opacity: 0.8;
            pointer-events: none;
        }

        .book-cover-glow {
            position: absolute;
            inset: -24px;
            border-radius: 40px;
            background: radial-gradient(circle at top, rgba(251, 191, 36, 0.4), transparent 60%);
            filter: blur(16px);
            opacity: 0.7;
            pointer-events: none;
        }

        .book-cover {
            display: block;
            width: 100%;
            max-width: 360px;
            border-radius: 22px;
            cursor: pointer;
            object-fit: cover;
        }

        .cover-reflection {
            position: absolute;
            inset: 0;
            border-radius: 22px;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.18), transparent 55%);
            mix-blend-mode: screen;
            pointer-events: none;
        }

        .splash-right {
            display: flex;
            flex-direction: column;
            gap: 24px;
            justify-content: center;
        }

        .splash-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: var(--radius-pill);
            padding: 4px 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            width: fit-content;
        }

        .splash-pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
        }

        .splash-pill-text {
            font-size: 0.8rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-soft);
        }

        .splash-title {
            font-family: "Crimson Pro", Georgia, "Times New Roman", serif;
            font-size: 3rem;
            color: var(--text);
            margin: 4px 0;
        }

        .splash-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            max-width: 620px;
        }

        .splash-highlight {
            color: #fbbf24;
            font-weight: 600;
        }

        .splash-bullets {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .splash-bullet {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .bullet-icon {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .bullet-icon.primary {
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
        }

        .bullet-icon.secondary {
            background: rgba(248, 250, 252, 0.06);
            color: #fbbf24;
        }

        .bullet-body {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .bullet-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .bullet-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .splash-cta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .btn-primary {
            border-radius: var(--radius-pill);
            border: none;
            padding: 14px 28px;
            font-size: 0.98rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f97316, #e11d48, #6366f1);
            color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
        }

        .btn-primary span {
            position: relative;
            z-index: 1;
        }

        .btn-primary::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.25), transparent 60%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.8);
        }

        .btn-secondary-outline {
            border-radius: var(--radius-pill);
            padding: 12px 22px;
            background: rgba(15, 23, 42, 0.9);
            color: var(--text);
            border: 1px solid rgba(148, 163, 184, 0.5);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-secondary-outline:hover {
            background: rgba(15, 23, 42, 1);
            border-color: rgba(248, 250, 252, 0.8);
        }

        .splash-disclaimer {
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--text-soft);
        }

        .splash-disclaimer a {
            color: #e5e7eb;
        }

        .splash-disclaimer a:hover {
            text-decoration: underline;
        }

        /* Trial card */
        .trial-card {
            margin-top: 14px;
            padding: 13px 16px;
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(244, 63, 94, 0.15), transparent 60%),
                radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.15), transparent 60%), rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .trial-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .trial-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #e5e7eb;
        }

        .trial-card-badge {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(22, 163, 74, 0.2);
            color: #bbf7d0;
            font-size: 0.75rem;
            border: 1px solid rgba(74, 222, 128, 0.6);
        }

        .trial-card-body {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* ========== EMAIL MODAL ========== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal {
            width: 100%;
            max-width: 460px;
            background: radial-gradient(circle at top, rgba(56, 189, 248, 0.12), transparent 55%), #020617;
            border-radius: 28px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 26px 26px 26px;
            box-shadow: 0 22px 60px rgba(0, 0, 0, 0.85);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 30px;
            height: 30px;
            border-radius: 999px;
            border: none;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .modal h2 {
            margin: 0 0 6px;
            font-size: 1.4rem;
        }

        .modal p {
            margin: 0 0 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .modal-highlight {
            color: #fbbf24;
            font-weight: 600;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }

        .input-group label {
            font-size: 0.85rem;
            color: var(--text-soft);
        }

        .input-group input {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.95);
            color: var(--text);
            font-size: 0.95rem;
        }

        .input-group input::placeholder {
            color: rgba(148, 163, 184, 0.7);
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 9px;
            margin-bottom: 12px;
            font-size: 0.83rem;
        }

        .checkbox-group input {
            margin-top: 3px;
            transform: scale(1.08);
        }

        .checkbox-group a {
            color: #e5e7eb;
        }

        .checkbox-group a:hover {
            text-decoration: underline;
        }

        .small-text {
            font-size: 0.8rem;
            color: var(--text-soft);
            margin-top: 8px;
        }

        .small-text a {
            color: #e5e7eb;
        }

        /* Purchase buttons inside license modal */
        .purchase-options {
            display: flex;
            gap: 12px;
            margin: 16px 0 4px;
        }

        .purchase-options button {
            flex: 1;
            padding: 11px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: #0b1120;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        #purchaseStripe {
            background: linear-gradient(135deg, #635bff, #5433ff);
            color: white;
        }

        #purchasePaypal {
            background: linear-gradient(135deg, #ffc439, #ffb42b);
            color: #003087;
        }

        .purchase-options button:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.6);
        }

        /* ========== APP SHELL ========== */
        #app-shell {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            background: linear-gradient(to bottom, #020617, #020617);
            border-radius: 0;
            overflow: hidden;
        }

        /* HEADER */
        .app-header {
            background: #020617;
            border-bottom: 1px solid rgba(15, 23, 42, 0.95);
            padding: 14px 26px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
            color: #e5e7eb;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .current-label {
            font-family: "Crimson Pro", "Times New Roman", serif;
            font-size: 1.4rem;
            letter-spacing: 0.03em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .license-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.6);
            transition: box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        }

        /* Glowing green when full license is active */
        .license-status-full {
            background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.25), rgba(21, 128, 61, 0.95));
            border-color: rgba(74, 222, 128, 0.9);
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.9);
        }

        .license-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #ef4444;
        }

        .trial-badge {
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(245, 158, 11, 0.16);
            color: #fbbf24;
            font-size: 0.7rem;
            border: 1px solid rgba(251, 191, 36, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .upgrade-btn {
            border-radius: 999px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f97316, #e11d48);
            border: none;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .upgrade-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        }

        .btn-secondary {
            border-radius: 999px;
            padding: 7px 16px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            font-size: 0.9rem;
            cursor: pointer;
            transition: box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        }

        /* Glowing green License Active button */
        .btn-secondary.active-license {
            background: radial-gradient(circle at top, rgba(22, 163, 74, 0.98), rgba(21, 128, 61, 0.98));
            border-color: rgba(74, 222, 128, 0.9);
            color: #eafff2;
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.9);
            cursor: default;
            pointer-events: none;
        }

        /* MAIN LAYOUT */
        .app-main {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .sidebar {
            width: var(--nav-width);
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), transparent 55%), #020617;
            border-right: 1px solid rgba(15, 23, 42, 0.95);
            padding: 20px 18px 22px;
            overflow-y: auto;
        }

        .sidebar-inner {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .user-info {
            padding: 12px 12px 10px;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.5);
        }

        .user-email {
            font-size: 0.82rem;
            color: var(--text-soft);
        }

        .license-type {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .nav-group {
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(30, 64, 175, 0.7);
            padding: 10px;
        }

        .nav-section {
            margin-bottom: 10px;
        }

        .nav-section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            cursor: pointer;
            padding: 6px 6px 4px;
        }

        .nav-section.collapsed .nav-list {
            display: none;
        }

        .nav-section-title::after {
            content: "‚ñº";
            font-size: 0.8rem;
            transition: transform 0.18s ease;
        }

        .nav-section.collapsed .nav-section-title::after {
            transform: rotate(-90deg);
        }

        .nav-list {
            list-style: none;
            margin: 0;
            padding: 4px 0 2px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-link {
            width: 100%;
            text-align: left;
            border-radius: 10px;
            border: 1px solid transparent;
            padding: 8px 8px;
            background: transparent;
            color: #e5e7eb;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .nav-link-main {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .nav-link-label {
            font-weight: 500;
        }

        .nav-link-badge {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .nav-link-meta {
            font-size: 0.74rem;
            color: #6b7280;
        }

        .nav-link-locked {
            font-size: 0.72rem;
            color: #f97316;
        }

        /* Red glow on active entry */
        .nav-link.active {
            background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.22), rgba(239, 68, 68, 0.3));
            border-color: rgba(248, 113, 113, 0.9);
            box-shadow: 0 0 12px rgba(248, 113, 113, 0.8);
        }

        .nav-link.trial-only:not(.active) {
            border-color: rgba(249, 115, 22, 0.7);
            background: rgba(30, 64, 175, 0.4);
        }

        /* READER PANE */
        .reader-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .reader-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 18px;
            background: rgba(15, 23, 42, 0.96);
            border-bottom: 1px solid rgba(30, 64, 175, 0.8);
            flex-wrap: wrap;
            gap: 10px;
        }

        .reader-controls-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reader-control-btn {
            border-radius: 999px;
            padding: 6px 14px;
            border: 1px solid rgba(148, 163, 184, 0.75);
            background: rgba(15, 23, 42, 0.98);
            color: #e5e7eb;
            font-size: 0.88rem;
            cursor: pointer;
        }

        .nav-disabled {
            opacity: 0.4;
            cursor: default;
        }

        .reader-controls-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .current-position-pill {
            border-radius: 999px;
            padding: 4px 10px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(55, 65, 81, 0.8);
        }

        .trial-remaining {
            border-radius: 999px;
            padding: 4px 10px;
            background: rgba(30, 64, 175, 0.4);
            border: 1px solid rgba(37, 99, 235, 0.9);
            color: #dbeafe;
        }

        .reader-iframe-wrap {
            position: relative;
            flex: 1;
            min-height: 0;
            background: #f9fafb;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* LOADING OVERLAY */
        #loadingOverlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.86);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(15, 23, 42, 0.9);
            border-top-color: #f97316;
            border-radius: 999px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .trial-limitation {
            background: rgba(127, 29, 29, 0.95);
            color: #fee2e2;
            padding: 10px 18px;
            font-size: 0.85rem;
            border-top: 1px solid rgba(239, 68, 68, 0.8);
            display: none;
        }

        .trial-limitation a {
            color: #fee2e2;
            font-weight: 600;
        }

        .trial-limitation a:hover {
            text-decoration: underline;
        }

        /* ALERT BANNER (fixed bottom upgrade) */
        #upgradeBanner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 1400px;
            padding: 10px 20px;
            background: linear-gradient(90deg, #b91c1c, #dc2626);
            color: #fee2e2;
            font-size: 0.88rem;
        }

        #upgradeBannerContent {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        #upgradeNow {
            border-radius: 999px;
            padding: 6px 14px;
            border: none;
            background: #fee2e2;
            color: #b91c1c;
            font-weight: 600;
            font-size: 0.86rem;
            cursor: pointer;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .splash-inner {
                grid-template-columns: minmax(0, 1fr);
            }

            .splash-left {
                order: -1;
            }

            .splash-right {
                text-align: left;
            }

            .splash-title {
                font-size: 2.6rem;
            }
        }

        @media (max-width: 768px) {
            #splashEntrance {
                padding: 16px 10px 24px;
                align-items: flex-start;
            }

            .splash-inner {
                padding: 20px 16px;
                border-radius: 26px;
            }

            .splash-title {
                font-size: 2.1rem;
            }

            .splash-subtitle {
                font-size: 0.98rem;
            }

            .splash-bullets {
                grid-template-columns: 1fr;
            }

            .btn-primary {
                width: 100%;
                justify-content: center;
            }

            .btn-secondary-outline {
                width: 100%;
                justify-content: center;
            }

            /* App shell */
            .app-main {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 100;
                display: none;
                width: 80%;
                max-width: 320px;
                box-shadow: 12px 0 35px rgba(0, 0, 0, 0.7);
            }

            .app-header {
                padding: 12px 14px;
            }

            .menu-toggle {
                display: inline-flex;
            }

            .header-right {
                gap: 6px;
            }

            .license-status {
                display: none;
            }

            .reader-controls-right {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            .splash-title {
                font-size: 1.9rem;
            }

            .splash-subtitle {
                font-size: 0.95rem;
            }

            .btn-primary {
                font-size: 0.95rem;
                padding: 12px 20px;
            }

            .current-label {
                font-size: 1.1rem;
            }

            .reader-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .reader-controls-left {
                width: 100%;
                justify-content: space-between;
            }

            .reader-controls-right {
                width: 100%;
                justify-content: space-between;
                gap: 8px;
                font-size: 0.78rem;
            }

            .nav-link {
                font-size: 0.86rem;
            }
        }

        /* PRINT LOCKOUT */
        @media print {
            body * {
                visibility: hidden !important;
            }

            #printWarning,
            #printWarning * {
                visibility: visible !important;
            }

            #printWarning {
                position: fixed;
                inset: 0;
                background: white;
                color: black;
                padding: 40px;
                text-align: center;
            }
        }

        /* Phones: 0‚Äì599px */
        @media (max-width: 599px) {
            .app-header {
                padding: 10px 16px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .header-left {
                flex: 1 1 100%;
                justify-content: space-between;
                align-items: center;
            }

            .current-label {
                font-size: 1.2rem;
                max-width: 60%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .header-right {
                flex: 1 1 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 4px;
            }

            .license-status {
                width: 100%;
                justify-content: space-between;
                font-size: 0.9rem;
                padding: 6px 10px;
                display: flex;
            }

            .upgrade-btn,
            .btn-secondary {
                flex: 1 1 calc(50% - 6px);
                text-align: center;
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .reader-controls {
                padding: 10px 12px;
                justify-content: center;
            }

            .reader-controls-left {
                width: 100%;
                justify-content: space-between;
                gap: 10px;
            }

            .reader-control-btn {
                flex: 1 1 48%;
                justify-content: center;
            }

            .reader-pane {
                min-height: calc(100vh - 140px);
            }

            .reader-iframe-wrap {
                border-top: 1px solid rgba(148, 163, 184, 0.4);
            }
        }

        /* Extra-small phones */
        @media (max-width: 400px) {
            .app-header {
                padding: 8px 10px;
            }

            .current-label {
                font-size: 1.05rem;
                max-width: 55%;
            }

            .license-status {
                padding: 6px 8px;
                font-size: 0.8rem;
            }

            .upgrade-btn,
            .btn-secondary {
                flex: 1 1 100%;
            }

            .reader-control-btn {
                flex: 1 1 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- ========== SPLASH ENTRANCE ========== -->
    <div id="splashEntrance">
        <div class="splash-inner">
            <div class="splash-left">
                <div class="book-cover-wrapper">
                    <div class="book-cover-glow"></div>
                    <div class="book-cover-outline"></div>
                    <img src="Front Cover.png" alt="Infinity Loop Cover" class="book-cover" id="bookCover" />
                    <div class="cover-reflection"></div>
                </div>
            </div>
            <div class="splash-right">
                <div class="splash-pill">
                    <div class="splash-pill-dot"></div>
                    <div class="splash-pill-text">Early access ‚Ä¢ Limited reader beta</div>
                </div>
                <h1 class="splash-title">The Infinity Loop</h1>
                <p class="splash-subtitle">
                    An interactive journey through the machinery of systemic control and resistance. Explore 11 chapters
                    of meticulously researched history, theory, data, and abolition-aligned strategies.
                </p>
                <div class="splash-bullets">
                    <div class="splash-bullet">
                        <div class="bullet-icon primary">üìö</div>
                        <div class="bullet-body">
                            <div class="bullet-title">Loop narrative, 1619‚Äì2025</div>
                            <div class="bullet-text">
                                11 core chapters stitched into a single Loop that maps policy, profit, and power.
                            </div>
                        </div>
                    </div>
                    <div class="splash-bullet">
                        <div class="bullet-icon secondary">üìä</div>
                        <div class="bullet-body">
                            <div class="bullet-title">Evidence-driven</div>
                            <div class="bullet-text">
                                Data tables, Loop maps, and case studies built from Tier 1 primary and Tier 2 secondary
                                sources.
                            </div>
                        </div>
                    </div>
                    <div class="splash-bullet">
                        <div class="bullet-icon primary">üß©</div>
                        <div class="bullet-body">
                            <div class="bullet-title">Loop mechanisms</div>
                            <div class="bullet-text">
                                See how surveillance, criminalization, extraction, and destabilization interlock over
                                time.
                            </div>
                        </div>
                    </div>
                    <div class="splash-bullet">
                        <div class="bullet-icon secondary">üå±</div>
                        <div class="bullet-body">
                            <div class="bullet-title">Resilience blueprints</div>
                            <div class="bullet-text">
                                Abolition-aligned strategies, mutual aid, and resilience practices for breaking the Loop.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="splash-cta-row">
                    <button id="enterBookBtn" class="btn-primary">
                        <span>Enter Interactive Reader</span>
                    </button>
                </div>
                <div class="trial-card">
                    <div class="trial-card-header">
                        <div class="trial-card-title">Trial access</div>
                        <div class="trial-card-badge">First 2 chapters free</div>
                    </div>
                    <div class="trial-card-body">
                        Read the opening chapters and front matter without a credit card. Upgrade later for full
                        11-chapter access and all appendices.
                    </div>
                </div>
                <p class="splash-disclaimer">
                    Your progress is stored locally on this device. By continuing, you agree to the
                    <a href="#" id="licenseAgreementLink">License &amp; Use Policy</a>.
                </p>
            </div>
        </div>
    </div>

    <!-- ========== EMAIL / TRIAL MODAL ========== -->
    <div id="emailModal" class="modal-backdrop">
        <div class="modal">
            <button class="modal-close" id="closeEmailModal">‚úï</button>
            <h2>Unlock trial access</h2>
            <p>
                Access front matter plus <span class="modal-highlight">Chapters 1‚Äì2</span> for 7 days. No credit card
                required. Your email is used only for sending your license &amp; major updates.
            </p>
            <form id="emailForm">
                <div class="input-group">
                    <label for="trialName">Name</label>
                    <input type="text" id="trialName" placeholder="How should we address you?" required />
                </div>
                <div class="input-group">
                    <label for="trialEmail">Email</label>
                    <input type="email" id="trialEmail" placeholder="you@example.com" required />
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agreeTerms" required />
                    <label for="agreeTerms">
                        I agree to the <a href="#" id="termsLink">Terms of Service</a> and understand I may receive
                        occasional Loop updates.
                    </label>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">
                    <span>Start 7-Day Free Trial</span>
                </button>
            </form>
            <p class="small-text">
                Already have a license? <a href="#" id="switchToLicense">Activate here</a>.
            </p>
        </div>
    </div>

    <!-- ========== LICENSE MODAL ========== -->
    <div id="licenseModal" class="modal-backdrop">
        <div class="modal">
            <button class="modal-close" id="closeLicenseModal">‚úï</button>
            <h2>Activate full access</h2>
            <p>
                Enter your license key to unlock all 11 chapters, appendices, and data tables on this device.
            </p>
            <div class="input-group">
                <label for="licenseInput">License Key</label>
                <input type="text" id="licenseInput" placeholder="INF-XXXX-XXXX-XXXX" required />
            </div>
            <button id="activateLicense" class="btn-primary" style="width: 100%; margin-bottom: 12px;">
                <span>Activate License</span>
            </button>
            <div class="purchase-options">
                <button id="purchasePaypal">
                    <span>Purchase with</span>
                    <strong>PayPal</strong>
                </button>
            </div>
            <p class="small-text">
                By activating, you agree to the single-device, non-transferable license terms.
            </p>
        </div>
    </div>

    <!-- ========== APP SHELL ========== -->
    <div id="app-shell">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">‚ò∞</button>
                <div id="current-label" class="current-label">The Infinity Loop</div>
            </div>
            <div class="header-right">
                <div class="license-status">
                    <span class="license-dot" id="licenseDot"></span>
                    <span id="licenseStatus">Loading...</span>
                    <span id="trialBadge" class="trial-badge" style="display: none;">TRIAL</span>
                </div>
                <button id="upgradeButton" class="upgrade-btn">Upgrade</button>
                <button id="activateBtn" class="btn-secondary">Activate License</button>
            </div>
        </header>
        <div class="app-main">
            <!-- SIDEBAR -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-inner">
                    <div class="user-info">
                        <div class="user-email" id="userEmail">Not logged in</div>
                        <div class="license-type" id="licenseTypeDisplay">No Access</div>
                    </div>
                    <div class="nav-group">
                        <!-- FRONT MATTER -->
                        <div class="nav-section">
                            <h3 class="nav-section-title">Front Matter</h3>
                            <ul class="nav-list" id="frontMatterList"></ul>
                        </div>
                        <!-- CHAPTERS -->
                        <div class="nav-section">
                            <h3 class="nav-section-title">
                                Chapters
                                <span id="chapterLimit">(0/11)</span>
                            </h3>
                            <ul class="nav-list" id="chapterList"></ul>
                        </div>
                        <!-- BACK MATTER -->
                        <div class="nav-section">
                            <h3 class="nav-section-title">Back Matter</h3>
                            <ul class="nav-list" id="backMatterList"></ul>
                        </div>
                    </div>
                </div>
            </aside>
            <!-- READER -->
            <section class="reader-pane">
                <div class="reader-controls">
                    <div class="reader-controls-left">
                        <button class="reader-control-btn" id="prev-btn">‚Üê Previous</button>
                        <button class="reader-control-btn" id="next-btn">Next ‚Üí</button>
                    </div>
                    <div class="reader-controls-right">
                        <div class="current-position-pill" id="positionPill">Front matter</div>
                        <div class="trial-remaining" id="trialInfoPill" style="display: none;"></div>
                    </div>
                </div>
                <div class="reader-iframe-wrap">
                    <div id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                    <iframe id="readerFrame" title="Infinity Loop Reader"></iframe>
                </div>
                <div id="trialLimitation" class="trial-limitation">
                    Trial limit reached. Only front matter and Chapters 1‚Äì2 are accessible during the trial.
                    <a href="#" id="trialUpgradeLink">Upgrade to full version</a> for complete access.
                </div>
            </section>
        </div>
    </div>

    <!-- Bottom upgrade banner -->
    <div id="upgradeBanner">
        <div id="upgradeBannerContent">
            <span id="upgradeBannerMessage">Trial limit reached ‚Äî Chapters 3‚Äì11 require a full license.</span>
            <div class="upgrade-buttons">
                <button id="signupTrialButton" class="btn-primary" style="display:none;"><span>Sign Up for Trial</span></button>
                <button id="upgradeNow" class="upgrade-btn"><span>Upgrade Now</span></button>
            </div>
        </div>
    </div>

    <div id="printWarning" style="display: none;">
        <h1>Printing Disabled</h1>
        <p>The Infinity Loop reader is designed for interactive use only.</p>
        <p>Please use the licensed PDF or print edition for hard copies.</p>
    </div>

    <script>
        // ========== CONFIG ==========
        const CONFIG = {
            APP_VERSION: "2.0.0",
            TRIAL_CHAPTERS: 2,
            TRIAL_DAYS: 7,
            TEST_LICENSE: "INF-TEST-2024-ABCD-5678",
            MASTER_LICENSE: "INF-MASTER-2025-ROOT-0001", // master key
            VALID_LICENSE_PREFIX: "INF-",
            STRIPE_CHECKOUT_URL: "https://buy.stripe.com/dRm7sN2on3yF26FbYEdIA01",
            PAYPAL_CHECKOUT_URL: "https://www.paypal.com/ncp/payment/FR755FQZHEGQA",
            MAKE_WEBHOOK_URL: "https://hook.us2.make.com/4bwg1lvvkqkqwk75tv8b2jmc8upri5fv",
        };

        // ========== BOOK STRUCTURE ==========
        const BOOK_STRUCTURE = {
            frontMatter: [
                {
                    file: "TITLE_PAGE.htm",
                    label: "Title Page",
                    alwaysAccessible: true,
                    id: "title-page",
                },
                {
                    file: "Dedication.htm",
                    label: "Dedication",
                    alwaysAccessible: true,
                    id: "dedication",
                },
                {
                    file: "Epigraph_.htm",
                    label: "Epigraph",
                    alwaysAccessible: true,
                    id: "epigraph",
                },
                {
                    file: "CONTENT_WARNING_.htm",
                    label: "Content Warning / Reader Care Note",
                    alwaysAccessible: true,
                    id: "content-warning",
                },
                {
                    file: "A_NOTE_ON_LANGUAGE_AND_TERMINOLOGY.htm",
                    label: "A Note on Language and Terminology",
                    alwaysAccessible: true,
                    id: "language-note",
                },
                {
                    file: "HOW_TO_USE_THIS_BOOK_A_READER'S_GUIDE_.htm",
                    label: "How to Use This Book: A Reader's Guide",
                    alwaysAccessible: true,
                    id: "guide",
                },
                {
                    file: "AUTHOR'S_PREFACE_UNDERSTANDING_THE_INFINITY_LOOP_.htm",
                    label: "Author's Preface: Understanding the Infinity Loop",
                    alwaysAccessible: true,
                    id: "preface",
                },
                {
                    file: "NOTE_ON_SOURCES_AND_METHODOLOGY_.htm",
                    label: "Note on Sources and Methodology",
                    alwaysAccessible: true,
                    id: "methodology",
                },
            ],
            chapters: [
                {
                    file: "CHAPTER_1_clean_stitched_formatted.htm",
                    label: "CHAPTER 1: ORIGIN STORIES AND THE LOOP'S BLUEPRINT",
                    badge: "(1619 - 1865)",
                    id: "ch1",
                },
                {
                    file: "CHAPTER_2_clean_stitched_formatted.htm",
                    label: "CHAPTER 2: RECONSTRUCTION, WHITE BACKLASH, AND THE NEW LOOP",
                    badge: "(1865 - 1919)",
                    id: "ch2",
                },
                {
                    file: "CHAPTER_3_clean_stitched_formatted.htm",
                    label: "CHAPTER 3: RED SUMMER, RED SCARE, AND THE MODERN POLICE STATE EMERGES",
                    badge: "(1920 - 1945)",
                    id: "ch3",
                },
                {
                    file: "CHAPTER_4_clean_stitched_formatted.htm",
                    label: "CHAPTER 4: COLD WAR CIVIL RIGHTS, RACIAL COUNTERINTELLIGENCE, AND 'GENOCIDE'",
                    badge: "(1946 - 1955)",
                    id: "ch4",
                },
                {
                    file: "CHAPTER_5_clean_stitched_formatted.htm",
                    label: "CHAPTER 5: FREEDOM NOW‚ÄîTHE CIVIL RIGHTS ERA AND THE PANTHER'S PRICE",
                    badge: "(1956 - 1971)",
                    id: "ch5",
                },
                {
                    file: "CHAPTER_6_clean_stitched_formatted.htm",
                    label: "CHAPTER 6: THE WAR ON CRIME, THE WAR ON DRUGS, AND THE CARCERAL BOOM",
                    badge: "(1972 - 1989)",
                    id: "ch6",
                },
                {
                    file: "CHAPTER_7_clean_stitched_formatted.htm",
                    label: "CHAPTER 7: THREE STRIKES, ZERO TOLERANCE, AND MASS INCARCERATION",
                    badge: "(1990 - 2009)",
                    id: "ch7",
                },
                {
                    file: "CHAPTER_8_clean_stitched_formatted.htm",
                    label: "CHAPTER 8: THE DIGITAL LOOP‚ÄîBIG DATA, PREDICTIVE POLICING, AND ALGORITHMIC CONTROL",
                    badge: "(2010 - 2016)",
                    id: "ch8",
                },
                {
                    file: "CHAPTER_9_clean_stitched_formatted.htm",
                    label: "CHAPTER 9: THE PROTEST CYCLE‚ÄîFerguson, Uprisings, AND THE BACKLASH",
                    badge: "(2017 - 2020)",
                    id: "ch9",
                },
                {
                    file: "CHAPTER_10_clean_stitched_formatted.htm",
                    label: "CHAPTER 10: LIVING WITHIN THE LOOP‚ÄîCOVID-19, MUTUAL AID, AND RESILIENCE",
                    badge: "(2020 - 2024)",
                    id: "ch10",
                },
                {
                    file: "CHAPTER_11_clean_stitched_formatted.htm",
                    label: "CHAPTER 11: BREAKING THE LOOP‚ÄîFROM EVIDENCE TO ABOLITION",
                    badge: "2025 AND BEYOND",
                    id: "ch11",
                },
            ],
            backMatter: [
                {
                    file: "APPENDIX_A_LOOP MECHANISM GLOSSARY_.htm",
                    label: "Appendix A: Loop Mechanism Glossary",
                    alwaysAccessible: true,
                    id: "app-a",
                },
                {
                    file: "APPENDIX_B_HISTORICAL TIMELINE (1619-2025)_.htm",
                    label: "Appendix B: Historical Timeline (1619‚Äì2025)",
                    alwaysAccessible: true,
                    id: "app-b",
                },
                {
                    file: "APPENDIX_C_METHODOLOGY AND SOURCES NOTE_.htm",
                    label: "Appendix C: Methodology and Sources Note",
                    alwaysAccessible: true,
                    id: "app-c",
                },
                {
                    file: "WORKS CITED.htm",
                    label: "Works Cited",
                    alwaysAccessible: true,
                    id: "works-cited",
                },
                {
                    file: "Tiered_Works_Cited.htm",
                    label: "Tiered Works Cited (by tier)",
                    alwaysAccessible: true,
                    id: "tiered-works-cited",
                },
                {
                    file: "CONSOLIDATED_WORKS_CITED.htm",
                    label: "Consolidated Works Cited (Master List)",
                    alwaysAccessible: true,
                    id: "consolidated-works-cited",
                },
                {
                    file: "ACKNOWLEDGMENTS_.htm",
                    label: "Acknowledgments",
                    alwaysAccessible: true,
                    id: "acknowledgments",
                },
                {
                    file: "ABOUT_THE_AUTHOR.htm",
                    label: "About the Author",
                    alwaysAccessible: true,
                    id: "about-author",
                },
            ],
        };

        // ========== LICENSE MANAGER ==========
        class LicenseManager {
            constructor() {
                this.deviceId = this.getDeviceId();
                this.userData = this.loadUserData();
                this.licenseData = this.loadLicenseData();
                this.trialData = this.loadTrialData();
                this.normalizeTrialState(); // clean up expired trials
            }

            getDeviceId() {
                let deviceId = localStorage.getItem("infinityLoopDeviceId");
                if (!deviceId) {
                    deviceId = "DEV-" + Math.random().toString(36).substr(2, 9).toUpperCase();
                    localStorage.setItem("infinityLoopDeviceId", deviceId);
                }
                return deviceId;
            }

            loadUserData() {
                try {
                    const data = localStorage.getItem("infinityLoopUser");
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Error loading user data", e);
                    return null;
                }
            }

            loadLicenseData() {
                try {
                    const data = localStorage.getItem("infinityLoopLicense");
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Error loading license data", e);
                    return null;
                }
            }

            loadTrialData() {
                try {
                    const data = localStorage.getItem("infinityLoopTrial");
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Error loading trial data", e);
                    return null;
                }
            }

            normalizeTrialState() {
                if (!this.trialData || !this.trialData.expiry) return;
                const expiry = new Date(this.trialData.expiry);
                const now = new Date();
                if (isNaN(expiry.getTime()) || expiry <= now) {
                    // mark that a trial just expired (for banner)
                    localStorage.setItem("infinityLoopTrialExpiredFlag", "1");
                    localStorage.removeItem("infinityLoopTrial");
                    this.trialData = null;
                }
            }

            saveUser(email, name = "") {
                const userData = {
                    email,
                    name: name || "",
                    registered: new Date().toISOString(),
                    deviceId: this.deviceId,
                };
                localStorage.setItem("infinityLoopUser", JSON.stringify(userData));
                this.userData = userData;
                return userData;
            }

            startTrial(email, name = "") {
                const trialData = {
                    email,
                    name: name || "",
                    startDate: new Date().toISOString(),
                    expiry: new Date(Date.now() + CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000).toISOString(),
                    chaptersAllowed: CONFIG.TRIAL_CHAPTERS,
                    deviceId: this.deviceId,
                };
                localStorage.setItem("infinityLoopTrial", JSON.stringify(trialData));
                this.trialData = trialData;
                // clear any old "expired" flag when a new trial starts
                localStorage.removeItem("infinityLoopTrialExpiredFlag");
                return trialData;
            }

            activateLicense(licenseKey, email, name = "") {
                const normalizedKey = licenseKey.trim().toUpperCase();
                
                // Check for valid license formats
                const isValid = 
                    normalizedKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) ||
                    normalizedKey === CONFIG.TEST_LICENSE ||
                    normalizedKey === CONFIG.MASTER_LICENSE;
                
                if (!isValid) {
                    throw new Error("Invalid license key format. Valid keys start with 'INF-'");
                }

                const licenseData = {
                    licenseKey: normalizedKey,
                    email,
                    name: name || "",
                    activated: new Date().toISOString(),
                    deviceId: this.deviceId,
                    version: CONFIG.APP_VERSION,
                    isMaster: normalizedKey === CONFIG.MASTER_LICENSE,
                };
                localStorage.setItem("infinityLoopLicense", JSON.stringify(licenseData));
                this.licenseData = licenseData;
                localStorage.removeItem("infinityLoopTrial");
                this.trialData = null;
                return licenseData;
            }

            hasActiveLicense() {
                return !!this.licenseData;
            }

            hasActiveTrial() {
                if (!this.trialData) return false;
                const expiry = new Date(this.trialData.expiry);
                return expiry > new Date();
            }

            canAccessChapter(chapterNumber) {
                // Backwards compatible: delegate to section-based check for chapters
                return this.canAccessSection("chapter", chapterNumber, "");
            }

            canAccessSection(sectionType, chapterNumber = 0, file = "") {
                // Title page is always accessible
                if (file === "TITLE_PAGE.htm") return true;

                // Full license: full access everywhere
                if (this.hasActiveLicense()) return true;

                // Active trial: only chapters within trial allowed; front/back (except title page) are locked
                if (this.hasActiveTrial()) {
                    if (sectionType === "chapter") return chapterNumber <= CONFIG.TRIAL_CHAPTERS;
                    return false;
                }

                // No access: nothing allowed except title page (handled above)
                return false;
            }

            getUserEmail() {
                if (this.licenseData && this.licenseData.email) return this.licenseData.email;
                if (this.trialData && this.trialData.email) return this.trialData.email;
                if (this.userData && this.userData.email) return this.userData.email;
                return "";
            }

            getUserName() {
                if (this.licenseData && this.licenseData.name) return this.licenseData.name;
                if (this.trialData && this.trialData.name) return this.trialData.name;
                if (this.userData && this.userData.name) return this.userData.name;
                return "";
            }

            getAccessType() {
                if (this.hasActiveLicense()) return "full";
                if (this.hasActiveTrial()) return "trial";
                return "none";
            }

            getRemainingTrialDays() {
                if (!this.trialData || !this.trialData.expiry) return 0;
                const expiry = new Date(this.trialData.expiry);
                const now = new Date();
                const diffMs = expiry - now;
                return Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
            }
        }

        /**
         * Apply consistent, ebook-style typography inside the loaded chapter iframe.
         */
        function applyReaderTypographyToIframe(iframeEl) {
            if (!iframeEl) return;
            const doc = iframeEl.contentDocument || (iframeEl.contentWindow && iframeEl.contentWindow.document);
            if (!doc) return;
            try {
                let head = doc.head;
                if (!head) {
                    head = doc.createElement("head");
                    if (doc.documentElement) {
                        doc.documentElement.insertBefore(head, doc.documentElement.firstChild);
                    } else if (doc.body && doc.body.parentNode) {
                        doc.body.parentNode.insertBefore(head, doc.body);
                    }
                }
                let styleEl = doc.getElementById("infinity-loop-ebook-typography");
                if (!styleEl) {
                    styleEl = doc.createElement("style");
                    styleEl.id = "infinity-loop-ebook-typography";
                    head.appendChild(styleEl);
                }
                styleEl.textContent = [
                    "html, body {",
                    " margin: 0;",
                    " padding: 20px 18px;",
                    " max-width: 44rem;",
                    " margin-left: auto;",
                    " margin-right: auto;",
                    ' font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;',
                    " font-size: 16px;",
                    " line-height: 1.6;",
                    " color: #111827;",
                    " background: #ffffff;",
                    "}",
                    "",
                    "p { margin: 0 0 1em 0; }",
                    "",
                    "h1, h2, h3, h4, h5, h6 {",
                    ' font-family: "Crimson Pro", "Georgia", serif;',
                    " margin: 1.4em 0 0.7em;",
                    " line-height: 1.3;",
                    "}",
                    "h1 { font-size: 1.9em; }",
                    "h2 { font-size: 1.6em; }",
                    "h3 { font-size: 1.4em; }",
                    "h4 { font-size: 1.2em; }",
                    "",
                    "ul, ol { margin: 0 0 1.1em 1.4em; }",
                    "",
                    "table {",
                    " width: 100%;",
                    " border-collapse: collapse;",
                    " margin: 1.5em 0;",
                    "}",
                    "th, td {",
                    " padding: 0.5em 0.6em;",
                    " border: 1px solid #d1d5db;",
                    "}",
                    "",
                    "a { color: #1d4ed8; text-decoration: underline; }",
                    "",
                    "@media (max-width: 600px) {",
                    " html, body {",
                    " padding: 18px 14px;",
                    " font-size: 17px;",
                    " line-height: 1.7;",
                    " }",
                    "}",
                ].join("\n");
            } catch (err) {
                console.warn("Could not apply ebook typography:", err);
            }
        }

        // ========== MAIN APPLICATION ==========
        class InfinityLoopApp {
            constructor() {
                this.currentFile = "";
                this.currentChapter = 0;
                this.currentSection = "";
                this.currentIndex = 0;
                this.isMobile = window.innerWidth <= 768;
                this.allSections = [];
                this.licenseManager = new LicenseManager();
                this.init();
            }

            init() {
                this.cacheDOM();
                this.setupEventListeners();
                this.initializeNavigation();
                this.loadNavigation();
                this.updateAccessUI();
                
                // Initialize mobile sidebar state
                if (this.isMobile) {
                    this.sidebar.style.display = "none";
                    this.menuToggle.textContent = "‚ò∞";
                }
                
                // Preload Title Page so it shows first when the book is entered
                this.openSection("TITLE_PAGE.htm", "Title Page", 0, "title-page", "front");
            }

            cacheDOM() {
                this.splashEntrance = document.getElementById("splashEntrance");
                this.emailModal = document.getElementById("emailModal");
                this.licenseModal = document.getElementById("licenseModal");
                this.appShell = document.getElementById("app-shell");
                this.readerFrame = document.getElementById("readerFrame");
                this.loadingOverlay = document.getElementById("loadingOverlay");
                this.sidebar = document.getElementById("sidebar");
                this.menuToggle = document.getElementById("menu-toggle");
                this.frontMatterList = document.getElementById("frontMatterList");
                this.chapterList = document.getElementById("chapterList");
                this.backMatterList = document.getElementById("backMatterList");
                this.userEmailSpan = document.getElementById("userEmail");
                this.licenseTypeDisplay = document.getElementById("licenseTypeDisplay");
                this.trialBadge = document.getElementById("trialBadge");
                this.upgradeButton = document.getElementById("upgradeButton");
                this.activateBtn = document.getElementById("activateBtn");
                this.currentLabel = document.getElementById("current-label");
                this.licenseStatusEl = document.getElementById("licenseStatus");
                this.licenseDot = document.getElementById("licenseDot");
                this.licenseStatusContainer = document.querySelector(".license-status");
                this.chapterLimitEl = document.getElementById("chapterLimit");
                this.trialInfoPill = document.getElementById("trialInfoPill");
                this.positionPill = document.getElementById("positionPill");
                this.trialLimitation = document.getElementById("trialLimitation");
                this.upgradeBanner = document.getElementById("upgradeBanner");
                this.upgradeBannerMessage = document.getElementById("upgradeBannerMessage");
                this.signupTrialButton = document.getElementById("signupTrialButton");
                this.upgradeNowBtn = document.getElementById("upgradeNow");
                this.prevBtn = document.getElementById("prev-btn");
                this.nextBtn = document.getElementById("next-btn");
            }

            initializeNavigation() {
                this.allSections = [
                    ...BOOK_STRUCTURE.frontMatter.map((item) => ({
                        ...item,
                        type: "front",
                    })),
                    ...BOOK_STRUCTURE.chapters.map((item, index) => ({
                        ...item,
                        type: "chapter",
                        chapterNumber: index + 1,
                    })),
                    ...BOOK_STRUCTURE.backMatter.map((item) => ({
                        ...item,
                        type: "back",
                    })),
                ];
            }

            setupEventListeners() {
                const enterBookBtn = document.getElementById("enterBookBtn");
                const bookCover = document.getElementById("bookCover");

                if (enterBookBtn) enterBookBtn.addEventListener("click", () => this.handleEnterClick());
                if (bookCover) bookCover.addEventListener("click", () => this.handleEnterClick());

                const emailForm = document.getElementById("emailForm");
                const trialEmailInput = document.getElementById("trialEmail");
                const trialNameInput = document.getElementById("trialName");

                if (emailForm) {
                    emailForm.addEventListener("submit", (e) => {
                        e.preventDefault();
                        this.startTrial(trialEmailInput.value.trim(), trialNameInput.value.trim());
                    });
                }

                const activateLicenseBtn = document.getElementById("activateLicense");
                const licenseInput = document.getElementById("licenseInput");
                const closeEmailModal = document.getElementById("closeEmailModal");
                const closeLicenseModal = document.getElementById("closeLicenseModal");
                const switchToLicense = document.getElementById("switchToLicense");
                const trialUpgradeLink = document.getElementById("trialUpgradeLink");

                if (activateLicenseBtn) {
                    activateLicenseBtn.addEventListener("click", () => {
                        this.activateLicense(licenseInput.value.trim());
                    });
                }

                if (closeEmailModal) {
                    closeEmailModal.addEventListener("click", () => (this.emailModal.style.display = "none"));
                }

                if (closeLicenseModal) {
                    closeLicenseModal.addEventListener("click", () => (this.licenseModal.style.display = "none"));
                }

                if (switchToLicense) {
                    switchToLicense.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.showLicenseModal();
                    });
                }

                if (trialUpgradeLink) {
                    trialUpgradeLink.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.showLicenseModal();
                    });
                }

                const purchasePaypal = document.getElementById("purchasePaypal");

                if (purchasePaypal) {
                    purchasePaypal.addEventListener("click", (e) => {
                        e.preventDefault();
                        if (confirm("You will be redirected to our secure PayPal checkout page. Continue?")) {
                            window.open(CONFIG.PAYPAL_CHECKOUT_URL, "_blank");
                        }
                    });
                }

                if (this.upgradeButton) this.upgradeButton.addEventListener("click", () => {
                    const accessType = this.licenseManager.getAccessType();
                    if (accessType === "none") {
                        this.showEmailModal();
                    } else {
                        this.showLicenseModal();
                    }
                });

                const upgradeNow = document.getElementById("upgradeNow");
                if (upgradeNow) upgradeNow.addEventListener("click", () => this.showLicenseModal());

                // Signup for trial button on bottom banner
                if (this.signupTrialButton) {
                    this.signupTrialButton.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.showEmailModal();
                    });
                }

                if (this.activateBtn) this.activateBtn.addEventListener("click", () => this.showLicenseModal());

                if (this.prevBtn) this.prevBtn.addEventListener("click", () => this.navigateToPrevious());
                if (this.nextBtn) this.nextBtn.addEventListener("click", () => this.navigateToNext());

                if (this.menuToggle) {
                    this.menuToggle.addEventListener("click", () => this.toggleSidebar());
                }

                document.querySelectorAll(".nav-section-title").forEach((title) => {
                    title.addEventListener("click", (e) => {
                        const section = e.currentTarget.closest(".nav-section");
                        if (section) section.classList.toggle("collapsed");
                    });
                });

                window.addEventListener("resize", () => {
                    this.isMobile = window.innerWidth <= 768;
                });

                const termsLink = document.getElementById("termsLink");
                const licenseAgreementLink = document.getElementById("licenseAgreementLink");

                if (termsLink) {
                    termsLink.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.showTerms();
                    });
                }

                if (licenseAgreementLink) {
                    licenseAgreementLink.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.showLicenseAgreement();
                    });
                }
            }

            handleEnterClick() {
                const accessType = this.licenseManager.getAccessType();
                
                // Always show main reader shell
                this.showApp();
                
                if (accessType === "none") {
                    // First time: no trial, no license ‚Üí show email/trial form
                    this.showEmailModal();
                    this.openSection("TITLE_PAGE.htm", "Title Page", 0, "title-page", "front");
                    return;
                }
                
                // Trial or full license already active ‚Üí show Title Page if nothing loaded yet
                if (!this.currentFile) {
                    this.openSection("TITLE_PAGE.htm", "Title Page", 0, "title-page", "front");
                }
            }

            handleViewSampleClick() {
                this.showEmailModal();
            }

            showEmailModal() {
                this.emailModal.style.display = "flex";
            }

            showLicenseModal() {
                this.licenseModal.style.display = "flex";
            }

            showApp() {
                this.splashEntrance.style.display = "none";
                this.emailModal.style.display = "none";
                this.licenseModal.style.display = "none";
                this.appShell.style.display = "flex";
                
                // Update mobile flag
                this.isMobile = window.innerWidth <= 768;
                
                this.updateAccessUI();
                this.maybeShowTrialExpiredBanner();
            }

            loadNavigation() {
                this.frontMatterList.innerHTML = "";
                BOOK_STRUCTURE.frontMatter.forEach((item) => {
                    this.frontMatterList.appendChild(this.createNavButton(item, "front", 0));
                });

                this.chapterList.innerHTML = "";
                BOOK_STRUCTURE.chapters.forEach((chapter, index) => {
                    this.chapterList.appendChild(this.createNavButton(chapter, "chapter", index + 1));
                });

                this.backMatterList.innerHTML = "";
                BOOK_STRUCTURE.backMatter.forEach((item) => {
                    this.backMatterList.appendChild(this.createNavButton(item, "back", 0));
                });
            }

            createNavButton(item, type, chapterNumber) {
                const li = document.createElement("li");
                const btn = document.createElement("button");
                btn.className = "nav-link";
                btn.dataset.file = item.file;
                btn.dataset.sectionType = type;
                btn.dataset.chapterNumber = String(chapterNumber);

                const mainRow = document.createElement("div");
                mainRow.className = "nav-link-main";

                const labelSpan = document.createElement("span");
                labelSpan.className = "nav-link-label";
                labelSpan.textContent = item.label;

                const badgeSpan = document.createElement("span");
                badgeSpan.className = "nav-link-badge";
                badgeSpan.textContent = item.badge || "";

                mainRow.appendChild(labelSpan);
                mainRow.appendChild(badgeSpan);

                const metaRow = document.createElement("div");
                metaRow.className = "nav-link-meta";
                if (type === "chapter") {
                    if (this.licenseManager.canAccessSection("chapter", chapterNumber, item.file)) {
                        if (this.licenseManager.hasActiveLicense()) {
                            metaRow.textContent = `Chapter ${chapterNumber} ‚Ä¢ Full access`;
                            btn.classList.remove("trial-only");
                        } else {
                            metaRow.textContent = `Chapter ${chapterNumber} ‚Ä¢ Trial access`;
                            btn.classList.add("trial-only");
                        }
                    } else {
                        metaRow.innerHTML = `<span class="nav-link-locked">Locked ‚Ä¢ Requires full license</span>`;
                        btn.classList.remove("trial-only");
                    }
                } else if (type === "front") {
                    // Title page is the only front-matter item accessible without account
                    if (item.file === "TITLE_PAGE.htm" || this.licenseManager.canAccessSection("front", 0, item.file)) {
                        metaRow.textContent = item.file === "TITLE_PAGE.htm" ? "Title Page" : "Front matter";
                    } else {
                        metaRow.innerHTML = `<span class="nav-link-locked">Locked ‚Ä¢ Requires full license</span>`;
                    }
                } else {
                    if (this.licenseManager.canAccessSection("back", 0, item.file)) {
                        metaRow.textContent = "Back matter";
                    } else {
                        metaRow.innerHTML = `<span class="nav-link-locked">Locked ‚Ä¢ Requires full license</span>`;
                    }
                }

                btn.appendChild(mainRow);
                btn.appendChild(metaRow);

                btn.addEventListener("click", () => {
                    if (!this.licenseManager.canAccessSection(type, chapterNumber, item.file)) {
                        this.showTrialLimitation();
                        return;
                    }
                    this.openSection(item.file, item.label, chapterNumber, item.id, type);
                });

                li.appendChild(btn);
                return li;
            }

            updateAccessUI() {
                const accessType = this.licenseManager.getAccessType();
                const email = this.licenseManager.getUserEmail();
                const remainingDays = this.licenseManager.getRemainingTrialDays();

                this.userEmailSpan.textContent = email || "Not logged in";

                // reset styles
                if (this.licenseStatusContainer) {
                    this.licenseStatusContainer.classList.remove("license-status-full");
                }
                this.activateBtn.classList.remove("active-license");
                this.activateBtn.disabled = false;

                if (accessType === "full") {
                    this.licenseTypeDisplay.textContent = "Full Version ‚Ä¢ 11/11 Chapters";
                    this.trialBadge.style.display = "none";
                    this.chapterLimitEl.textContent = "(11/11)";
                    this.upgradeButton.style.display = "none";
                    this.activateBtn.style.display = "inline-flex";
                    this.activateBtn.textContent = "License Active";
                    this.licenseStatusEl.textContent = "Full Version";
                    this.licenseDot.style.background = "#22c55e";
                    this.trialInfoPill.style.display = "none";
                    this.upgradeBanner.style.display = "none";

                    if (this.licenseStatusContainer) {
                        this.licenseStatusContainer.classList.add("license-status-full");
                    }
                    this.activateBtn.classList.add("active-license");
                    this.activateBtn.disabled = true;
                } else if (accessType === "trial") {
                    this.licenseTypeDisplay.textContent = `Trial ‚Ä¢ ${CONFIG.TRIAL_CHAPTERS}/11 Chapters ‚Ä¢ ${remainingDays} days left`;
                    this.trialBadge.style.display = "inline-block";
                    this.chapterLimitEl.textContent = `(${CONFIG.TRIAL_CHAPTERS}/11)`;
                    // Show upgradeButton as the primary top-right CTA with 'Activate License'
                    this.upgradeButton.style.display = "inline-flex";
                    this.upgradeButton.textContent = "Activate License";
                    // Hide the separate activate button while trial is active
                    this.activateBtn.style.display = "none";
                    this.licenseStatusEl.textContent = `Trial Active ‚Ä¢ ${remainingDays} days left`;
                    this.licenseDot.style.background = "#f97316";
                    this.trialInfoPill.style.display = "inline-flex";
                    this.trialInfoPill.textContent = `${CONFIG.TRIAL_CHAPTERS} chapters ‚Ä¢ ${remainingDays} days left`;
                    // Trial active: hide signup CTA on bottom banner; only show upgrade
                    if (this.upgradeBanner) this.upgradeBanner.style.display = "block";
                    if (this.signupTrialButton) this.signupTrialButton.style.display = "none";
                    if (this.upgradeNowBtn) {
                        this.upgradeNowBtn.style.display = "inline-flex";
                        this.upgradeNowBtn.textContent = "Activate License";
                    }
                } else {
                    this.licenseTypeDisplay.textContent = "No Access";
                    this.trialBadge.style.display = "none";
                    this.chapterLimitEl.textContent = "(0/11)";
                    this.upgradeButton.style.display = "inline-flex";
                    // No access: top-right CTAs invite signup for trial or upgrade for full access
                    this.upgradeButton.textContent = "Signup for Trial";
                    this.activateBtn.style.display = "inline-flex";
                    this.activateBtn.textContent = "Upgrade for Full Access";
                    this.licenseStatusEl.textContent = "No Access";
                    this.licenseDot.style.background = "#ef4444";
                    this.trialInfoPill.style.display = "none";
                    // Show bottom banner offering trial signup or upgrade
                    if (this.upgradeBanner) this.upgradeBanner.style.display = "block";
                    if (this.upgradeBannerMessage) this.upgradeBannerMessage.textContent = "Get started ‚Äî sign up for a free 7-day trial or upgrade for full access.";
                    if (this.signupTrialButton) this.signupTrialButton.style.display = "inline-flex";
                    if (this.upgradeNowBtn) {
                        this.upgradeNowBtn.style.display = "inline-flex";
                        this.upgradeNowBtn.textContent = "Upgrade for Full Access";
                    }
                }

                // Update nav meta labels based on current access state (covers front, chapter, back)
                document.querySelectorAll(".nav-link").forEach((btn) => {
                    const sectionType = btn.dataset.sectionType;
                    const chapterNumber = Number(btn.dataset.chapterNumber || "0");
                    const file = btn.dataset.file;
                    const metaRow = btn.querySelector(".nav-link-meta");
                    if (!metaRow) return;

                    const hasLicense = this.licenseManager.hasActiveLicense();
                    const hasTrial = this.licenseManager.hasActiveTrial();

                    if (sectionType === "chapter") {
                        if (hasLicense) {
                            metaRow.textContent = `Chapter ${chapterNumber} ‚Ä¢ Full access`;
                            btn.classList.remove("trial-only");
                        } else if (hasTrial && chapterNumber <= CONFIG.TRIAL_CHAPTERS) {
                            metaRow.textContent = `Chapter ${chapterNumber} ‚Ä¢ Trial access`;
                            btn.classList.add("trial-only");
                        } else if (!hasLicense && !hasTrial && chapterNumber <= CONFIG.TRIAL_CHAPTERS) {
                            metaRow.textContent = `Chapter ${chapterNumber} ‚Ä¢ Trial access (after signup)`;
                            btn.classList.add("trial-only");
                        } else {
                            metaRow.innerHTML = `<span class="nav-link-locked">Locked ‚Ä¢ Requires full license</span>`;
                            btn.classList.remove("trial-only");
                        }
                    } else if (sectionType === "front") {
                        if (file === "TITLE_PAGE.htm") {
                            metaRow.textContent = "Title Page";
                        } else if (hasLicense) {
                            metaRow.textContent = "Front matter";
                        } else {
                            metaRow.innerHTML = `<span class="nav-link-locked">Locked ‚Ä¢ Requires full license</span>`;
                        }
                    } else if (sectionType === "back") {
                        if (hasLicense) {
                            metaRow.textContent = "Back matter";
                        } else {
                            metaRow.innerHTML = `<span class="nav-link-locked">Locked ‚Ä¢ Requires full license</span>`;
                        }
                    }
                });
            }

            openSection(file, label, chapterNumber, sectionId, type = "") {
                if (!file) return;

                // HARD GATE: no code path can open a locked chapter
                if (!this.licenseManager.canAccessSection(type, chapterNumber, file)) {
                    this.showTrialLimitation();
                    return;
                }

                this.loadingOverlay.style.display = "flex";
                
                // Set handlers BEFORE changing src
                this.readerFrame.onload = () => {
                    this.loadingOverlay.style.display = "none";
                    applyReaderTypographyToIframe(this.readerFrame);
                };
                
                this.readerFrame.onerror = () => {
                    this.loadingOverlay.style.display = "none";
                    alert(`Error loading "${label}". Please check if the file "${file}" exists.`);
                };
                
                // Now set the source
                this.readerFrame.src = file;
                
                this.currentLabel.textContent = label;
                this.currentFile = file;
                this.currentChapter = chapterNumber;

                if (type === "chapter" && chapterNumber > 0) {
                    this.positionPill.textContent = `Chapter ${chapterNumber} of 11`;
                } else if (type === "front") {
                    this.positionPill.textContent = "Front matter";
                } else if (type === "back") {
                    this.positionPill.textContent = "Back matter";
                } else {
                    this.positionPill.textContent = "";
                }

                this.currentIndex = this.allSections.findIndex(
                    (s) => s.file === file && s.id === sectionId
                );

                this.updateNavButtons();
                this.trialLimitation.style.display = "none";
                this.upgradeBanner.style.display = "none";

                document.querySelectorAll(".nav-link").forEach((btn) => btn.classList.remove("active"));
                const activeBtn = document.querySelector(`.nav-link[data-file="${file}"]`);
                if (activeBtn) {
                    activeBtn.classList.add("active");
                    const section = activeBtn.closest(".nav-section");
                    if (section) section.classList.remove("collapsed");
                }
            }

            updateNavButtons() {
                if (this.currentIndex <= 0) {
                    this.prevBtn.classList.add("nav-disabled");
                } else {
                    this.prevBtn.classList.remove("nav-disabled");
                }

                if (this.currentIndex >= this.allSections.length - 1 || this.currentIndex === -1) {
                    this.nextBtn.classList.add("nav-disabled");
                } else {
                    this.nextBtn.classList.remove("nav-disabled");
                }
            }

            navigateToPrevious() {
                if (this.currentIndex > 0) {
                    const prevSection = this.allSections[this.currentIndex - 1];
                    const chapterNumber = prevSection.type === "chapter" ? prevSection.chapterNumber : 0;
                    if (!this.licenseManager.canAccessSection(prevSection.type, chapterNumber, prevSection.file)) {
                        this.showTrialLimitation();
                        return;
                    }
                    this.openSection(
                        prevSection.file,
                        prevSection.label,
                        chapterNumber,
                        prevSection.id,
                        prevSection.type
                    );
                }
            }

            navigateToNext() {
                if (this.currentIndex < this.allSections.length - 1 && this.currentIndex !== -1) {
                    const nextSection = this.allSections[this.currentIndex + 1];
                    const chapterNumber = nextSection.type === "chapter" ? nextSection.chapterNumber : 0;
                    if (!this.licenseManager.canAccessSection(nextSection.type, chapterNumber, nextSection.file)) {
                        this.showTrialLimitation();
                        return;
                    }
                    this.openSection(
                        nextSection.file,
                        nextSection.label,
                        chapterNumber,
                        nextSection.id,
                        nextSection.type
                    );
                }
            }

            showTrialLimitation() {
                if (this.trialLimitation) this.trialLimitation.style.display = "block";
                const msgEl = document.getElementById("upgradeBannerMessage");
                if (msgEl) {
                    msgEl.textContent = "Access Restricted ‚Äî Chapters 3‚Äì11 require a full license.";
                }
                if (this.upgradeBanner) this.upgradeBanner.style.display = "block";
            }

            maybeShowTrialExpiredBanner() {
                const flag = localStorage.getItem("infinityLoopTrialExpiredFlag");
                if (flag === "1" && !this.licenseManager.hasActiveLicense()) {
                    const msgEl = document.getElementById("upgradeBannerMessage");
                    if (msgEl) {
                        msgEl.textContent =
                            "Your trial has expired ‚Äì please upgrade to continue reading Chapters 3‚Äì11.";
                    }
                    if (this.trialLimitation) {
                        this.trialLimitation.style.display = "none";
                    }
                    // Show upgrade-only banner when a previous trial just expired
                    if (this.upgradeBanner) {
                        this.upgradeBanner.style.display = "block";
                    }
                    if (this.signupTrialButton) this.signupTrialButton.style.display = "none";
                    localStorage.removeItem("infinityLoopTrialExpiredFlag");
                }
            }

            async activateLicense(licenseKey) {
                const email = this.licenseManager.getUserEmail() || prompt("Email associated with this license:");
                if (!email) {
                    alert("Email is required to activate license.");
                    return;
                }
                let name = this.licenseManager.getUserName();
                if (!name) {
                    name = prompt("Name associated with this license (optional):") || "";
                }

                // If a Make webhook is configured, perform activation check first
                if (CONFIG.MAKE_WEBHOOK_URL) {
                    try {
                        const payload = { type: "activationcheck", email };
                        const res = await fetch(CONFIG.MAKE_WEBHOOK_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload),
                        });

                        if (!res.ok) {
                            alert("Activation check failed (network). Please try again later.");
                            return;
                        }

                        let json = null;
                        try {
                            json = await res.json();
                        } catch (e) {
                            alert("Activation check returned an unexpected response. Please try again later.");
                            return;
                        }

                        // Expecting a JSON response with { valid: true } for success
                        if (!json || !json.valid) {
                            alert(json && json.message ? json.message : "License activation check failed. Please verify your email or contact support.");
                            return;
                        }
                        // else continue to activate locally
                    } catch (err) {
                        console.warn("Activation check error:", err);
                        alert("Activation check failed (error). Please try again later.");
                        return;
                    }
                }

                try {
                    const data = this.licenseManager.activateLicense(licenseKey, email, name);
                    alert("License activated successfully!");
                    this.sendToMake("license_activation", {
                        email,
                        name,
                        licenseKey: data.licenseKey,
                        deviceId: data.deviceId,
                        isMaster: data.isMaster || false,
                    });
                    this.updateAccessUI();
                    // After activating license, ensure top-right buttons reflect full access
                    if (this.upgradeButton) this.upgradeButton.style.display = "none";
                    if (this.activateBtn) {
                        this.activateBtn.style.display = "inline-flex";
                        this.activateBtn.textContent = "License Active";
                    }
                    this.licenseModal.style.display = "none";
                } catch (err) {
                    alert(err.message || "Failed to activate license. Please verify your key.");
                }
            }

            startTrial(email, name) {
                if (!this.validateEmail(email)) {
                    alert("Please enter a valid email address.");
                    return;
                }
                const agreeTerms = document.getElementById("agreeTerms");
                if (agreeTerms && !agreeTerms.checked) {
                    alert("You must agree to the Terms of Service to continue.");
                    return;
                }
                this.licenseManager.saveUser(email, name);
                const trialData = this.licenseManager.startTrial(email, name);
                // Send full trial payload to Make webhook (JSON)
                this.sendToMake("trial_signup", {
                    email,
                    name: name || "",
                    accessType: "trial",
                    agreedToTerms: true,
                    trial: trialData,
                });
                this.showApp();
                this.updateAccessUI();
                // Hide signup CTA after trial is started; keep upgrade visible
                if (this.signupTrialButton) this.signupTrialButton.style.display = "none";
                if (this.upgradeNowBtn) this.upgradeNowBtn.style.display = "inline-flex";
                // Ensure we start the restricted reader on the Title Page
                this.openSection("TITLE_PAGE.htm", "Title Page", 0, "title-page", "front");
            }

            toggleSidebar() {
                if (this.isMobile) {
                    const isHidden = this.sidebar.style.display === "none" || 
                                    getComputedStyle(this.sidebar).display === "none";

                    this.sidebar.style.display = isHidden ? "block" : "none";
                    this.menuToggle.textContent = isHidden ? "‚úï" : "‚ò∞";
                } else {
                    // For desktop: collapse/expand the sidebar so the reader pane can take full width
                    const isNowCollapsed = this.sidebar.classList.toggle("collapsed");

                    if (isNowCollapsed) {
                        // hide the sidebar to expand reading pane
                        this.sidebar.style.display = "none";
                        this.menuToggle.textContent = "‚ò∞"; // show open icon
                    } else {
                        // restore sidebar
                        this.sidebar.style.display = "block";
                        this.menuToggle.textContent = "‚úï"; // show close icon
                    }
                }
            }

            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            sendToMake(eventType, data) {
                if (!CONFIG.MAKE_WEBHOOK_URL) return;
                const payload = {
                    eventType,
                    appVersion: CONFIG.APP_VERSION,
                    timestamp: new Date().toISOString(),
                    deviceId: this.licenseManager.deviceId,
                    ...data,
                };
                try {
                    fetch(CONFIG.MAKE_WEBHOOK_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(payload),
                    }).catch((err) => console.warn("Webhook error (non-blocking):", err));
                } catch (err) {
                    console.warn("Webhook send error:", err);
                }
            }

            showTerms() {
                alert(
                    "Terms of Service:\n\n" +
                        "1. Trial lasts 7 days\n" +
                        "2. Email required for trial\n" +
                        "3. No spam; unsubscribe anytime\n" +
                        "4. Full version requires purchase\n" +
                        "5. One license per device"
                );
            }

            showLicenseAgreement() {
                alert(
                    "License Agreement:\n\n" +
                        "1. License grants access to all chapters\n" +
                        "2. One license per device\n" +
                        "3. Non-transferable\n" +
                        "4. Updates included for 1 year"
                );
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            new InfinityLoopApp();
        });
    </script>

    <!-- CONTENT PROTECTION SYSTEM -->
    <script>
        (function () {
            "use strict";
            class ContentProtection {
                constructor() {
                    this.init();
                }
                init() {
                    this.disableContextMenu();
                    this.disableKeyShortcuts();
                    this.disableDragSelect();
                }
                disableContextMenu() {
                    document.addEventListener(
                        "contextmenu",
                        (e) => {
                            e.preventDefault();
                        },
                        false
                    );
                }
                disableKeyShortcuts() {
                    document.addEventListener("keydown", (e) => {
                        if (
                            e.key === "PrintScreen" ||
                            (e.ctrlKey && (e.key === "p" || e.key === "s")) ||
                            (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "i")) ||
                            (e.metaKey && (e.key === "p" || e.key === "s"))
                        ) {
                            e.preventDefault();
                        }
                    });
                }
                disableDragSelect() {
                    document.addEventListener("dragstart", (e) => e.preventDefault());
                    document.addEventListener("selectstart", (e) => e.preventDefault());
                }
            }
            new ContentProtection();
        })();
    </script>
</body>
</html>