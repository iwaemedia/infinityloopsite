<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Infinity Loop Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="description" content="Interactive reader for The Infinity Loop - Mapping the Machinery of Power, Policy, and Profit">
  <meta name="author" content="The Infinity Loop">
  
  <style>
    /* ========== CSS VARIABLES ========== */
    :root {
      --bg: #050608;
      --bg-elevated: #10131a;
      --text: #f4f5f7;
      --muted: #9ca3af;
      --border: #1f2933;
      --nav-width: 280px;
      --accent: #e63946;
      --accent-soft: rgba(230, 57, 70, 0.18);
      --accent-warm: #f59e0b;
      --accent-warm-soft: rgba(245, 158, 11, 0.16);
      --radius: 14px;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-strong: 0 25px 50px rgba(0, 0, 0, 0.8);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ========== BASE STYLES ========== */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #111827 0%, #020308 55%, #000000 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none;
    }

    /* ========== ENHANCED SPLASH SCREEN ========== */
    .splash-entrance {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0e1a 0%, #000000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out;
    }

    .splash-entrance::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(230, 57, 70, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
      animation: pulse 4s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      100% { opacity: 0.7; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ==== SPLASH LAYOUT FIX: keep cover fully visible ==== */
    .splash-card {
      max-width: 520px;
      width: 100%;
      padding: 24px 24px 32px;
      border-radius: 28px;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.06), rgba(13, 16, 24, 0.98));
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.65),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      animation: cardAppear 0.8s ease-out 0.3s both;
    }

    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Make sure the cover is a normal block element, not a background layer */
    .splash-cover {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 20px;
      object-fit: cover;
      box-shadow: 
        var(--shadow-strong),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        0 0 60px rgba(230, 57, 70, 0.2);
      transition: var(--transition);
      cursor: pointer;
    }

    .splash-cover:hover {
      transform: scale(1.02) rotate(1deg);
      box-shadow: 
        0 30px 70px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(255, 255, 255, 0.08),
        0 0 100px rgba(230, 57, 70, 0.3);
    }

    /* Stack title + subtitle below the image with breathing room */
    .splash-title {
      margin-top: 8px;
      margin-bottom: 4px;
      text-align: center;
      font-size: clamp(1.8rem, 4vw, 2.2rem);
      font-weight: 800;
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.1;
      animation: slideUp 0.5s ease-out 0.5s both;
    }

    .splash-subtitle {
      margin: 0 0 8px 0;
      text-align: center;
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      color: rgba(255, 255, 255, 0.8);
      font-weight: 300;
      letter-spacing: 0.05em;
      max-width: 400px;
      animation: slideUp 0.5s ease-out 0.6s both;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Force the button to sit BELOW the text, not over the image */
    #enterBookBtn,
    .splash-cta,
    .splash-button {
      position: static !important;
      transform: none !important;
      bottom: auto !important;
      left: auto !important;
      right: auto !important;
      margin-top: 8px;
      align-self: stretch;
      justify-content: center;
      animation: slideUp 0.5s ease-out 0.7s both;
    }

    .splash-button {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 9999px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 
        0 10px 30px rgba(230, 57, 70, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 54px;
      width: 100%;
    }

    .splash-button:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 20px 40px rgba(230, 57, 70, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .splash-button:active {
      transform: translateY(-1px);
    }

    .splash-button span {
      font-size: 1.2rem;
      transition: transform 0.2s ease;
    }

    .splash-button:hover span {
      transform: translateX(4px);
    }

    .splash-tagline {
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-top: 4px;
      animation: fadeIn 0.8s ease-out 0.8s both;
    }

    /* On very small screens, keep everything nicely padded */
    @media (max-width: 600px) {
      .splash-card {
        margin: 16px;
        padding: 20px 18px 26px;
        max-width: calc(100vw - 32px);
      }

      .splash-cover {
        border-radius: 18px;
      }

      .splash-title {
        font-size: 1.6rem;
      }

      .splash-subtitle {
        font-size: 0.9rem;
      }

      .splash-button {
        padding: 14px 30px;
        font-size: 1rem;
      }
    }

    /* ========== MODALS ========== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      backdrop-filter: blur(10px);
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        backdrop-filter: blur(0px);
      }
      to {
        opacity: 1;
        backdrop-filter: blur(10px);
      }
    }

    .modal-content {
      background: linear-gradient(135deg, #111827 0%, #020308 100%);
      border-radius: 24px;
      padding: clamp(20px, 5vw, 40px);
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--accent);
      box-shadow: 0 20px 60px rgba(230, 57, 70, 0.3);
      text-align: center;
      animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-content h2 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: clamp(1.5rem, 4vw, 28px);
      font-weight: 700;
    }

    .modal-content p {
      color: var(--muted);
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .email-input,
    .license-input {
      width: 100%;
      padding: 15px 20px;
      background: rgba(31, 41, 55, 0.8);
      border: 2px solid var(--accent);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      margin-bottom: 15px;
      text-align: center;
      transition: var(--transition);
    }

    .email-input:focus,
    .license-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.3);
    }

    .license-input {
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #ff6b6b);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
      min-height: 48px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4);
    }

    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
      padding: 10px 25px;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      min-height: 48px;
      min-width: 150px;
      transition: var(--transition);
    }

    .btn-secondary:hover {
      background: var(--accent-soft);
      transform: translateY(-2px);
    }

    .license-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* ========== MAIN APP SHELL ========== */
    .app-shell {
      display: flex;
      height: 100vh;
      padding: 16px;
      gap: 16px;
      opacity: 0;
      animation: appFadeIn 0.5s ease-out 0.3s forwards;
    }

    @keyframes appFadeIn {
      to {
        opacity: 1;
      }
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: var(--nav-width);
      background: rgba(3, 7, 18, 0.96);
      border-radius: var(--radius);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow);
      overflow-y: auto;
      overflow-x: hidden;
      backdrop-filter: blur(10px);
    }

    .brand {
      padding: 4px 8px 6px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
      margin-bottom: 4px;
    }

    .brand-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    .progress-block {
      margin-top: 8px;
      padding: 6px 8px 6px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(75, 85, 99, 0.7);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .progress-header-row button {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 10px;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .progress-header-row button:hover {
      color: var(--text);
    }

    .progress-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 10px;
      color: var(--muted);
    }

    .progress-item-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 9999px;
      background: rgba(31, 41, 55, 0.9);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 9999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-warm));
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-section {
      margin-top: 4px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: var(--muted);
      padding: 8px 10px 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      transition: color 0.2s ease;
    }

    .nav-section-title:hover {
      color: var(--text);
    }

    .nav-section-title::after {
      content: "â–¸";
      font-size: 10px;
      opacity: 0.7;
      transition: transform 0.3s ease;
    }

    .nav-section.collapsed .nav-section-title::after {
      content: "â–¸";
      transform: rotate(-90deg);
    }

    .nav-section:not(.collapsed) .nav-section-title::after {
      content: "â–¾";
      transform: rotate(0deg);
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 500px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
      -webkit-overflow-scrolling: touch;
    }

    .nav-section.collapsed .nav-list {
      max-height: 0;
      overflow: hidden;
    }

    .nav-item {
      margin: 2px 0;
    }

    .nav-link {
      width: 100%;
      text-align: left;
      border-radius: 9999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      position: relative;
      min-height: 32px;
    }

    .nav-link .badge {
      font-size: 10px;
      opacity: 0.8;
      margin-left: auto;
      padding-left: 8px;
    }

    .nav-link:hover {
      background: rgba(31, 41, 55, 0.8);
      color: #f9fafb;
      border-color: rgba(75, 85, 99, 0.9);
      transform: translateX(2px);
    }

    .nav-link.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: var(--accent);
      font-weight: 600;
    }

    .nav-link[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .nav-footer {
      margin-top: auto;
      padding: 8px 10px 4px;
      font-size: 11px;
      color: var(--muted);
      border-top: 1px solid rgba(55, 65, 81, 0.9);
    }

    .nav-footer .label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
      display: block;
      margin-bottom: 5px;
    }

    .loop-tags {
      margin-top: 5px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .loop-tag {
      border-radius: 9999px;
      padding: 2px 7px;
      border: 1px solid var(--accent-warm-soft);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--accent-warm);
      background: rgba(31, 41, 55, 0.8);
      white-space: nowrap;
    }

    /* ========== READER PANE ========== */
    .reader-pane {
      flex: 1;
      border-radius: var(--radius);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .reader-header {
      padding: 10px 16px;
      border-bottom: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.8);
    }

    .reader-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .menu-toggle {
      border-radius: 9999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      min-height: 44px;
    }

    .menu-toggle:hover {
      background: rgba(31, 41, 55, 0.95);
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.7);
    }

    .reader-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .reader-title span {
      color: #e5e7eb;
      font-weight: 600;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .reader-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .reader-meta .dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: rgba(148, 163, 184, 0.8);
      flex-shrink: 0;
    }

    .reader-meta button {
      border-radius: 9999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      padding: 8px 12px;
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      min-width: 44px;
      min-height: 44px;
    }

    .reader-meta button:hover {
      background: rgba(31, 41, 55, 0.95);
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.7);
    }

    .reader-iframe-wrap {
      flex: 1;
      background: #ffffff;
      position: relative;
      overflow: hidden;
    }

    .reader-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #ffffff;
      display: block;
    }

    /* ========== TRIAL LIMITATION OVERLAY ========== */
    .trial-limitation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border-radius: 16px;
      border: 2px solid var(--accent);
      text-align: center;
      max-width: 400px;
      width: 90%;
      z-index: 1000;
      display: none;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
      animation: modalSlideIn 0.3s ease-out;
    }

    .trial-limitation h3 {
      color: var(--accent);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .trial-limitation p {
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.5;
    }

    /* ========== LOADING OVERLAY ========== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========== PROGRESS INDICATOR ========== */
    .progress-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 10px 15px;
      font-size: 12px;
      color: var(--text);
      z-index: 100;
      display: none;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--accent);
    }

    .progress-indicator.active {
      display: flex;
    }

    .progress-indicator .fill {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: conic-gradient(var(--accent) 0% 0%, transparent 0% 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-indicator .fill span {
      font-size: 8px;
      font-weight: bold;
    }

    /* ========== RESPONSIVE DESIGN ========== */
    /* Tablet and Desktop */
    @media (min-width: 769px) {
      .app-shell {
        flex-direction: row;
      }
      
      .sidebar {
        width: var(--nav-width);
        flex-direction: column;
        max-height: 100%;
      }
      
      .menu-toggle {
        display: none;
      }
    }

    /* Mobile Devices (Phones) */
    @media (max-width: 768px) {
      .app-shell {
        flex-direction: column;
        padding: 8px;
        gap: 8px;
        height: 100vh;
      }
      
      .sidebar {
        width: 100%;
        max-height: 40vh;
        overflow-y: auto;
        padding: 10px;
        order: 2;
        margin-top: 8px;
      }
      
      .reader-pane {
        order: 1;
        height: 55vh;
        min-height: 300px;
      }
      
      .reader-header {
        padding: 8px 12px;
        flex-wrap: wrap;
      }
      
      .reader-header-left {
        width: 100%;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      
      .reader-meta {
        width: 100%;
        justify-content: space-between;
        font-size: 10px;
      }
      
      .menu-toggle {
        display: flex;
      }
      
      .brand {
        padding: 8px;
      }
      
      .nav-section-title {
        padding: 10px 12px;
        font-size: 12px;
      }
      
      .nav-link {
        padding: 10px 12px;
        font-size: 11px;
        min-height: 44px;
      }
      
      .nav-list {
        max-height: 200px;
      }
      
      /* Mobile touch improvements */
      button, .nav-link, .nav-section-title {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Prevent text selection */
      .nav-link, .nav-section-title, button {
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      
      /* Better scrolling */
      .sidebar, .nav-list {
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Small Mobile Devices */
    @media (max-width: 480px) {
      .splash-card {
        margin: 12px;
        padding: 16px 14px 22px;
      }
      
      .splash-cover {
        border-radius: 16px;
      }
      
      .splash-title {
        font-size: 1.4rem;
      }
      
      .splash-subtitle {
        font-size: 0.85rem;
      }
      
      .splash-button {
        padding: 12px 24px;
        font-size: 0.95rem;
        min-height: 48px;
      }
      
      .sidebar {
        max-height: 35vh;
      }
      
      .reader-pane {
        height: 50vh;
      }
      
      .license-buttons {
        flex-direction: column;
        width: 100%;
      }
      
      .btn-secondary {
        width: 100%;
      }
    }

    /* Large Desktop */
    @media (min-width: 1200px) {
      .sidebar {
        width: 320px;
      }
      
      .nav-link {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

  <!-- ========== ENHANCED SPLASH SCREEN ========== -->
  <div class="splash-entrance" id="splashEntrance">
    <div class="splash-card">
      <img src="Front Cover.png" 
           alt="The Infinity Loop - Book Cover" 
           class="splash-cover" 
           id="bookCover">
      
      <h1 class="splash-title">The Infinity Loop</h1>
      <p class="splash-subtitle">Mapping the Machinery of Power, Policy, and Profit</p>
      
      <div class="splash-tagline">Enter the Loop â€¢ Discover the System</div>
      
      <button class="splash-button" id="enterBookBtn">
        Open The Infinity Loop
        <span>â†’</span>
      </button>
    </div>
  </div>

  <!-- ========== EMAIL MODAL ========== -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal-content">
      <h2>Start Your Free Trial</h2>
      <p>Enter your email address to access the first 2 chapters of The Infinity Loop for 7 days.</p>
      <p style="font-size: 14px; color: var(--muted);">No credit card required. Full version available with license.</p>
      
      <div class="email-input-group">
        <input type="email" 
               class="email-input" 
               id="trialEmail"
               placeholder="your@email.com"
               autocomplete="email"
               required>
        <div style="display: flex; align-items: flex-start; gap: 10px; margin-top: 15px;">
          <input type="checkbox" 
                 id="agreeTerms" 
                 style="width: auto; margin-top: 3px;">
          <label for="agreeTerms" style="font-size: 12px; text-align: left; color: var(--muted); line-height: 1.4;">
            I agree to receive updates and accept the 
            <a href="#" style="color: var(--accent); text-decoration: underline;" id="termsLink">Terms of Service</a>
          </label>
        </div>
      </div>
      
      <button class="btn-primary" id="startTrialWithEmail">
        Start Free Trial (2 Chapters)
      </button>
      
      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        Already have a license? 
        <a href="#" id="switchToLicense" style="color: var(--accent); text-decoration: underline;">Activate here</a>
      </p>
    </div>
  </div>

  <!-- ========== LICENSE MODAL ========== -->
  <div class="modal-overlay" id="licenseModal">
    <div class="modal-content">
      <h2>Activate Full Version</h2>
      <p>Enter your license key to unlock all 11 chapters.</p>
      
      <input type="text" 
             class="license-input" 
             id="licenseInput" 
             placeholder="XXXXX-XXXXX-XXXXX-XXXXX"
             maxlength="24"
             autocomplete="off">
      
      <div class="license-buttons">
        <button class="btn-primary" id="activateLicense">
          Activate License
        </button>
        <a href="https://your-store.com/purchase" 
           target="_blank" 
           class="btn-secondary" 
           id="purchaseLicense">
          Purchase License
        </a>
      </div>
      
      <p style="margin-top: 20px; font-size: 12px; color: var(--muted);">
        By activating, you agree to the 
        <a href="#" style="color: var(--accent); text-decoration: underline;" id="licenseAgreementLink">License Agreement</a>
      </p>
    </div>
  </div>

  <!-- ========== LOADING OVERLAY ========== -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- ========== PROGRESS INDICATOR ========== -->
  <div class="progress-indicator" id="progressIndicator">
    <div class="fill" id="progressCircle">
      <span>0%</span>
    </div>
    <span>Saving progress...</span>
  </div>

  <!-- ========== MAIN APPLICATION ========== -->
  <div class="app-shell" id="app-shell">
    
    <!-- SIDEBAR NAVIGATION -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="brand-title">The Infinity Loop</div>
        <div class="brand-sub" id="licenseTypeDisplay">Trial Version â€¢ 2/11 Chapters</div>

        <div class="progress-block">
          <div class="progress-header-row">
            <span>Reading Progress</span>
            <button id="progress-reset" type="button">Reset</button>
          </div>

          <div class="progress-item">
            <div class="progress-item-label">
              <span>Overall (chapters)</span>
              <span id="overall-progress-label">0 / 2</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="overall-progress-fill"></div>
            </div>
          </div>

          <div class="progress-item">
            <div class="progress-item-label">
              <span>Current chapter</span>
              <span id="chapter-progress-label">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="chapter-progress-fill"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- FRONT MATTER SECTION -->
      <div class="nav-section collapsed" data-section="front">
        <div class="nav-section-title">
          Front Matter
        </div>
        <ul class="nav-list" id="frontMatterList">
          <!-- Front matter items loaded dynamically -->
        </ul>
      </div>

      <!-- CORE CHAPTERS SECTION -->
      <div class="nav-section collapsed" data-section="chapters">
        <div class="nav-section-title">
          Core Chapters <span id="chapterLimit">(2/11)</span>
        </div>
        <ul class="nav-list" id="chapterList">
          <!-- Chapters loaded dynamically -->
        </ul>
      </div>

      <!-- BACK MATTER SECTION -->
      <div class="nav-section collapsed" data-section="back">
        <div class="nav-section-title">
          Back Matter
        </div>
        <ul class="nav-list" id="backMatterList">
          <!-- Back matter items loaded dynamically -->
        </ul>
      </div>

      <div class="nav-footer">
        <span class="label">Loop Archetypes</span>
        <div class="loop-tags">
          <span class="loop-tag">Surveillance</span>
          <span class="loop-tag">Criminalization</span>
          <span class="loop-tag">Extraction</span>
          <span class="loop-tag">Destabilization</span>
          <span class="loop-tag">Resistance</span>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: var(--muted);">
          <div id="userInfo">Logged in as: <span id="userEmail">Loading...</span></div>
          <button id="upgradeButton" 
                  style="background: none; border: 1px solid var(--accent); color: var(--accent); padding: 6px 12px; border-radius: 4px; margin-top: 5px; font-size: 9px; cursor: pointer; min-height: 32px;">
            Upgrade to Full Version
          </button>
        </div>
      </div>
    </aside>

    <!-- MAIN READER PANE -->
    <main class="reader-pane" id="readerPane">
      <div class="reader-header">
        <div class="reader-header-left">
          <button id="menu-toggle" class="menu-toggle">
            â˜°
          </button>
          <div class="reader-title">
            Currently viewing: <span id="current-label">â€”</span>
            <span id="trialBadge" 
                  style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">
              TRIAL
            </span>
          </div>
        </div>
        <div class="reader-meta">
          <span id="licenseStatus">Trial Active</span>
          <span class="dot"></span>
          <span>Local offline reader</span>
          <button id="bookmark-btn">
            Bookmark
          </button>
          <button id="activateBtn" style="background: var(--accent-soft); color: var(--accent);">
            Activate License
          </button>
        </div>
      </div>
      <div class="reader-iframe-wrap">
        <!-- TRIAL LIMITATION OVERLAY -->
        <div class="trial-limitation" id="trialLimitation">
          <h3>Chapter Locked</h3>
          <p>This chapter is only available in the full version.</p>
          <p>Upgrade to unlock all 11 chapters and full features.</p>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
            <button class="btn-primary" id="upgradeNow">
              Upgrade Now
            </button>
            <button class="btn-secondary" onclick="document.getElementById('trialLimitation').style.display='none'">
              Continue Trial
            </button>
          </div>
        </div>
        
        <!-- MAIN CONTENT IFRAME -->
        <iframe id="reader-frame"
                class="reader-iframe"
                title="Book content">
        </iframe>
      </div>
    </main>
  </div>

  <script>
    (function() {
      'use strict';

      // ========== CONFIGURATION ==========
      const CONFIG = {
        APP_VERSION: '2.0.0',
        TRIAL_CHAPTERS: 2,
        TRIAL_DAYS: 7,
        TEST_LICENSE: "INF-TEST-2024-ABCD-5678",
        VALID_LICENSE_PREFIX: "INF-",
        PURCHASE_URL: "https://your-store.com/purchase"
      };

      // ========== STATE MANAGEMENT ==========
      let currentFile = '';
      let currentChapter = 0;
      let scrollInterval = null;
      let isMobile = window.innerWidth <= 768;

      // ========== DOM ELEMENTS ==========
      const splashEntrance = document.getElementById('splashEntrance');
      const emailModal = document.getElementById('emailModal');
      const licenseModal = document.getElementById('licenseModal');
      const appShell = document.getElementById('app-shell');
      const iframe = document.getElementById('reader-frame');
      const currentLabel = document.getElementById('current-label');
      const trialLimitation = document.getElementById('trialLimitation');
      const frontMatterList = document.getElementById('frontMatterList');
      const chapterList = document.getElementById('chapterList');
      const backMatterList = document.getElementById('backMatterList');
      const userEmailSpan = document.getElementById('userEmail');
      const licenseTypeDisplay = document.getElementById('licenseTypeDisplay');
      const trialBadge = document.getElementById('trialBadge');
      const upgradeButton = document.getElementById('upgradeButton');
      const activateBtn = document.getElementById('activateBtn');
      const enterBookBtn = document.getElementById('enterBookBtn');
      const bookCover = document.getElementById('bookCover');
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.getElementById('menu-toggle');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const progressIndicator = document.getElementById('progressIndicator');
      const progressCircle = document.getElementById('progressCircle');

      // Progress elements
      const overallFill = document.getElementById('overall-progress-fill');
      const overallLabel = document.getElementById('overall-progress-label');
      const chapterFill = document.getElementById('chapter-progress-fill');
      const chapterLabel = document.getElementById('chapter-progress-label');

      // ========== BOOK STRUCTURE ==========
      const BOOK_STRUCTURE = {
        frontMatter: [
          { 
            file: 'TITLE_PAGE.htm', 
            label: 'Title Page',
            alwaysAccessible: true
          },
          { 
            file: 'Dedication.htm', 
            label: 'Dedication',
            alwaysAccessible: true
          },
          { 
            file: 'Epigraph_.htm', 
            label: 'Epigraph',
            alwaysAccessible: true
          },
          { 
            file: 'CONTENT_WARNING_.htm', 
            label: 'Content Warning / Reader Care Note',
            alwaysAccessible: true
          },
          { 
            file: 'A_NOTE_ON_LANGUAGE_AND_TERMINOLOGY_.htm', 
            label: 'Note on Language and Terminology',
            alwaysAccessible: true
          },
          { 
            file: 'HOW_TO_USE_THIS_BOOK_A_READER\'S_GUIDE_.htm', 
            label: 'How to Use This Book: A Reader\'s Guide',
            alwaysAccessible: true
          },
          { 
            file: 'AUTHOR\'S_PREFACE_UNDERSTANDING_THE_INFINITY_LOOP_.htm', 
            label: 'Author\'s Preface: Understanding the Infinity Loop',
            alwaysAccessible: true
          },
          { 
            file: 'NOTE_ON_SOURCES_AND_METHODOLOGY_.htm', 
            label: 'Note on Sources and Methodology',
            alwaysAccessible: true
          }
        ],
        
        chapters: [
          { 
            file: 'CHAPTER_1_clean_stitched_formatted.htm', 
            label: 'CHAPTER 1: THE GENESIS: RECONSTRUCTION AND THE BLACK CODES',
            badge: '(1865 - 1877) LoopSnapshotðŸŸ¡6/10'
          },
          { 
            file: 'CHAPTER_2_clean_stitched_formatted.htm', 
            label: 'CHAPTER 2: THE REFINEMENT: JIM CROW AND THE RISE OF LEGALIZED APARTHEID',
            badge: '(1877 - 1919) LoopSnapshotðŸŸ¢8/10'
          },
          { 
            file: 'CHAPTER_3_clean_stitched_formatted.htm', 
            label: 'CHAPTER 3: MOBILIZATION AND BACKLASH: RED SUMMER, GARVEY, AND THE PROTO-COINTELPRO',
            badge: '(1919 - 1945) LoopSnapshotðŸ”´8/10'
          },
          { 
            file: 'CHAPTER_4_clean_stitched_formatted.htm', 
            label: 'CHAPTER 4: COLD WAR CONTRADICTIONS: VETERANS, MCGEE, AND "GENOCIDE"',
            badge: '(1946 - 1955) LoopSnapshotðŸ”´8/10'
          },
          { 
            file: 'CHAPTER_5_clean_stitched_formatted.htm', 
            label: 'CHAPTER 5: COINTELPRO PEAK: NEUTRALIZATION, KERNER, AND THE PANTHER\'S PRICE',
            badge: '(1956 - 1971) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_6_clean_stitched_formatted.htm', 
            label: 'CHAPTER 6: THE MODERN CARCERAL STATE: THE WAR ON DRUGS ESCALATES',
            badge: '(1972 - 1989) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_7_clean_stitched_formatted.htm', 
            label: 'CHAPTER 7: THE "COLORBLIND" ERA: PREDICTIVE POLICING AND MASS INCARCERATION',
            badge: '(1990 - 2009) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_8_clean_stitched_formatted.htm', 
            label: 'CHAPTER 8: DIGITAL AUGMENTATION: FERGUSON, BALTIMORE, AND ALGORITHMIC BIAS',
            badge: '(2010 - 2016) LoopSnapshotðŸ”´9/10'
          },
          { 
            file: 'CHAPTER_9_clean_stitched_formatted.htm', 
            label: 'CHAPTER 9: THE AUTOMATED LOOP: BIE LABELS, AI, AND THE FUTURE OF CONTROL',
            badge: '(2017 - 2024) LoopSnapshotðŸ”´ðŸŸ¡ðŸŸ¢10/10'
          },
          { 
            file: 'CHAPTER_10_clean_stitched_formatted.htm', 
            label: 'CHAPTER 10: THE RESILIENCE BLUEPRINT: RESISTANCE AND THRIVING WITHIN THE LOOP',
            badge: '(1619 - Present) LoopSnapshotðŸŸ¢8/10'
          },
          { 
            file: 'CHAPTER_11_clean_stitched_formatted.htm', 
            label: 'CHAPTER 11: THE ABOLITION HORIZON: FROM EVIDENCE TO ABOLITION',
            badge: '2025 AND BEYOND LoopSnapshotðŸ”´10/10'
          }
        ],
        
        backMatter: [
          { 
            file: 'APPENDIX_A_LOOP MECHANISM GLOSSARY_.htm', 
            label: 'Appendix A: Loop Mechanism Glossary',
            alwaysAccessible: true
          },
          { 
            file: 'APPENDIX_B_HISTORICAL TIMELINE (1619-2025)_.htm', 
            label: 'Appendix B: Historical Timeline (1619â€“2025)',
            alwaysAccessible: true
          },
          { 
            file: 'APPENDIX_C_METHODOLOGY AND SOURCES NOTE_.htm', 
            label: 'Appendix C: Methodology and Sources Note',
            alwaysAccessible: true
          },
          { 
            file: 'WORKS CITED.htm', 
            label: 'Works Cited',
            alwaysAccessible: true
          },
          { 
            file: 'Tiered_Works_Cited.htm', 
            label: 'Tiered Works Cited (by tier)',
            alwaysAccessible: true
          },
          { 
            file: 'CONSOLIDATED_WORKS_CITED.htm', 
            label: 'Consolidated Works Cited (master list)',
            alwaysAccessible: true
          },
          { 
            file: 'ACKNOWLEDGMENTS_.htm', 
            label: 'Acknowledgments',
            alwaysAccessible: true
          },
          { 
            file: 'ABOUT_THE_AUTHOR.htm', 
            label: 'About the Author',
            alwaysAccessible: true
          }
        ]
      };

      // ========== LICENSE MANAGER ==========
      class LicenseManager {
        constructor() {
          this.deviceId = this.getDeviceId();
          this.userData = this.loadUserData();
          this.licenseData = this.loadLicenseData();
          this.trialData = this.loadTrialData();
        }

        getDeviceId() {
          let deviceId = localStorage.getItem('infinityLoopDeviceId');
          if (!deviceId) {
            deviceId = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            localStorage.setItem('infinityLoopDeviceId', deviceId);
          }
          return deviceId;
        }

        loadUserData() {
          try {
            const data = localStorage.getItem('infinityLoopUser');
            return data ? JSON.parse(data) : null;
          } catch {
            return null;
          }
        }

        loadLicenseData() {
          try {
            const data = localStorage.getItem('infinityLoopLicense');
            if (!data) return null;
            
            const license = JSON.parse(data);
            if (license.expiry && new Date(license.expiry) < new Date()) {
              localStorage.removeItem('infinityLoopLicense');
              return null;
            }
            
            return license;
          } catch {
            return null;
          }
        }

        loadTrialData() {
          try {
            const data = localStorage.getItem('infinityLoopTrial');
            if (!data) return null;
            
            const trial = JSON.parse(data);
            if (trial.expiry && new Date(trial.expiry) < new Date()) {
              localStorage.removeItem('infinityLoopTrial');
              return null;
            }
            
            return trial;
          } catch {
            return null;
          }
        }

        saveUser(email) {
          const userData = {
            email: email,
            registered: new Date().toISOString(),
            deviceId: this.deviceId
          };
          localStorage.setItem('infinityLoopUser', JSON.stringify(userData));
          this.userData = userData;
          return userData;
        }

        startTrial(email) {
          const trialData = {
            email: email,
            startDate: new Date().toISOString(),
            expiry: new Date(Date.now() + CONFIG.TRIAL_DAYS * 24 * 60 * 60 * 1000).toISOString(),
            chaptersAllowed: CONFIG.TRIAL_CHAPTERS,
            deviceId: this.deviceId
          };
          localStorage.setItem('infinityLoopTrial', JSON.stringify(trialData));
          this.trialData = trialData;
          return trialData;
        }

        activateLicense(licenseKey, email) {
          if (!licenseKey.startsWith(CONFIG.VALID_LICENSE_PREFIX) && licenseKey !== CONFIG.TEST_LICENSE) {
            throw new Error('Invalid license key format');
          }

          const licenseData = {
            key: licenseKey,
            email: email || this.userData?.email,
            activated: new Date().toISOString(),
            expiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
            deviceId: this.deviceId
          };

          localStorage.setItem('infinityLoopLicense', JSON.stringify(licenseData));
          this.licenseData = licenseData;

          localStorage.removeItem('infinityLoopTrial');
          this.trialData = null;

          return licenseData;
        }

        hasActiveLicense() {
          return !!this.licenseData;
        }

        hasActiveTrial() {
          return !!this.trialData;
        }

        canAccessChapter(chapterNumber) {
          // Front and back matter are always accessible
          if (chapterNumber === 0) return true;
          
          if (this.hasActiveLicense()) return true;
          if (this.hasActiveTrial()) return chapterNumber <= CONFIG.TRIAL_CHAPTERS;
          return false;
        }

        canAccessFile(file) {
          // Check if file is a chapter
          const chapterMatch = file.match(/CHAPTER_(\d+)/);
          if (chapterMatch) {
            const chapterNumber = parseInt(chapterMatch[1]);
            return this.canAccessChapter(chapterNumber);
          }
          
          // Front and back matter are always accessible
          return true;
        }

        getUserEmail() {
          if (this.licenseData?.email) return this.licenseData.email;
          if (this.trialData?.email) return this.trialData.email;
          if (this.userData?.email) return this.userData.email;
          return '';
        }

        getAccessType() {
          if (this.hasActiveLicense()) return 'full';
          if (this.hasActiveTrial()) return 'trial';
          return 'none';
        }

        getRemainingTrialDays() {
          if (!this.trialData?.expiry) return 0;
          const expiry = new Date(this.trialData.expiry);
          const now = new Date();
          const diffTime = expiry - now;
          return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        }
      }

      // ========== INITIALIZE LICENSE MANAGER ==========
      const licenseManager = new LicenseManager();

      // ========== PROGRESS TRACKING SYSTEM ==========
      const progressData = {
        completedChapters: new Set(),
        chapterProgress: {},
        visitedChapters: new Set(),
        bookmarks: {}
      };

      function loadProgress() {
        try {
          const saved = localStorage.getItem('infinityLoopProgress');
          if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.completedChapters) progressData.completedChapters = new Set(parsed.completedChapters);
            if (parsed.chapterProgress) progressData.chapterProgress = parsed.chapterProgress;
            if (parsed.visitedChapters) progressData.visitedChapters = new Set(parsed.visitedChapters);
            if (parsed.bookmarks) progressData.bookmarks = parsed.bookmarks;
          }
        } catch (e) {
          console.error('Error loading progress:', e);
        }
      }

      function saveProgress(showIndicator = false) {
        try {
          const dataToSave = {
            completedChapters: Array.from(progressData.completedChapters),
            chapterProgress: progressData.chapterProgress,
            visitedChapters: Array.from(progressData.visitedChapters),
            bookmarks: progressData.bookmarks
          };
          localStorage.setItem('infinityLoopProgress', JSON.stringify(dataToSave));
          
          if (showIndicator) {
            showProgressIndicator();
          }
        } catch (e) {
          console.error('Error saving progress:', e);
        }
      }

      function showProgressIndicator() {
        progressIndicator.classList.add('active');
        setTimeout(() => {
          progressIndicator.classList.remove('active');
        }, 2000);
      }

      function updateOverallProgress() {
        const maxChapters = licenseManager.hasActiveLicense() ? 11 : CONFIG.TRIAL_CHAPTERS;
        const completedCount = Math.min(progressData.completedChapters.size, maxChapters);
        const percent = Math.round((completedCount / maxChapters) * 100);
        
        overallFill.style.width = percent + '%';
        overallLabel.textContent = `${completedCount} / ${maxChapters}`;
      }

      function updateChapterProgress(progress) {
        const validProgress = Math.max(0, Math.min(100, progress));
        
        progressData.chapterProgress[currentChapter] = validProgress;
        
        if (validProgress >= 90 && !progressData.completedChapters.has(currentChapter)) {
          progressData.completedChapters.add(currentChapter);
        }
        
        saveProgress(true);
        chapterFill.style.width = validProgress + '%';
        chapterLabel.textContent = validProgress + '%';
        
        progressCircle.style.background = `conic-gradient(var(--accent) 0% ${validProgress}%, transparent ${validProgress}% 100%)`;
        progressCircle.querySelector('span').textContent = `${validProgress}%`;
        
        updateOverallProgress();
      }

      // ========== NAVIGATION SYSTEM ==========
      function loadNavigation() {
        // Load Front Matter
        frontMatterList.innerHTML = '';
        BOOK_STRUCTURE.frontMatter.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'nav-item';
          
          const button = document.createElement('button');
          button.className = 'nav-link';
          button.setAttribute('data-file', item.file);
          button.setAttribute('data-label', item.label);
          button.setAttribute('data-section', 'front');
          
          button.innerHTML = `<span>${item.label}</span>`;
          
          button.addEventListener('click', () => {
            openSection(item.file, item.label, 0);
          });
          
          li.appendChild(button);
          frontMatterList.appendChild(li);
        });

        // Load Chapters
        chapterList.innerHTML = '';
        BOOK_STRUCTURE.chapters.forEach((chapter, index) => {
          const chapterNumber = index + 1;
          const canAccess = licenseManager.canAccessChapter(chapterNumber);
          const isCompleted = progressData.completedChapters.has(chapterNumber);
          
          const li = document.createElement('li');
          li.className = 'nav-item';
          
          const button = document.createElement('button');
          button.className = 'nav-link';
          button.setAttribute('data-file', chapter.file);
          button.setAttribute('data-label', chapter.label);
          button.setAttribute('data-section', 'chapter');
          button.setAttribute('data-chapter', chapterNumber);
          
          if (!canAccess) {
            button.setAttribute('disabled', 'true');
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
          }
          
          button.innerHTML = `
            <span>${chapter.label}</span>
            <span class="badge">${chapter.badge}</span>
            ${!canAccess ? '<span style="color: var(--accent); font-size: 9px;">(LOCKED)</span>' : ''}
            ${isCompleted ? '<span style="color: var(--accent-warm); font-size: 9px; margin-left: 4px;">âœ“</span>' : ''}
          `;
          
          button.addEventListener('click', () => {
            if (!canAccess) {
              trialLimitation.style.display = 'block';
              return;
            }
            openSection(chapter.file, chapter.label, chapterNumber);
          });
          
          li.appendChild(button);
          chapterList.appendChild(li);
        });

        // Load Back Matter
        backMatterList.innerHTML = '';
        BOOK_STRUCTURE.backMatter.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'nav-item';
          
          const button = document.createElement('button');
          button.className = 'nav-link';
          button.setAttribute('data-file', item.file);
          button.setAttribute('data-label', item.label);
          button.setAttribute('data-section', 'back');
          
          button.innerHTML = `<span>${item.label}</span>`;
          
          button.addEventListener('click', () => {
            openSection(item.file, item.label, 0);
          });
          
          li.appendChild(button);
          backMatterList.appendChild(li);
        });
        
        updateAccessUI();
      }

      function updateAccessUI() {
        const accessType = licenseManager.getAccessType();
        const email = licenseManager.getUserEmail();
        const remainingDays = licenseManager.getRemainingTrialDays();
        
        userEmailSpan.textContent = email || 'Not logged in';
        
        if (accessType === 'full') {
          licenseTypeDisplay.textContent = 'Full Version â€¢ 11/11 Chapters';
          trialBadge.style.display = 'none';
          document.getElementById('chapterLimit').textContent = '(11/11)';
          upgradeButton.style.display = 'none';
          activateBtn.textContent = 'License Active';
          document.getElementById('licenseStatus').textContent = 'Full Version';
        } else if (accessType === 'trial') {
          licenseTypeDisplay.textContent = `Trial Version â€¢ ${CONFIG.TRIAL_CHAPTERS}/11 Chapters â€¢ ${remainingDays} days left`;
          trialBadge.style.display = 'inline-block';
          document.getElementById('chapterLimit').textContent = `(${CONFIG.TRIAL_CHAPTERS}/11)`;
          upgradeButton.style.display = 'block';
          activateBtn.textContent = 'Activate License';
          document.getElementById('licenseStatus').textContent = `Trial Active â€¢ ${remainingDays} days left`;
        } else {
          licenseTypeDisplay.textContent = 'No Access';
          trialBadge.style.display = 'none';
          document.getElementById('chapterLimit').textContent = '(0/11)';
          upgradeButton.style.display = 'block';
          activateBtn.textContent = 'Get Access';
          document.getElementById('licenseStatus').textContent = 'No Access';
        }
      }

      function openSection(file, label, chapterNumber = null) {
        if (!file) return;
        
        stopScrollTracking();
        currentFile = file;
        
        loadingOverlay.style.display = 'flex';
        iframe.src = file;
        currentLabel.textContent = label;
        
        currentChapter = chapterNumber || 0;
        
        if (chapterNumber && chapterNumber > 0) {
          progressData.visitedChapters.add(chapterNumber);
        }
        
        // Update active navigation
        document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-link[data-file="${file}"]`);
        if (activeBtn) {
          activeBtn.classList.add('active');
          const section = activeBtn.closest('.nav-section');
          if (section) section.classList.remove('collapsed');
        }
        
        // Update progress display only for chapters
        if (currentChapter > 0) {
          const currentProgress = progressData.chapterProgress[currentChapter] || 0;
          updateChapterProgress(currentProgress);
        } else {
          chapterFill.style.width = '0%';
          chapterLabel.textContent = '0%';
          progressCircle.style.background = `conic-gradient(var(--accent) 0% 0%, transparent 0% 100%)`;
          progressCircle.querySelector('span').textContent = `0%`;
        }
        
        // Hide trial limitation
        trialLimitation.style.display = 'none';
        
        // Handle iframe load
        iframe.onload = () => {
          loadingOverlay.style.display = 'none';
          
          // Start tracking scroll only for chapters
          if (currentChapter > 0) {
            setTimeout(() => {
              startScrollTracking();
            }, 500);
          }
        };
        
        iframe.onerror = () => {
          loadingOverlay.style.display = 'none';
          alert(`Error loading "${label}". Please check if the file "${file}" exists.`);
        };
      }

      // ========== SCROLL TRACKING ==========
      function startScrollTracking() {
        if (scrollInterval) clearInterval(scrollInterval);
        
        scrollInterval = setInterval(() => {
          try {
            const win = iframe.contentWindow;
            if (!win) return;
            
            const doc = win.document;
            if (!doc) return;
            
            const docEl = doc.documentElement;
            const body = doc.body;
            
            const scrollTop = docEl.scrollTop || body.scrollTop || 0;
            const scrollHeight = Math.max(
              docEl.scrollHeight || 0,
              body.scrollHeight || 0,
              docEl.clientHeight || 0
            );
            const clientHeight = docEl.clientHeight || body.clientHeight || 1;
            
            const maxScroll = Math.max(scrollHeight - clientHeight, 1);
            const percentage = Math.round((scrollTop / maxScroll) * 100);
            
            if (!isNaN(percentage)) {
              updateChapterProgress(percentage);
            }
          } catch (e) {
            // Cross-origin errors
          }
        }, 1000);
      }

      function stopScrollTracking() {
        if (scrollInterval) {
          clearInterval(scrollInterval);
          scrollInterval = null;
        }
        
        // Save progress when leaving a chapter
        if (currentChapter > 0) {
          saveProgress();
        }
      }

      // ========== UI FLOW ==========
      function showEmailModal() {
        splashEntrance.style.display = 'none';
        emailModal.style.display = 'flex';
        
        setTimeout(() => {
          document.getElementById('trialEmail').focus();
        }, 100);
      }

      function hideEmailModal() {
        emailModal.style.display = 'none';
      }

      function showLicenseModal() {
        emailModal.style.display = 'none';
        licenseModal.style.display = 'flex';
        
        setTimeout(() => {
          document.getElementById('licenseInput').focus();
        }, 100);
      }

      function hideLicenseModal() {
        licenseModal.style.display = 'none';
      }

      function showApp() {
        splashEntrance.style.display = 'none';
        emailModal.style.display = 'none';
        licenseModal.style.display = 'none';
        appShell.style.display = 'flex';
        
        setTimeout(() => {
          appShell.style.opacity = '1';
        }, 10);
        
        if (isMobile) {
          sidebar.style.display = 'flex';
          menuToggle.textContent = 'âœ•';
          menuToggle.setAttribute('aria-expanded', 'true');
        }
        
        loadNavigation();
        loadProgress();
        updateOverallProgress();
        // Start with Title Page
        openSection('TITLE_PAGE.htm', 'Title Page', 0);
      }

      function startAppWithTrial(email) {
        if (!validateEmail(email)) {
          alert('Please enter a valid email address.');
          return;
        }
        
        const agreeTerms = document.getElementById('agreeTerms').checked;
        if (!agreeTerms) {
          alert('You must agree to the Terms of Service to continue.');
          return;
        }
        
        licenseManager.saveUser(email);
        licenseManager.startTrial(email);
        
        showApp();
        alert('Welcome to The Infinity Loop! You have access to the first 2 chapters for 7 days.');
      }

      function startAppWithLicense(licenseKey) {
        const email = licenseManager.getUserEmail() || 
                     prompt('Enter your email for license activation:');
        
        if (!email) {
          alert('Email is required for license activation.');
          return;
        }
        
        if (!validateEmail(email)) {
          alert('Please enter a valid email address.');
          return;
        }
        
        try {
          licenseManager.activateLicense(licenseKey, email);
          showApp();
          alert('License activated successfully! Full access granted.');
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      function checkExistingAccess() {
        const accessType = licenseManager.getAccessType();
        const email = licenseManager.getUserEmail();
        
        if (accessType === 'none' || !email) {
          // New user - show email modal
          splashEntrance.style.opacity = '0';
          splashEntrance.style.transition = 'opacity 0.5s ease';
          
          setTimeout(() => {
            splashEntrance.style.display = 'none';
            showEmailModal();
          }, 500);
        } else {
          // Returning user - go directly to app
          splashEntrance.style.opacity = '0';
          splashEntrance.style.transition = 'opacity 0.5s ease';
          
          setTimeout(() => {
            splashEntrance.style.display = 'none';
            showApp();
          }, 500);
        }
      }

      // ========== EVENT LISTENERS ==========
      function setupEventListeners() {
        // Entrance page
        enterBookBtn.addEventListener('click', () => {
          splashEntrance.style.opacity = '0';
          splashEntrance.style.transition = 'opacity 0.5s ease';
          
          setTimeout(() => {
            splashEntrance.style.display = 'none';
            checkExistingAccess();
          }, 500);
        });

        bookCover.addEventListener('click', () => {
          enterBookBtn.click();
        });

        // Email modal
        document.getElementById('startTrialWithEmail').addEventListener('click', () => {
          const email = document.getElementById('trialEmail').value.trim();
          startAppWithTrial(email);
        });

        document.getElementById('trialEmail').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const email = document.getElementById('trialEmail').value.trim();
            startAppWithTrial(email);
          }
        });

        document.getElementById('switchToLicense').addEventListener('click', (e) => {
          e.preventDefault();
          showLicenseModal();
        });

        document.getElementById('termsLink').addEventListener('click', (e) => {
          e.preventDefault();
          alert('Terms of Service:\n\n1. Trial lasts 7 days\n2. Email required for trial\n3. No spam, unsubscribe anytime\n4. Full version requires purchase');
        });

        // License modal
        document.getElementById('activateLicense').addEventListener('click', () => {
          const licenseKey = document.getElementById('licenseInput').value.trim().toUpperCase();
          startAppWithLicense(licenseKey);
        });

        document.getElementById('licenseInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const licenseKey = document.getElementById('licenseInput').value.trim().toUpperCase();
            startAppWithLicense(licenseKey);
          }
        });

        document.getElementById('purchaseLicense').addEventListener('click', (e) => {
          e.preventDefault();
          const confirmed = confirm('You will be redirected to our secure purchase page. Continue?');
          if (confirmed) {
            window.open(CONFIG.PURCHASE_URL, '_blank');
          }
        });

        document.getElementById('licenseAgreementLink').addEventListener('click', (e) => {
          e.preventDefault();
          alert('License Agreement:\n\n1. License grants access to all chapters\n2. One license per device\n3. Non-transferable\n4. Updates included for 1 year');
        });

        // Upgrade buttons
        upgradeButton.addEventListener('click', showLicenseModal);
        document.getElementById('upgradeNow').addEventListener('click', showLicenseModal);
        activateBtn.addEventListener('click', showLicenseModal);

        // Menu toggle
        menuToggle.addEventListener('click', () => {
          if (isMobile) {
            sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
          }
        });

        // Bookmark button
        document.getElementById('bookmark-btn').addEventListener('click', () => {
          if (currentChapter > 0) {
            const progress = progressData.chapterProgress[currentChapter] || 0;
            progressData.bookmarks[currentChapter] = {
              timestamp: new Date().toISOString(),
              progress: progress,
              file: currentFile,
              label: currentLabel.textContent
            };
            saveProgress(true);
            
            alert(`Bookmark saved for ${currentLabel.textContent} (${progress}% complete)`);
          } else {
            alert('Bookmark saved for ' + currentLabel.textContent);
          }
        });

        // Reset progress
        document.getElementById('progress-reset').addEventListener('click', () => {
          if (confirm('Are you sure you want to reset all reading progress? This cannot be undone.')) {
            progressData.completedChapters.clear();
            progressData.chapterProgress = {};
            progressData.visitedChapters.clear();
            progressData.bookmarks = {};
            saveProgress();
            updateOverallProgress();
            if (currentChapter > 0) {
              updateChapterProgress(0);
            }
            alert('All progress has been reset.');
          }
        });

        // Navigation section toggles
        document.querySelectorAll('.nav-section-title').forEach(title => {
          title.addEventListener('click', (e) => {
            const section = e.target.closest('.nav-section');
            section.classList.toggle('collapsed');
          });
        });

        // Window events
        window.addEventListener('resize', () => {
          isMobile = window.innerWidth <= 768;
        });

        window.addEventListener('beforeunload', () => {
          stopScrollTracking();
          saveProgress();
        });

        // Auto-save progress periodically
        setInterval(() => {
          if (currentChapter > 0) {
            saveProgress();
          }
        }, 30000); // Auto-save every 30 seconds
      }

      // ========== HELPER FUNCTIONS ==========
      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      // ========== INITIALIZATION ==========
      function init() {
        setupEventListeners();
        
        // Show entrance splash page
        splashEntrance.style.display = 'flex';
        
        // For development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('Development mode. Test license:', CONFIG.TEST_LICENSE);
          document.getElementById('licenseInput').placeholder = CONFIG.TEST_LICENSE;
        }
      }

      // Start application
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // Expose some functions for debugging
      window.debugProgress = {
        getProgress: () => progressData,
        resetProgress: () => {
          localStorage.removeItem('infinityLoopProgress');
          location.reload();
        },
        getLicense: () => licenseManager
      };

    })();
  </script>
</body>
</html>